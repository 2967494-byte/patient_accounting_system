{% extends "reports_base.html" %}

{% block report_content %}
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 2rem;">
    <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">Активность организаций</h2>
    <div style="display: flex; gap: 0.5rem;">
        <select id="org-month" onchange="fetchOrgReport()"
            style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.9rem; background-color: white;">
            <option value="01">Январь</option>
            <option value="02">Февраль</option>
            <option value="03">Март</option>
            <option value="04">Апрель</option>
            <option value="05">Май</option>
            <option value="06">Июнь</option>
            <option value="07">Июль</option>
            <option value="08">Август</option>
            <option value="09">Сентябрь</option>
            <option value="10">Октябрь</option>
            <option value="11">Ноябрь</option>
            <option value="12">Декабрь</option>
        </select>
        <select id="org-year" onchange="fetchOrgReport()"
            style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.9rem; background-color: white;">
            <!-- Filled via JS -->
        </select>
    </div>
</div>

<div class="report-card"
    style="background: white; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">

    <div id="org-report-loading" style="color:#6b7280; font-size:0.9rem;">Загрузка...</div>
    <div style="max-height: 600px; overflow-y: auto;">
        <table id="org-report-table" style="width:100%; border-collapse: collapse; font-size: 0.9rem; display:none;">
            <thead>
                <tr style="border-bottom: 2px solid #f3f4f6; text-align: left;">
                    <th id="total-users-th" style="padding: 0.5rem; color: #6b7280;">Пользователь</th>
                    <th id="total-records-th" style="padding: 0.5rem; color: #6b7280; text-align: right;">Записей</th>
                    <th style="padding: 0.5rem; color: #6b7280; text-align: right; width: 50px;"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Details Modal -->
<div id="org-details-modal" class="modal"
    style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center;">
    <div
        style="background-color: #fefefe; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 id="modal-title" style="margin: 0; font-size: 1.25rem; font-weight: 700;">Детали записей: <span
                    id="org-username" style="color: #4f46e5;"></span></h3>
            <button onclick="closeOrgModal()"
                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">&times;</button>
        </div>

        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
            <thead>
                <tr style="border-bottom: 2px solid #f3f4f6; text-align: left;">
                    <th style="padding: 0.5rem; color: #6b7280; width: 40px;">п.п</th>
                    <th style="padding: 0.5rem; color: #6b7280;">Пациент</th>
                    <th style="padding: 0.5rem; color: #6b7280;">Центр</th>
                    <th style="padding: 0.5rem; color: #6b7280;">Дата</th>
                    <th style="padding: 0.5rem; color: #6b7280;">Время</th>
                    <th style="padding: 0.5rem; color: #6b7280; text-align: center; width: 80px;">Снимок</th>
                </tr>
            </thead>
            <tbody id="org-details-tbody"></tbody>
        </table>
    </div>
</div>

<script>
    async function fetchOrgReport() {
        const month = document.getElementById('org-month').value;
        const year = document.getElementById('org-year').value;
        const loading = document.getElementById('org-report-loading');
        const table = document.getElementById('org-report-table');
        const tbody = table.querySelector('tbody');

        if (!year) return;

        loading.style.display = 'block';
        table.style.display = 'none';

        try {
            const res = await fetch(`/admin/reports/api/organizations?month=${year}-${month}`);
            const data = await res.json();

            loading.style.display = 'none';
            table.style.display = 'table';

            // Calculate Totals
            const totalUsers = data.length;
            const totalRecords = data.reduce((sum, item) => sum + (item.count || 0), 0);

            document.getElementById('total-users-th').innerHTML = `Пользователь <span style="color:#374151; font-weight:600;">(Всего: ${totalUsers})</span>`;
            document.getElementById('total-records-th').innerHTML = `Записей <span style="color:#374151; font-weight:600;">(Всего: ${totalRecords})</span>`;

            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="padding:1rem; text-align:center; color:#9ca3af;">Нет данных за выбранный месяц</td></tr>';
            } else {
                data.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="padding: 0.5rem; border-bottom: 1px solid #f9fafb;">${item.username || 'Unknown'}</td>
                        <td style="padding: 0.5rem; border-bottom: 1px solid #f9fafb; text-align: right; font-weight:600;">${item.count}</td>
                        <td style="padding: 0.5rem; border-bottom: 1px solid #f9fafb; text-align: right;">
                            <button onclick="showOrgDetails(${item.id}, '${item.username}')" style="background:none; border:none; color:#4f46e5; cursor:pointer; font-size:1.1rem;" title="Подробнее">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        } catch (e) { console.error('Org fetch err', e); }
    }

    async function showOrgDetails(userId, username) {
        const month = document.getElementById('org-month').value;
        const year = document.getElementById('org-year').value;
        const modal = document.getElementById('org-details-modal');
        const tbody = document.getElementById('org-details-tbody');
        document.getElementById('org-username').textContent = username;

        tbody.innerHTML = '<tr><td colspan="5" style="padding: 1rem; text-align:center;">Загрузка...</td></tr>';
        modal.style.display = 'flex';

        try {
            const res = await fetch(`/admin/reports/api/organizations/details?user_id=${userId}&month=${year}-${month}`);
            const details = await res.json();

            tbody.innerHTML = '';
            if (details.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 1rem; text-align:center; color:#9ca3af;">Записи не найдены</td></tr>';
            } else {
                details.forEach(appt => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #f9fafb';
                    tr.innerHTML = `
                        <td style="padding: 0.5rem; color: #6b7280;">${appt.n_pp}</td>
                        <td style="padding: 0.5rem; font-weight: 500;">${appt.patient_name}</td>
                        <td style="padding: 0.5rem;">${appt.center_name}</td>
                        <td style="padding: 0.5rem;">${appt.date}</td>
                        <td style="padding: 0.5rem;">${appt.time}</td>
                        <td style="padding: 0.5rem; text-align: center;">
                            ${appt.is_registered ? '<span style="color: #16a34a; font-size: 1.2rem;">✓</span>' : '<span style="color: #d1d5db;">-</span>'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        } catch (e) {
            console.error('Details fetch err', e);
            tbody.innerHTML = '<tr><td colspan="5" style="padding: 1rem; text-align:center; color:#dc2626;">Ошибка загрузки данных</td></tr>';
        }
    }

    function closeOrgModal() {
        document.getElementById('org-details-modal').style.display = 'none';
    }

    // Close on outside click
    window.onclick = function (event) {
        const modal = document.getElementById('org-details-modal');
        if (event.target == modal) {
            closeOrgModal();
        }
    }

    document.addEventListener('DOMContentLoaded', async function () {
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = String(today.getMonth() + 1).padStart(2, '0');

        // Populate Years (Current +/- 5)
        const yearSelect = document.getElementById('org-year');
        for (let y = currentYear - 5; y <= currentYear + 2; y++) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            if (y === currentYear) opt.selected = true;
            yearSelect.appendChild(opt);
        }

        // Set Month
        document.getElementById('org-month').value = currentMonth;

        fetchOrgReport();
    });
</script>
{% endblock %}