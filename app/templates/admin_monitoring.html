{% extends "admin_base.html" %}

{% block content %}

<div class="admin-header">
    <h2>–°–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</h2>
    <div class="header-actions">
        <button onclick="sendTestMessage()" class="btn btn-primary">–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram</button>
    </div>
</div>

<div class="dashboard-grid">
    <!-- Status Cards -->
    <div class="card status-card">
        <h3>–°–∏—Å—Ç–µ–º–∞</h3>
        <div class="status-indicator online">
            <span class="status-dot"></span> Online
        </div>
    </div>

    <div class="card status-card">
        <h3>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
        <div class="status-indicator {% if db_status %}online{% else %}offline{% endif %}">
            <span class="status-dot"></span> {{ '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' if db_status else '–û—à–∏–±–∫–∞' }}
        </div>
    </div>

    <div class="card status-card">
        <h3>Telegram –ë–æ—Ç</h3>
        <div class="status-indicator {% if bot_configured %}online{% else %}warning{% endif %}">
            <span class="status-dot"></span> {{ '–ù–∞—Å—Ç—Ä–æ–µ–Ω' if bot_configured else '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω' }}
        </div>
    </div>
</div>

<div class="resources-grid"
    style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
    <!-- CPU -->
    <div class="card resource-card">
        <h3>CPU</h3>
        <div class="progress-container">
            <div class="progress-bar"
                style="width: {{ cpu_percent }}%; background-color: {% if cpu_percent > 80 %}#ef4444{% elif cpu_percent > 50 %}#f59e0b{% else %}#10b981{% endif %};">
            </div>
        </div>
        <div class="resource-stats">
            <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: {{ cpu_percent }}%</span>
        </div>
    </div>

    <!-- RAM -->
    <div class="card resource-card">
        <h3>RAM</h3>
        <div class="progress-container">
            <div class="progress-bar"
                style="width: {{ ram_percent }}%; background-color: {% if ram_percent > 80 %}#ef4444{% elif ram_percent > 50 %}#f59e0b{% else %}#10b981{% endif %};">
            </div>
        </div>
        <div class="resource-stats">
            <span>–í—Å–µ–≥–æ: {{ ram_total_gb }} GB</span>
            <span>–ó–∞–Ω—è—Ç–æ: {{ ram_used_gb }} GB ({{ ram_percent }}%)</span>
        </div>
    </div>

    <!-- Disk -->
    <div class="card resource-card">
        <h3>–î–∏—Å–∫ (/)</h3>
        <div class="progress-container">
            <div class="progress-bar"
                style="width: {{ disk_percent }}%; background-color: {% if disk_percent > 80 %}#ef4444{% elif disk_percent > 50 %}#f59e0b{% else %}#10b981{% endif %};">
            </div>
        </div>
        <div class="resource-stats">
            <span>–í—Å–µ–≥–æ: {{ disk_total_gb }} GB</span>
            <span>–°–≤–æ–±–æ–¥–Ω–æ: {{ disk_free_gb }} GB</span>
            <span>–ó–∞–Ω—è—Ç–æ: {{ disk_percent }}%</span>
        </div>
    </div>
</div>
</div>

<!-- Disk Usage Graph -->
<div style="margin-top: 2rem;">
    <div class="card">
        <h3 style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
            <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ (7 –¥–Ω–µ–π)</span>
            <button onclick="refreshMetrics()" class="btn"
                style="background: #3b82f6; color: white; font-size: 0.875rem; padding: 0.5rem 1rem;">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </h3>
        <canvas id="diskUsageChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<!-- System Statistics -->
<div class="stats-grid"
    style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
    <div class="card stat-card">
        <div class="stat-icon"
            style="background: #dbeafe; color: #1e40af; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem;">
            üë•
        </div>
        <div class="stat-label" style="color: #6b7280; font-size: 0.875rem;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: #111827;">{{ stats.users_count }}</div>
    </div>

    <div class="card stat-card">
        <div class="stat-icon"
            style="background: #dcfce7; color: #15803d; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem;">
            üìÖ
        </div>
        <div class="stat-label" style="color: #6b7280; font-size: 0.875rem;">–ó–∞–ø–∏—Å–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ</div>
        <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: #111827;">{{ stats.appointments_count
            }}</div>
    </div>

    <div class="card stat-card">
        <div class="stat-icon"
            style="background: #fef3c7; color: #92400e; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem;">
            üìã
        </div>
        <div class="stat-label" style="color: #6b7280; font-size: 0.875rem;">–ó–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª–µ</div>
        <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: #111827;">{{
            stats.journal_entries_count }}</div>
    </div>

    <div class="card stat-card">
        <div class="stat-icon"
            style="background: #fce7f3; color: #9f1239; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem;">
            üë®‚Äç‚öïÔ∏è
        </div>
        <div class="stat-label" style="color: #6b7280; font-size: 0.875rem;">–í—Ä–∞—á–∏</div>
        <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: #111827;">{{ stats.doctors_count }}
        </div>
    </div>

    <div class="card stat-card">
        <div class="stat-icon"
            style="background: #e0e7ff; color: #3730a3; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem;">
            üè•
        </div>
        <div class="stat-label" style="color: #6b7280; font-size: 0.875rem;">–ö–ª–∏–Ω–∏–∫–∏</div>
        <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: #111827;">{{ stats.clinics_count }}
        </div>
    </div>

    <div class="card stat-card">
        <div class="stat-icon"
            style="background: #f5d0fe; color: #701a75; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem;">
            üè¢
        </div>
        <div class="stat-label" style="color: #6b7280; font-size: 0.875rem;">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</div>
        <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: #111827;">{{ stats.organizations_count
            }}</div>
    </div>
</div>

<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .card {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        margin-top: 0.5rem;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .online .status-dot {
        background-color: #10b981;
    }

    .status-indicator.online {
        color: #065f46;
    }

    .offline .status-dot {
        background-color: #ef4444;
    }

    .status-indicator.offline {
        color: #991b1b;
    }

    .warning .status-dot {
        background-color: #f59e0b;
    }

    .status-indicator.warning {
        color: #92400e;
    }

    .progress-container {
        height: 1.5rem;
        background-color: #e5e7eb;
        border-radius: 9999px;
        overflow: hidden;
        margin: 1rem 0;
    }

    .progress-bar {
        height: 100%;
        transition: width 0.5s ease;
    }

    .resource-stats {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
        color: #6b7280;
    }
</style>

<script>
    async function sendTestMessage() {
        if (!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;

        try {
            const response = await fetch('{{ url_for("admin.test_telegram_message") }}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            });

            const data = await response.json();
            if (data.success) {
                alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
            } else {
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏.');
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        }
    }

    async function refreshMetrics() {
        try {
            const response = await fetch('{{ url_for("admin.monitoring_refresh") }}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            });

            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫');
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        }
    }
</script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    // Disk Usage Chart
    const ctx = document.getElementById('diskUsageChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ graph_data.labels | tojson }},
        datasets: [{
            label: '–ó–∞–Ω—è—Ç–æ (GB)',
            data: {{ graph_data.disk_used | tojson }},
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        tension: 0.4,
        fill: true
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            },
            tooltip: {
                callbacks: {
                    label: function (context) {
                        return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' GB';
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: '–ì–∏–≥–∞–±–∞–π—Ç—ã (GB)'
                }
            },
            x: {
                title: {
                    display: true,
                    text: '–î–∞—Ç–∞'
                }
            }
        }
    }
    });
</script>
{% endblock %}