{% extends "app_base.html" %}

{% block content %}
<main class="calendar-container" style="border: 2px solid var(--theme-color, #e5e7eb);"
    data-start-date="{{ dates[0].iso_date if dates else '' }}"
    data-end-date="{{ dates[-1].iso_date if dates else '' }}">
    <div class="calendar-header">
        <div class="time-header-spacer"></div> <!-- Spacer for time column -->
        <div class="nav-button prev-week nav-button-wrapper">
            <a href="{{ url_for('main.dashboard', start_date=prev_week, center_id=current_center_id) }}"
                class="nav-arrow">&larr;</a>
        </div>
        {% for date in dates %}
        <div class="day-header {{ 'today-current' if date.iso_date == today_iso else '' }}">
            <div class="day-name">{{ date.name }}</div>
            <div class="day-date">{{ date.display_date }}</div>
        </div>
        {% endfor %}
        <div class="nav-button next-week nav-button-wrapper">
            <a href="{{ url_for('main.dashboard', start_date=next_week, center_id=current_center_id) }}"
                class="nav-arrow">&rarr;</a>
        </div>
        <div class="time-header-spacer"></div> <!-- Spacer for right time column -->
    </div>



    <div class="calendar-grid">
        <!-- Time column -->
        <div class="time-column">
            {% for time in time_slots %}
            <div class="time-slot-label {{ 'time-current' if time == current_time_slot else '' }}">
                {{ time }}
            </div>
            {% endfor %}
        </div>

        <!-- Days columns -->
        {% for date in dates %}
        <div class="day-column {{ 'today-current' if date.iso_date == today_iso else '' }}">
            {% for time in time_slots %}
            {% set is_special = (current_user.role in ['admin', 'lab_tech']) and (time.endswith(':15') or
            time.endswith(':45')) %}
            {% set is_weekend_restricted_base = (date.obj.weekday() >= 5) %}
            {% set is_org = current_user.role == 'org' %}
            {% set is_weekend_restricted = is_weekend_restricted_base and (
            (is_org and time < "09:15" ) or (not is_org and time < "09:00" ) or time> "17:45"
                ) %}
                <div class="time-slot-cell {{ 'special-slot' if is_special else '' }} {{ 'weekend-restricted' if is_weekend_restricted else '' }} {{ 'time-current' if time == current_time_slot else '' }}"
                    data-date="{{ date.iso_date }}" data-time="{{ time }}">
                </div>
                {% endfor %}
        </div>
        {% endfor %}

        <!-- Time column (Right) -->
        <div class="time-column" style="border-right: none; border-left: 1px solid var(--border-color);">
            {% for time in time_slots %}
            <div class="time-slot-label {{ 'time-current' if time == current_time_slot else '' }}">
                {{ time }}
            </div>
            {% endfor %}
        </div>

    </div>

    <!-- Static Legend Trigger -->
    <div class="legend-popover-wrapper grid-legend">
        <div class="legend-trigger-btn" title="Легенда статусов">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
        </div>
        <div class="legend-popover">
            <div class="legend-popover-title">Статусы записей</div>
            {% if current_user.role in ['org', 'doctor'] %}
            <!-- Legend for org users -->
            <div class="legend-popover-item"><span class="legend-dot status-org"></span> Записан
            </div>
            <div class="legend-popover-item"><span class="legend-dot status-completed"></span> Выполнено
            </div>
            <div class="legend-popover-item"><span class="legend-dot status-late"></span> Опаздывает/не пришел
            </div>
            <div class="legend-popover-item"><span class="legend-dot status-restricted"></span> Занято</div>
            {% else %}
            <!-- Legend for regular users -->
            <div class="legend-popover-item"><span class="legend-dot status-pending"></span> Записан
            </div>
            <div class="legend-popover-item"><span class="legend-dot status-org"></span> Стоматология
            </div>
            <div class="legend-popover-item"><span class="legend-dot status-completed"></span> Выполнено
            </div>
            <div class="legend-popover-item"><span class="legend-dot status-late"></span> Опаздывает/не пришел
            </div>
            {% endif %}
        </div>
    </div>
</main>



<!-- Appointment Modal -->
{% include 'partials/appointment_modal.html' %}
{% endblock %}

<script>
    const initialAppointments = {{ initial_appointments | safe }} || [];
    const currentCenterId = {{ current_center_id | tojson }};
    window.initialAppointments = initialAppointments;
    window.currentCenterId = currentCenterId;
</script>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const phoneInput = document.getElementById('patient-phone');

        phoneInput.addEventListener('input', function (e) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,1})(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
            if (!x[2]) {
                e.target.value = x[1] ? '+7' : '';
            } else {
                e.target.value = '+7 (' + x[2] + (x[3] ? ') ' + x[3] : '') + (x[4] ? ' - ' + x[4] : '') + (x[5] ? ' - ' + x[5] : '');
            }
        });

        // Initialize if empty but focused (optional, maybe not needed if placeholder is there)
    });
</script>
{% endblock %}