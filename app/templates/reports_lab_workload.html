{% extends "reports_base.html" %}

{% block report_content %}
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 2rem;">
    <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">Загруженность лаборантов</h2>
    <div style="display: flex; gap: 0.5rem;">
        <select id="lab-day" onchange="fetchLabReport()"
            style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.9rem; background-color: white;">
            <option value="00">Весь месяц</option>
            <!-- Filled via JS -->
        </select>
        <select id="lab-month" onchange="fetchLabReport()"
            style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.9rem; background-color: white;">
            <option value="01">Январь</option>
            <option value="02">Февраль</option>
            <option value="03">Март</option>
            <option value="04">Апрель</option>
            <option value="05">Май</option>
            <option value="06">Июнь</option>
            <option value="07">Июль</option>
            <option value="08">Август</option>
            <option value="09">Сентябрь</option>
            <option value="10">Октябрь</option>
            <option value="11">Ноябрь</option>
            <option value="12">Декабрь</option>
        </select>
        <select id="lab-year" onchange="fetchLabReport()"
            style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.9rem; background-color: white;">
            <!-- Filled via JS -->
        </select>
    </div>
</div>

<div class="report-card"
    style="background: white; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">

    <div id="lab-report-loading" style="color:#6b7280; font-size:0.9rem;">Загрузка...</div>
    <div style="max-height: 600px; overflow-y: auto;">
        <table id="lab-report-table" style="width:100%; border-collapse: collapse; font-size: 0.9rem; display:none;">
            <thead>
                <tr style="border-bottom: 2px solid #f3f4f6; text-align: left;">
                    <th style="padding: 0.5rem; color: #6b7280;">Лаборант</th>
                    <th style="padding: 0.5rem; color: #6b7280; text-align: right;">Пац.</th>
                    <th style="padding: 0.5rem; color: #6b7280; text-align: right;">Выручка</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    async function fetchLabReport() {
        const day = document.getElementById('lab-day').value;
        const month = document.getElementById('lab-month').value;
        const year = document.getElementById('lab-year').value;
        const loading = document.getElementById('lab-report-loading');
        const table = document.getElementById('lab-report-table');
        const tbody = table.querySelector('tbody');

        if (!year) return;

        loading.style.display = 'block';
        table.style.display = 'none';

        try {
            const res = await fetch(`/admin/reports/api/lab_techs?year=${year}&month=${month}&day=${day}`);
            const data = await res.json();

            loading.style.display = 'none';
            table.style.display = 'table';

            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="padding:1rem; text-align:center; color:#9ca3af;">Нет данных за выбранный период</td></tr>';
            } else {
                data.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td style="padding: 0.5rem; border-bottom: 1px solid #f9fafb;">${item.username || 'Unknown'}</td>
                    <td style="padding: 0.5rem; border-bottom: 1px solid #f9fafb; text-align: right;">${item.unique_patients}</td>
                    <td style="padding: 0.5rem; border-bottom: 1px solid #f9fafb; text-align: right; font-weight:600;">${item.total_revenue.toFixed(2)}</td>
                `;
                    tbody.appendChild(tr);
                });
            }
        } catch (e) { console.error('Lab fetch err', e); }
    }

    document.addEventListener('DOMContentLoaded', async function () {
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = String(today.getMonth() + 1).padStart(2, '0');
        const currentDay = String(today.getDate()).padStart(2, '0');

        // Populate Years (Current +/- 5)
        const yearSelect = document.getElementById('lab-year');
        for (let y = currentYear - 5; y <= currentYear + 2; y++) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            if (y === currentYear) opt.selected = true;
            yearSelect.appendChild(opt);
        }

        // Set Month
        document.getElementById('lab-month').value = currentMonth;

        // Populate Days (1-31)
        const daySelect = document.getElementById('lab-day');
        for (let d = 1; d <= 31; d++) {
            const val = String(d).padStart(2, '0');
            const opt = document.createElement('option');
            opt.value = val;
            opt.textContent = val;
            daySelect.appendChild(opt);
        }
        // Default to "All Month" (00) initially? Or today?
        // User asked for choice. Let's default to "All Month" for a broader view, or today? 
        // Usually reports start with "Month view". So keep 00 selected (default).
        // The HTML has <option value="00">Весь месяц</option> first, so it's selected.

        fetchLabReport();
    });
</script>
{% endblock %}