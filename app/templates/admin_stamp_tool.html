{% extends "app_base.html" %}

{% block center_nav %}{% endblock %}

{% block scripts %}
<script>
    // currentCenterId is already defined in app_base.html
    // Removed currentCenterId as it's global
    let selectedAppointments = new Set();
    let searchTimeout = null;

    // Load year
    document.getElementById('filter-year').value = new Date().getFullYear();

    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(runSearch, 500);
    }

    function clearSearchInput() {
        document.getElementById('patient-search-input').value = '';
        runSearch();
    }

    async function runSearch() {
        const year = document.getElementById('filter-year').value;
        const query = document.getElementById('patient-search-input').value;

        // Show clear btn if query exists
        // document.querySelector('.btn-clear').style.display = query ? 'block' : 'none';

        if (query.length < 2) {
            document.getElementById('search-results-container').style.display = 'none';
            return;
        }

        try {
            const res = await fetch(`{{ url_for('main.get_patients_for_certificate') }}?year=${year}&query=${encodeURIComponent(query)}`);
            const data = await res.json();

            if (data.success) {
                renderResults(data.appointments);
            }
        } catch (e) { console.error(e); }
    }

    function renderResults(appointments) {
        const container = document.getElementById('search-results-container');
        const tbody = document.getElementById('results-tbody');
        tbody.innerHTML = '';

        if (appointments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="padding:10px; text-align:center;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>';
            container.style.display = 'block';
            return;
        }

        appointments.forEach(appt => {
            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid #f3f4f6';

            const isChecked = selectedAppointments.has(appt.id);

            tr.innerHTML = `
                <td style="padding: 8px;"><input type="checkbox" class="appt-checkbox" value="${appt.id}" data-cost="${appt.cost}" data-name="${appt.patient_name}" data-date="${appt.date}" ${isChecked ? 'checked' : ''} onchange="updateTotal()"></td>
                <td style="padding: 8px;">${appt.date}</td>
                <td style="padding: 8px;">${appt.patient_name}</td>
                <td style="padding: 8px; font-size: 0.8em; color: #4b5563;">${appt.center_name}</td>
                <td style="padding: 8px; font-size: 0.8em; color: #6b7280;">${appt.service}</td>
                <td style="padding: 8px; text-align: right; font-weight: 600;">${appt.cost} ‚ÇΩ</td>
            `;
            tbody.appendChild(tr);
        });

        container.style.display = 'block';
    }

    function updatePayerDisabled() {
        // Logic is in togglePayerFields
        togglePayerFields();
    }

    function toggleAll(source) {
        const checkboxes = document.querySelectorAll('.appt-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = source.checked;
        });
        updateTotal();
    }

    function updateTotal() {
        const checkboxes = document.querySelectorAll('.appt-checkbox:checked');
        let total = 0;
        selectedAppointments.clear();

        // Also capture the FIRST selected patient name to pre-fill the name field?
        // Or user selects multiple different patients? (Hope not)
        // Assuming search query filtered specific person.

        checkboxes.forEach(cb => {
            total += parseFloat(cb.dataset.cost || 0);
            selectedAppointments.add(parseInt(cb.value));
        });

        document.getElementById('total-amount').textContent = total.toFixed(2) + ' ‚ÇΩ';
        document.getElementById('selection-summary').style.display = total > 0 ? 'block' : 'none';

        // Auto-fill patient name/fields from first selection if empty? 
        // Logic: if we have selection, we can assume patient data from the first checked item.
        if (checkboxes.length > 0) {
            // Find first
            const firstId = checkboxes[0].value;
            // We can pass this ID as main appointment ID for data pre-fill
        }
    }

    function togglePayerFields() {
        const type = document.getElementById('form-select').value;
        const payerBlock = document.getElementById('payer-block');
        const payerInputs = payerBlock.querySelectorAll('input');

        if (type === 'knd1151156_op') {
            // Enable
            payerBlock.classList.remove('block-disabled');
            payerInputs.forEach(inp => inp.disabled = false);
        } else {
            // Disable
            payerBlock.classList.add('block-disabled');
            payerInputs.forEach(inp => inp.disabled = true);
        }
    }

    function openEditor() {
        const checkboxes = document.querySelectorAll('.appt-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–ø–∏—Å—å!');
            return;
        }

        // Use the ID of the MOST RECENT appointment as the base (for details like phone, etc if needed)
        // Or just use the first/last one.
        // Let's sort by date? The backend sent them sorted. 
        // We'll trust the first one in the list (or last) is fine, but visually in table top is most recent?
        // Table renders order from backend (desc). So first row is newest.

        const mainApptId = checkboxes[0].value; // Newest selected

        // Calculate total
        let total = 0;
        checkboxes.forEach(cb => total += parseFloat(cb.dataset.cost || 0));

        const inn = document.getElementById('inn').value;
        const b_date = document.getElementById('birth-date').value;
        const series = document.getElementById('doc-series').value;
        const number = document.getElementById('doc-number').value;
        const issue_date = document.getElementById('doc-issue-date').value;
        const formType = document.getElementById('form-select').value;

        const params = new URLSearchParams({
            inn: inn,
            b_date: b_date,
            series: series,
            number: number,
            issue_date: issue_date,
            form_type: formType,
            total_amount: total, // PASS TOTAL
            // Payer data
            payer_fio: document.getElementById('payer-fio').value,
            payer_inn: document.getElementById('payer-inn').value,
            payer_b_date: document.getElementById('payer-birth-date').value,
            payer_series: document.getElementById('payer-doc-series').value,
            payer_number: document.getElementById('payer-doc-number').value,
            payer_issue_date: document.getElementById('payer-doc-issue-date').value
        });

        // Pass IDs of all selected for reference?
        params.append('appt_ids', Array.from(selectedAppointments).join(','));

        window.location.href = `/stamp-tool/certificate/edit/${mainApptId}?${params.toString()}`;
    }

    async function loadCertificates() {
        try {
            const response = await fetch('{{ url_for("main.list_certificates") }}');
            const data = await response.json();

            if (data.success) {
                const tbody = document.getElementById('certificates-list');
                tbody.innerHTML = '';
                const certs = data.certificates;

                if (certs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding:10px; text-align:center; color:#9ca3af;">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–ø—Ä–∞–≤–æ–∫</td></tr>';
                    return;
                }

                certs.forEach(cert => {
                    const tr = document.createElement('tr');

                    const dateObj = new Date(cert.generated_at);
                    const dateStr = dateObj.toLocaleDateString('ru-RU');
                    const timeStr = dateObj.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

                    const deleteDate = new Date(dateObj);
                    deleteDate.setDate(deleteDate.getDate() + 30);
                    const now = new Date();
                    const diffTime = deleteDate - now;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    let daysClass = 'cell-days';
                    let daysText = diffDays + ' –¥–Ω.';
                    if (diffDays < 0) { daysText = '–£–¥–∞–ª–µ–Ω–æ'; daysClass += ' danger'; }
                    else if (diffDays < 5) { daysClass += ' warning'; }

                    const delBtn = `<button class="btn-delete-cert" onclick="deleteCert(${cert.id})">üóëÔ∏è</button>`;

                    // Handle multi-page icons
                    let downloadBtns = '';
                    const filenames = (cert.filename || '').split('|');
                    if (filenames.length > 1) {
                        downloadBtns = `
                            <a href="/stamp-tool/certificate/${cert.id}/download?page=0" target="_blank" title="–°–∫–∞—á–∞—Ç—å —Å—Ç—Ä. 1" style="font-size: 1.2rem; margin-right: 5px; color: #10b981;">üì•<span style="font-size: 0.6rem; vertical-align: super; font-weight: bold;">1</span></a>
                            <a href="/stamp-tool/certificate/${cert.id}/download?page=1" target="_blank" title="–°–∫–∞—á–∞—Ç—å —Å—Ç—Ä. 2" style="font-size: 1.2rem; color: #10b981;">üì•<span style="font-size: 0.6rem; vertical-align: super; font-weight: bold;">2</span></a>
                         `;
                    } else {
                        downloadBtns = `<a href="/stamp-tool/certificate/${cert.id}/download" target="_blank" title="–°–∫–∞—á–∞—Ç—å" style="font-size: 1.2rem; color: #6366f1;">üì•</a>`;
                    }

                    tr.innerHTML = `
                        <td class="cell-name" title="${cert.patient_name || ''}">${cert.patient_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</td>
                        <td class="cell-amount">${cert.amount} ‚ÇΩ</td>
                        <td class="cell-date">${dateStr}</td>
                        <td class="cell-time">${timeStr}</td>
                        <td class="${daysClass}">${daysText}</td>
                        <td class="cell-action">
                            ${downloadBtns}
                            ${delBtn}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        } catch (e) {
            console.error('Error loading certs:', e);
        }
    }

    async function deleteCert(id) {
        if (!confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É?')) return;

        try {
            const res = await fetch(`/stamp-tool/certificate/${id}/delete`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });
            const data = await res.json();

            if (data.success) {
                loadCertificates();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || 'Unknown'));
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e);
        }
    }

    loadCertificates();
</script>
{% endblock %}

{% block content %}
<div class="stamp-tool-container">
    <div class="page-header">
        <h2>üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø—Ä–∞–≤–æ–∫</h2>
        <p class="subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏ (–§–æ—Ä–º–∞ –ö–ù–î 1151156)</p>
    </div>

    <!-- Top Search Block (Full Width) -->
    <!-- Top Search Block (Full Width) -->
    <div class="search-section">
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <!-- Year fixed width -->
            <div style="width: 120px;">
                <label class="form-label">–ì–æ–¥</label>
                <select id="filter-year" class="form-control" onchange="runSearch()">
                    <option value="2026">2026</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                </select>
            </div>
            <!-- Search flexible -->
            <div style="flex: 1; position: relative;">
                <label class="form-label">–ü–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–∞</label>
                <input type="text" id="patient-search-input" class="form-control" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –§–ò–û..."
                    autocomplete="off" oninput="debounceSearch()" style="padding-left: 35px;">
                <div style="position: absolute; left: 10px; top: 32px; color: #9ca3af;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </div>
                <button class="btn-clear" onclick="clearSearchInput()"
                    style="display:none; position:absolute; right:10px; top:32px;">‚úï</button>
            </div>
        </div>

        <!-- Results Table Container -->
        <div id="search-results-container" style="display:none; border-top: 1px solid #f3f4f6; padding-top: 1rem;">
            <table class="results-table" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead style="background: #f9fafb;">
                    <tr>
                        <th style="padding: 10px; width: 40px;"><input type="checkbox" onchange="toggleAll(this)"></th>
                        <th style="padding: 10px;">–î–∞—Ç–∞</th>
                        <th style="padding: 10px;">–§–ò–û</th>
                        <th style="padding: 10px;">–¶–µ–Ω—Ç—Ä</th>
                        <th style="padding: 10px;">–£—Å–ª—É–≥–∞</th>
                        <th style="padding: 10px; text-align: right;">–°—É–º–º–∞</th>
                    </tr>
                </thead>
                <tbody id="results-tbody"></tbody>
            </table>

            <!-- Summary Footer in Search Block -->
            <div id="selection-summary"
                style="display:none; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #e5e7eb; text-align: right;">
                <span style="color: #6b7280; margin-right: 10px;">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                <span id="total-amount" style="font-size: 1.25rem; font-weight: 700; color: #059669;">0 ‚ÇΩ</span>
            </div>
        </div>
    </div>

    <div class="main-grid">
        <!-- Left: Input Form -->
        <div class="form-section">




            <div class="form-group">
                <label class="form-label">–§–æ—Ä–º–∞ —Å–ø—Ä–∞–≤–∫–∏:</label>
                <select id="form-select" class="form-control" onchange="togglePayerFields()">
                    <option value="knd1151156">–§–æ—Ä–º–∞ –ö–ù–î 1151156 (–ü–∞—Ü–∏–µ–Ω—Ç = –ü–ª–∞—Ç–µ–ª—å—â–∏–∫)</option>
                    <option value="knd1151156_op">–§–æ—Ä–º–∞ –ö–ù–î 1151156 –û–ü (–ò–Ω–æ–π –ø–ª–∞—Ç–µ–ª—å—â–∏–∫)</option>
                </select>
            </div>



            <!-- Patient Data Block -->
            <div class="data-block patient-block">
                <div class="block-header">–î–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞</div>

                <div id="patient-data" class="patient-card" style="display: none;">
                    <div class="patient-info">
                        <span id="display-name" class="patient-name"></span>
                        <span class="patient-amount"><span id="display-amount"></span> ‚ÇΩ</span>
                    </div>
                    <small id="display-date" class="patient-date"></small>
                </div>

                <div class="inputs-grid">
                    <div class="form-group full-width">
                        <label class="form-label">–ò–ù–ù:</label>
                        <input type="text" id="inn" class="form-control inn-field" placeholder="12 —Ü–∏—Ñ—Ä" maxlength="12"
                            inputmode="numeric">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</label>
                        <input type="date" id="birth-date" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–°–µ—Ä–∏—è:</label>
                        <input type="text" id="doc-series" class="form-control" placeholder="4 —Ü–∏—Ñ—Ä—ã" maxlength="4"
                            inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ù–æ–º–µ—Ä:</label>
                        <input type="text" id="doc-number" class="form-control" placeholder="6 —Ü–∏—Ñ—Ä" maxlength="6"
                            inputmode="numeric">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞:</label>
                        <input type="date" id="doc-issue-date" class="form-control">
                    </div>
                </div>
            </div>

            <!-- Payer Data Block -->
            <div id="payer-block" class="data-block payer-block block-disabled">
                <div class="block-header">–î–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞</div>
                <div class="inputs-grid">
                    <div class="form-group full-width">
                        <label class="form-label">–§–ò–û –ü–ª–∞—Ç–µ–ª—å—â–∏–∫–∞:</label>
                        <input type="text" id="payer-fio" class="form-control" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                            disabled>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">–ò–ù–ù:</label>
                        <input type="text" id="payer-inn" class="form-control inn-field" placeholder="12 —Ü–∏—Ñ—Ä"
                            maxlength="12" inputmode="numeric" disabled>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</label>
                        <input type="date" id="payer-birth-date" class="form-control" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–°–µ—Ä–∏—è:</label>
                        <input type="text" id="payer-doc-series" class="form-control" placeholder="4 —Ü–∏—Ñ—Ä—ã"
                            maxlength="4" inputmode="numeric" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ù–æ–º–µ—Ä:</label>
                        <input type="text" id="payer-doc-number" class="form-control" placeholder="6 —Ü–∏—Ñ—Ä" maxlength="6"
                            inputmode="numeric" disabled>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞:</label>
                        <input type="date" id="payer-doc-issue-date" class="form-control" disabled>
                    </div>
                </div>
            </div>

            <button onclick="openEditor()" class="btn-primary">
                ‚úçÔ∏è –û—Ç–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä
            </button>
        </div>

        <!-- Right: Recent Certificates Table -->
        <div class="certificates-section">
            <h4>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏</h4>
            <div class="certificates-scroll-container">
                <table class="certificates-table">
                    <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                        <tr>
                            <th>–§–ò–û</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–í—Ä–µ–º—è</th>
                            <th>–î–æ —É–¥–∞–ª–µ–Ω–∏—è</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="certificates-list"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<style>
    .stamp-tool-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    .stamp-tool-container * {
        box-sizing: border-box;
    }

    /* Harmonized Card Style */
    /* Harmonized Card Style */
    .search-section,
    .form-section,
    .certificates-section {
        background: #fff;
        padding: 1.25rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        display: block;
        width: 100%;
        box-sizing: border-box;
        /* Explicitly ensure this */
    }

    .search-section {
        margin-bottom: 2rem;
    }

    .page-header {
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #f3f4f6;
        padding-bottom: 1rem;
    }

    .page-header h2 {
        color: #1f2937;
        margin: 0;
        font-size: 1.5rem;
    }

    .subtitle {
        color: #6b7280;
        margin-top: 0.25rem;
        font-size: 0.875rem;
    }

    .main-grid {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 2rem;
        align-items: stretch;
        /* Stretch to match height */
        width: 100%;
    }

    /* .form-section and .certificates-section styles merged above */

    .filters-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #f3f4f6;
    }

    .btn-clear {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: #f3f4f6;
        border: none;
        border-radius: 50%;
        width: 1.25rem;
        height: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        color: #6b7280;
        cursor: pointer;
        z-index: 5;
    }

    .btn-clear:hover {
        background: #e5e7eb;
        color: #1f2937;
    }

    .form-group {
        margin-bottom: 0.75rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.8rem;
        font-weight: 500;
        color: #374151;
    }

    .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        box-sizing: border-box;
    }

    .inn-field {
        font-family: 'Consolas', 'Monaco', monospace;
        letter-spacing: 0.1em;
    }

    .form-control:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }

    .inputs-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #f3f4f6;
    }

    .inputs-grid .full-width {
        grid-column: span 2;
    }

    .patient-card {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin-top: 0.75rem;
    }

    .patient-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .patient-name {
        font-weight: 600;
        font-size: 0.95rem;
    }

    .patient-amount {
        font-weight: 700;
        font-size: 1rem;
    }

    .patient-date {
        opacity: 0.85;
        font-size: 0.75rem;
    }

    .btn-primary {
        width: 100%;
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: transform 0.15s, box-shadow 0.15s;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .certificates-section {
        background: #fff;
        padding: 1.25rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        display: flex;
        flex-direction: column;
        /* height: 100%; - let grid stretch handle it, but ensure content fills */
    }

    .certificates-scroll-container {
        flex: 1;
        overflow-y: auto;
        /* minimal height to force scroll if needed */
        min-height: 200px;
        /* max-height depends on the left column, but with stretch it should just fill */
        /* To make it scrollable, we might need a fixed or calc max-height if the parent doesn't constrain it. 
           But in a grid with stretch, the cell height is fixed to the tallest sibling. 
           If right col is shorter, it stretches. If it has flex children, they fill.
           Overflow auto works if valid height. */
    }

    .certificates-section h4 {
        margin: 0 0 1rem 0;
        font-size: 1rem;
        color: #374151;
    }

    .certificates-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
    }

    .certificates-table th {
        text-align: left;
        padding: 0.5rem 0.5rem;
        border-bottom: 2px solid #e5e7eb;
        color: #6b7280;
        font-weight: 500;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .certificates-table td {
        padding: 0.6rem 0.5rem;
        border-bottom: 1px solid #f3f4f6;
        color: #374151;
    }

    .certificates-table tr:hover {
        background: #f9fafb;
    }

    .cell-name {
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
    }

    .cell-amount {
        white-space: nowrap;
        color: #059669;
        font-weight: 600;
    }

    .cell-date,
    .cell-time {
        white-space: nowrap;
        color: #6b7280;
    }

    .cell-days {
        white-space: nowrap;
        font-weight: 500;
        color: #059669;
    }

    .cell-days.warning {
        color: #f59e0b;
    }

    .cell-days.danger {
        color: #ef4444 !important;
    }

    .cell-action {
        display: flex;
        gap: 0.25rem;
        align-items: center;
    }

    .cell-action a {
        color: #6366f1;
        display: inline-flex;
        padding: 0.25rem;
        border-radius: 0.25rem;
        transition: background 0.15s;
    }

    .cell-action a:hover {
        background: rgba(99, 102, 241, 0.1);
    }

    .btn-delete-cert {
        background: transparent;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 0.25rem;
        margin-left: 0.25rem;
        border-radius: 0.25rem;
        display: inline-flex;
        align-items: center;
        transition: background 0.15s;
    }

    .btn-delete-cert:hover {
        background: rgba(239, 68, 68, 0.1);
    }

    .data-block {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    .block-header {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .patient-block {
        background: #eff6ff;
        border-color: #bfdbfe;
    }

    .patient-block .block-header {
        color: #1e40af;
    }

    .payer-block {
        background: #f0fdf4;
        border-color: #bbf7d0;
        transition: all 0.3s ease;
    }

    .payer-block .block-header {
        color: #166534;
    }

    .block-disabled {
        background: #f3f4f6;
        border-color: #e5e7eb;
        opacity: 0.7;
        pointer-events: none;
        /* Prevent clicks */
    }

    .block-disabled .block-header {
        color: #6b7280;
    }

    @media (max-width: 768px) {
        .main-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}