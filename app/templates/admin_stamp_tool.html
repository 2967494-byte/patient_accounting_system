{% extends "app_base.html" %}

{% block content %}
<div class="stamp-tool-container">
    <div class="page-header">
        <h2>üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø—Ä–∞–≤–æ–∫</h2>
        <p class="subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏ (–§–æ—Ä–º–∞ –ö–ù–î 1151156)</p>
    </div>

    <div class="main-grid">
        <!-- Left: Input Form -->
        <div class="form-section">
            <div class="form-group">
                <label class="form-label">–ü–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–∞:</label>
                <input type="text" id="patient-search" list="patients-list" class="form-control"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û...">
                <datalist id="patients-list"></datalist>
            </div>

            <div id="patient-data" class="patient-card" style="display: none;">
                <div class="patient-info">
                    <span id="display-name" class="patient-name"></span>
                    <span class="patient-amount"><span id="display-amount"></span> ‚ÇΩ</span>
                </div>
                <small id="display-date" class="patient-date"></small>
            </div>

            <div class="inputs-grid">
                <div class="form-group full-width">
                    <label class="form-label">–ò–ù–ù:</label>
                    <input type="text" id="inn" class="form-control inn-field" placeholder="12 —Ü–∏—Ñ—Ä" maxlength="12"
                        inputmode="numeric" pattern="[0-9]*">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</label>
                    <input type="date" id="birth-date" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">–°–µ—Ä–∏—è:</label>
                    <input type="text" id="doc-series" class="form-control" placeholder="4 —Ü–∏—Ñ—Ä—ã" maxlength="4"
                        inputmode="numeric" pattern="[0-9]*">
                </div>
                <div class="form-group">
                    <label class="form-label">–ù–æ–º–µ—Ä:</label>
                    <input type="text" id="doc-number" class="form-control" placeholder="6 —Ü–∏—Ñ—Ä" maxlength="6"
                        inputmode="numeric" pattern="[0-9]*">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞:</label>
                    <input type="date" id="doc-issue-date" class="form-control">
                </div>
            </div>

            <button onclick="openEditor()" class="btn-primary">
                ‚úçÔ∏è –û—Ç–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä
            </button>
        </div>

        <!-- Right: Recent Certificates Table -->
        <div class="certificates-section">
            <h4>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏</h4>
            <table class="certificates-table">
                <thead>
                    <tr>
                        <th>–§–ò–û</th>
                        <th>–°—É–º–º–∞</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–í—Ä–µ–º—è</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="certificates-list"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let currentAppointmentId = null;
    let patientsData = [];

    loadPatients();
    loadCertificates();

    async function loadPatients() {
        try {
            const response = await fetch('{{ url_for("main.get_patients_for_certificate") }}');
            const data = await response.json();

            if (data.success) {
                patientsData = data.patients;
                const datalist = document.getElementById('patients-list');
                datalist.innerHTML = '';

                data.patients.forEach(patient => {
                    const option = document.createElement('option');
                    option.value = patient.patient_name;
                    option.dataset.id = patient.id;
                    datalist.appendChild(option);
                });
            }
        } catch (e) {
            console.error('Failed to load patients:', e);
        }
    }

    document.getElementById('patient-search').addEventListener('change', function (e) {
        const selectedName = e.target.value;
        const patient = patientsData.find(p => p.patient_name === selectedName);

        if (patient) {
            currentAppointmentId = patient.id;
            document.getElementById('display-name').textContent = patient.patient_name;
            document.getElementById('display-amount').textContent = patient.cost || '0';
            document.getElementById('display-date').textContent = patient.date;
            document.getElementById('patient-data').style.display = 'flex';
        }
    });

    function openEditor() {
        if (!currentAppointmentId) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞');
            return;
        }

        const inn = document.getElementById('inn').value;
        const b_date = document.getElementById('birth-date').value;
        const series = document.getElementById('doc-series').value;
        const number = document.getElementById('doc-number').value;
        const issue_date = document.getElementById('doc-issue-date').value;

        const params = new URLSearchParams({
            inn: inn,
            b_date: b_date,
            series: series,
            number: number,
            issue_date: issue_date
        });

        window.location.href = `/stamp-tool/certificate/edit/${currentAppointmentId}?${params.toString()}`;
    }

    async function loadCertificates() {
        try {
            const response = await fetch('{{ url_for("main.list_certificates") }}');
            const data = await response.json();

            if (data.success) {
                const tbody = document.getElementById('certificates-list');
                tbody.innerHTML = '';

                // Show only last 10
                const certs = data.certificates.slice(0, 10);

                certs.forEach(cert => {
                    const dt = new Date(cert.generated_at);
                    // Format date and time for Moscow (UTC+3)
                    const dateStr = dt.toLocaleDateString('ru-RU', { timeZone: 'Europe/Moscow' });
                    const timeStr = dt.toLocaleTimeString('ru-RU', { timeZone: 'Europe/Moscow', hour: '2-digit', minute: '2-digit' });

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="cell-name">${cert.patient_name}</td>
                        <td class="cell-amount">${cert.amount} ‚ÇΩ</td>
                        <td class="cell-date">${dateStr}</td>
                        <td class="cell-time">${timeStr}</td>
                        <td class="cell-action">
                            <a href="/stamp-tool/certificate/${cert.id}/download" title="–°–∫–∞—á–∞—Ç—å">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            </a>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        } catch (e) {
            console.error('Failed to load certificates:', e);
        }
    }
</script>

<style>
    .stamp-tool-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    .page-header {
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #f3f4f6;
        padding-bottom: 1rem;
    }

    .page-header h2 {
        color: #1f2937;
        margin: 0;
        font-size: 1.5rem;
    }

    .subtitle {
        color: #6b7280;
        margin-top: 0.25rem;
        font-size: 0.875rem;
    }

    .main-grid {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 2rem;
        align-items: start;
    }

    .form-section {
        background: #fff;
        padding: 1.25rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
    }

    .form-group {
        margin-bottom: 0.75rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.8rem;
        font-weight: 500;
        color: #374151;
    }

    .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        box-sizing: border-box;
    }

    .inn-field {
        font-family: 'Consolas', 'Monaco', monospace;
        letter-spacing: 0.1em;
    }

    .form-control:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }

    .inputs-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #f3f4f6;
    }

    .inputs-grid .full-width {
        grid-column: span 2;
    }

    .patient-card {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin-top: 0.75rem;
    }

    .patient-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .patient-name {
        font-weight: 600;
        font-size: 0.95rem;
    }

    .patient-amount {
        font-weight: 700;
        font-size: 1rem;
    }

    .patient-date {
        opacity: 0.85;
        font-size: 0.75rem;
    }

    .btn-primary {
        width: 100%;
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: transform 0.15s, box-shadow 0.15s;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .certificates-section {
        background: #fff;
        padding: 1.25rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
    }

    .certificates-section h4 {
        margin: 0 0 1rem 0;
        font-size: 1rem;
        color: #374151;
    }

    .certificates-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
    }

    .certificates-table th {
        text-align: left;
        padding: 0.5rem 0.5rem;
        border-bottom: 2px solid #e5e7eb;
        color: #6b7280;
        font-weight: 500;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .certificates-table td {
        padding: 0.6rem 0.5rem;
        border-bottom: 1px solid #f3f4f6;
        color: #374151;
    }

    .certificates-table tr:hover {
        background: #f9fafb;
    }

    .cell-name {
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
    }

    .cell-amount {
        white-space: nowrap;
        color: #059669;
        font-weight: 600;
    }

    .cell-date,
    .cell-time {
        white-space: nowrap;
        color: #6b7280;
    }

    .cell-action a {
        color: #6366f1;
        display: inline-flex;
        padding: 0.25rem;
        border-radius: 0.25rem;
        transition: background 0.15s;
    }

    .cell-action a:hover {
        background: rgba(99, 102, 241, 0.1);
    }

    @media (max-width: 768px) {
        .main-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}