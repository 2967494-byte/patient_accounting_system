<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 1121px;

            height: {
                    {
                    '3170px' if form_type=='knd1151156_op' else '1585px'
                }
            }

            ;
            overflow: hidden;
            filter: blur(0.15px);
        }

        #background,
        #background-2 {
            position: absolute;
            left: 0;
            width: 1121px;
            height: 1585px;
            z-index: -1;
        }

        .char-box {
            position: absolute;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: Arial, Helvetica, sans-serif;
            font-weight: 400;
            font-size: 22px;
            color: black;
        }
    </style>
</head>

<body>
    <img id="background" src="{{ bg_url }}" style="top: 0;" loading="eager">
    {% if form_type == 'knd1151156_op' %}
    <img id="background-2" src="{{ bg_url_p2 }}" style="top: 1585px;" loading="eager">
    {% endif %}

    {% for field, value in form_data.items() %}
    {% set f_id = field %}
    {% set f_val = value %}

    <script>
        (function () {
            const f_id = '{{ f_id }}';
            const f_val = '{{ f_val }}';

            // Basic offsets from backend
            const globalX = parseInt('{{ calibration.x | default(0) }}');
            const globalY = parseInt('{{ calibration.y | default(0) }}');

            // individual offsets if provided
            const individualOffsets = JSON.parse('{{ (calibration.offsets or {}) | tojson }}');
            const off = individualOffsets[f_id] || { x: 0, y: 0 };

            const config = {
                'top_inn': { startX: 352, startY: 28.5, spacing: 26.7 },
                'top_kpp': { startX: 352, startY: 68.5, spacing: 26.7 },
                'page_no': { startX: 622, startY: 68.5, spacing: 26.7 },
                'cert_no': { startX: 164.5, startY: 248.5, spacing: 26.7 },
                'correction': { startX: 702, startY: 248.5, spacing: 26.7 },
                'year': { startX: 992, startY: 248.5, spacing: 26.7 },
                'org_l1': { startX: 37, startY: 348.5, spacing: 26.7 },
                'org_l2': { startX: 37, startY: 385.5, spacing: 26.7 },
                'org_l3': { startX: 37, startY: 422.5, spacing: 26.7 },
                'org_l4': { startX: 37, startY: 459.5, spacing: 26.7 },
                'surname': { startX: 139, startY: 575.5, spacing: 26.7 },
                'name': { startX: 139, startY: 621.0, spacing: 26.7 },
                'patronymic': { startX: 139, startY: 666.5, spacing: 26.7 },
                'p_inn': { startX: 139, startY: 712.0, spacing: 26.7 },
                'b_day': { startX: 700, startY: 712.0, spacing: 26.7 },
                'b_month': { startX: 781, startY: 712.0, spacing: 26.7 },
                'b_year': { startX: 862, startY: 712.0, spacing: 26.7 },
                'doc_code': { startX: 219, startY: 800.5, spacing: 26.7 },
                'doc_info': { startX: 567.7, startY: 800.5, spacing: 26.7 },
                'i_day': { startX: 219, startY: 846.0, spacing: 26.7 },
                'i_month': { startX: 300, startY: 846.0, spacing: 26.7 },
                'i_year': { startX: 381, startY: 846.0, spacing: 26.7 },
                'amount': { startX: 621.1, startY: 955.5, spacing: 26.7 },
                'amount_kop': { startX: 994.9, startY: 955.5, spacing: 26.7 },
                'c_day': { startX: 307, startY: 1282.5, spacing: 26.7 },
                'c_month': { startX: 388, startY: 1282.5, spacing: 26.7 },
                'c_year': { startX: 469, startY: 1282.5, spacing: 26.7 },
                'rep_surname': { startX: 140, startY: 1150.5, spacing: 26.7 },
                'rep_name': { startX: 140, startY: 1196.0, spacing: 26.7 },
                'rep_patronymic': { startX: 140, startY: 1241.5, spacing: 26.7 },
                // Page 2 Bottom Date (OP Form) - relative to Stamp_p2 (2925, W264) -> Date Y +2px (cumulative +12) = 3119.5, Spacing -3px (cumulative -7) = 19.7
                // Continous Grid Layout: Day(639) -> Dot(674.4) -> Month(692.1) -> Dot(727.5) -> Year(745.2) (Shifted Right +10px)
                'c_day_bottom': { startX: 639, startY: 3119.5, spacing: 19.7 },
                'c_month_bottom': { startX: 692.1, startY: 3119.5, spacing: 19.7 },
                'c_year_bottom': { startX: 745.2, startY: 3119.5, spacing: 19.7 },
            };

            const images = {
                'stamp': { url: '{{ stamp_url }}', startX: 34, startY: 1210, width: 264 }
                {% if form_type == 'knd1151156_op' %}
                , 'stamp_p2': { url: '{{ stamp_url }}', startX: 323, startY: 2925, width: 264 }
            {% endif %}
        };
        // Handle p2 suffix
        let baseId = f_id;
        let pageOffset = 0;
        if (f_id.endsWith('_p2')) {
            baseId = f_id.replace('_p2', '');
            // User requested lifting text by 358px (was 360, moved down 2)
            pageOffset = 1585 - 358;
        }

        const c = config[baseId];
        if (c) {
            for (let i = 0; i < f_val.length; i++) {
                const char = f_val[i];
                if (!char || char === ' ') continue;

                const div = document.createElement('div');
                div.className = 'char-box';
                div.style.left = (c.startX + (i * c.spacing) + globalX + off.x) + 'px';
                div.style.top = (c.startY + globalY + off.y + pageOffset - 2) + 'px';
                div.textContent = char;
                document.body.appendChild(div);
            }
        }

        }) ();
    </script>
    {% endfor %}

    <script>
        (function () {
            const globalX = parseInt('{{ calibration.x | default(0) }}');
            const globalY = parseInt('{{ calibration.y | default(0) }}');
            const images = {
                'stamp': { url: '{{ stamp_url }}', startX: 34, startY: 1210, width: 264 }
                {% if form_type == 'knd1151156_op' %}
                , 'stamp_p2': { url: '{{ stamp_url }}', startX: 428, startY: 2985, width: 264 }
            {% endif %}
        };

        Object.keys(images).forEach(id => {
            const imgConfig = images[id];
            if (imgConfig && imgConfig.url && imgConfig.url !== '') {
                const img = document.createElement('img');
                img.src = imgConfig.url;
                img.style.position = 'absolute';
                img.style.left = (imgConfig.startX + globalX) + 'px';
                img.style.top = (imgConfig.startY + globalY) + 'px';
                img.style.width = imgConfig.width + 'px';
                img.style.opacity = '1.0';
                img.style.mixBlendMode = 'multiply';
                document.body.appendChild(img);
            }
        });
        }) ();
    </script>
    <script>
        (function () {
            {% if form_type == 'knd1151156_op' %}
            // Render Static Dots for Page 2 Date
            const globalX = parseInt('{{ calibration.x | default(0) }}');
            const globalY = parseInt('{{ calibration.y | default(0) }}');
            const dots = [
                { x: 674.4, y: 3119.5 },
                { x: 727.5, y: 3119.5 }
            ];
            dots.forEach(d => {
                const div = document.createElement('div');
                div.className = 'char-box';
                div.style.left = (d.x + globalX) + 'px';
                // Note: top matches calculation in main loop: c.startY + globalY + off.y + pageOffset - 2. 
                // Here off.y=0, pageOffset=0 (absolute Y). -2 adjustment preserved.
                div.style.top = (d.y + globalY - 2) + 'px';
                div.textContent = '.';
                document.body.appendChild(div);
            });
            {% endif %}
        })();
    </script>
</body>

</html>