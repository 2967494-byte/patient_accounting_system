{% extends "admin_base.html" %}

{% block content %}
<div class="card">
    <div class="flex-between mb-4">
        <h2>Клиники</h2>
        <div style="display: flex; gap: 10px;">
            <button onclick="document.getElementById('import-file').click()" class="btn"
                style="background-color: #10b981; color: white;">
                Импорт (Excel/CSV)
            </button>
            <button onclick="openAddModal()" class="btn btn-primary">
                Добавить клинику
            </button>
        </div>

        <!-- Hidden Import Form -->
        <form id="import-form" action="{{ url_for('admin.import_clinics') }}" method="POST"
            enctype="multipart/form-data" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="file" id="import-file" name="file" accept=".csv, .xlsx"
                onchange="document.getElementById('import-form').submit()">
        </form>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Наименование</th>
                <th>Город</th>
                <th>Телефон</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for clinic in clinics %}
            <tr>
                <td>{{ clinic.id }}</td>
                <td>{{ clinic.name }}</td>
                <td>{{ clinic.city.name if clinic.city else '-' }}</td>
                <td>{{ clinic.phone or '-' }}</td>
                <td>
                    <button
                        onclick="editClinic('{{ clinic.id }}', '{{ clinic.name }}', '{{ clinic.city_id }}', '{{ clinic.phone or '' }}')"
                        class="btn" style="background: transparent; color: #4b5563; padding: 0.25rem;">
                        ✎
                    </button>
                    <button onclick="deleteClinic('{{ clinic.id }}')" class="btn"
                        style="background: transparent; color: #ef4444; padding: 0.25rem;">
                        ✕
                    </button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" style="text-align:center; color:#9ca3af; padding: 2rem;">Список клиник пуст</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal -->
<div id="clinic-modal" class="modal hidden"
    style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <div class="modal-content"
        style="background: white; padding: 2rem; border-radius: 0.5rem; width: 400px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
        <h3 id="modal-title" style="margin-top: 0;">Добавить клинику</h3>
        <form id="clinic-form" method="POST" action="{{ url_for('admin.add_clinic') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="mb-4">
                <label style="display: block; margin-bottom: 0.5rem;">Наименование</label>
                <input type="text" name="name" id="clinic-name" required style="width: 100%; padding: 0.5rem;">
            </div>

            <div class="mb-4">
                <label style="display: block; margin-bottom: 0.5rem;">Город</label>
                <select name="city_id" id="clinic-city" required style="width: 100%; padding: 0.5rem;">
                    <option value="">-- Выберите город --</option>
                    {% for city in cities %}
                    <option value="{{ city.id }}">{{ city.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-4">
                <label style="display: block; margin-bottom: 0.5rem;">Телефон</label>
                <input type="text" name="phone" id="clinic-phone" style="width: 100%; padding: 0.5rem;">
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="closeModal()" class="btn" style="background: #e5e7eb;">Отмена</button>
                <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<style>
    .hidden {
        display: none !important;
    }

    .mb-4 {
        margin-bottom: 1rem;
    }
</style>

<script>
    const modal = document.getElementById('clinic-modal');
    const form = document.getElementById('clinic-form');

    function openAddModal() {
        document.getElementById('modal-title').textContent = 'Добавить клинику';
        form.action = "{{ url_for('admin.add_clinic') }}";
        form.reset();
        modal.classList.remove('hidden');
    }

    function editClinic(id, name, cityId, phone) {
        document.getElementById('modal-title').textContent = 'Редактировать клинику';
        form.action = `/admin/clinics/${id}/update`;
        document.getElementById('clinic-name').value = name;
        document.getElementById('clinic-city').value = cityId;
        document.getElementById('clinic-phone').value = phone;
        // Manager removed
        modal.classList.remove('hidden');
    }

    function closeModal() {
        modal.classList.add('hidden');
    }

    function deleteClinic(id) {
        if (confirm('Вы уверены, что хотите удалить эту клинику?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/clinics/${id}/delete`;

            const csrf = document.createElement('input');
            csrf.type = 'hidden';
            csrf.name = 'csrf_token';
            csrf.value = "{{ csrf_token() }}";
            form.appendChild(csrf);

            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}