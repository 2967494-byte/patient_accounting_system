{% extends "app_base.html" %}

{% block content %}
<style>
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ */
    .journal-table {
        min-width: 100%;
        width: auto;
        border-collapse: collapse;
        table-layout: auto;
    }

    /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —à–∏—Ä–∏–Ω—ã –¥–ª—è —É–∑–∫–∏—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ */
    .journal-table th:nth-child(1),
    /* ‚Ññ */
    .journal-table td:nth-child(1) {
        min-width: 40px;
        width: 1%;
    }

    .journal-table th:nth-child(3),
    /* –†–µ–± */
    .journal-table td:nth-child(3) {
        min-width: 40px;
        width: 1%;
    }

    .journal-table th:nth-child(8),
    /* –ö–æ–ª-–≤–æ */
    .journal-table td:nth-child(8),
    .journal-table th:nth-child(11),
    /* –°–∫–∏–¥–∫–∞ */
    .journal-table td:nth-child(11),
    .journal-table th:nth-child(12),
    /* –°—É–º–º–∞ */
    .journal-table td:nth-child(12) {
        min-width: 70px;
        width: 1%;
    }

    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã —Å –±–∞–∑–æ–≤–æ–π –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —à–∏—Ä–∏–Ω–æ–π */
    .journal-table th:nth-child(2),
    /* –î–æ–≥–æ–≤–æ—Ä */
    .journal-table td:nth-child(2),
    .journal-table th:nth-child(4),
    /* –ö–ª–∏–Ω–∏–∫–∞ */
    .journal-table td:nth-child(4),
    .journal-table th:nth-child(5),
    /* –í—Ä–∞—á */
    .journal-table td:nth-child(5),
    .journal-table th:nth-child(6),
    /* –ü–∞—Ü–∏–µ–Ω—Ç */
    .journal-table td:nth-child(6),
    .journal-table th:nth-child(9),
    /* –î–æ–ø —É—Å–ª—É–≥–∏ */
    .journal-table td:nth-child(9),
    .journal-table th:nth-child(10),
    /* –û–ø–ª–∞—Ç–∞ */
    .journal-table td:nth-child(10),
    .journal-table th:nth-child(13),
    /* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π */
    .journal-table td:nth-child(13),
    .journal-table th:nth-child(14),
    /* –õ–∞–±–æ—Ä–∞–Ω—Ç */
    .journal-table td:nth-child(14),
    .journal-table th:nth-child(15),
    /* –ú–µ–Ω–µ–¥–∂–µ—Ä */
    .journal-table td:nth-child(15),
    .journal-table th:nth-child(16),
    /* –î–µ–π—Å—Ç–≤–∏—è */
    .journal-table td:nth-child(16) {
        min-width: 100px;
    }

    /* Column 7: Research - specific limit */
    .journal-table th:nth-child(7),
    .journal-table td:nth-child(7) {
        min-width: 100px;
        max-width: 250px;
    }

    .journal-table td:nth-child(7) select {
        max-width: 100%;
    }

    /* –û–ø–ª–∞—Ç–∞ */
    .journal-table td:nth-child(10),
    .journal-table th:nth-child(13),
    /* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π */
    .journal-table td:nth-child(13),
    .journal-table th:nth-child(14),
    /* –õ–∞–±–æ—Ä–∞–Ω—Ç */
    .journal-table td:nth-child(14),
    .journal-table th:nth-child(15),
    /* –ú–µ–Ω–µ–¥–∂–µ—Ä */
    .journal-table td:nth-child(15),
    .journal-table th:nth-child(16),
    /* –î–µ–π—Å—Ç–≤–∏—è */
    .journal-table td:nth-child(16) {
        min-width: 100px;
    }

    /* –û–±—Ä–µ–∑–∫–∞ –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
    .journal-table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        /* max-width removed to allow full expansion */
        padding: 0.5rem;
        font-size: 13px;
    }

    /* –î–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ —è—á–µ–π–∫–∞—Ö */
    .journal-table td input,
    .journal-table td select {
        max-width: none;
        /* Allow unlimited growth */
        box-sizing: border-box;
        width: auto;
        /* Allow input to size to content */
        min-width: 100%;
        /* But take at least full cell width */
        /* Seamless look */
        font-size: 13px;
        /* Ensure match with td */
        font-family: inherit;
    }

    /* Fallback for field-sizing if supported */
    @supports (field-sizing: content) {
        .journal-table td input {
            field-sizing: content;
            min-width: 100%;
        }
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ */
    .journal-table-wrapper {
        overflow-x: auto;
        width: 100%;
        max-width: 100%;
        /* Ensure scrollbar is visible */
        scrollbar-width: auto;
        /* Firefox */
        scrollbar-color: #888 #f1f1f1;
        /* Firefox */
    }

    /* Webkit Scrollbar Styling */
    .journal-table-wrapper::-webkit-scrollbar {
        height: 24px;
        /* Vital for horizontal scrollbar visibility */
        width: 24px;
    }

    .journal-table-wrapper::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 6px;
    }

    .journal-table-wrapper::-webkit-scrollbar-thumb {
        background-color: #888;
        /* Dark grey thumb */
        border-radius: 6px;
        border: 2px solid #f1f1f1;
        /* Padding feeling */
    }

    .journal-table-wrapper::-webkit-scrollbar-thumb:hover {
        background-color: #555;
    }
</style>

<script>
    // Helper to auto-resize inputs for browsers without field-sizing support
    function adjustInputWidth(el) {
        if (CSS.supports('field-sizing', 'content')) return; // performant native handling
        // Simple heuristic: chars * approx width + padding
        // Or accurate: set width auto, measure? 
        // Better: use 'size' attribute as proxy for 'ch' width
        el.size = (el.value.length || 1) + 2;
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initial resize of inputs
        document.querySelectorAll('.journal-input').forEach(adjustInputWidth);

        // Input auto-resize listener
        const table = document.querySelector('.journal-table');
        if (table) {
            table.addEventListener('input', (e) => {
                if (e.target.classList.contains('journal-input')) {
                    adjustInputWidth(e.target);
                    syncTopScrollWidth(); // Update scroll width if table grows
                }
            });
        }

        // --- Top Scrollbar Logic ---
        const topWrapper = document.getElementById('top-scroll-wrapper');
        const bottomWrapper = document.getElementById('bottom-scroll-wrapper');
        const topContent = document.getElementById('top-scroll-content');

        function syncTopScrollWidth() {
            if (bottomWrapper && topContent && table) {
                topContent.style.width = table.offsetWidth + 'px';
            }
        }

        // Sync scroll positions
        if (topWrapper && bottomWrapper) {
            topWrapper.addEventListener('scroll', () => {
                bottomWrapper.scrollLeft = topWrapper.scrollLeft;
            });
            bottomWrapper.addEventListener('scroll', () => {
                topWrapper.scrollLeft = bottomWrapper.scrollLeft;
            });
        }

        // Initial sync
        // Wait a tick for layout
        setTimeout(syncTopScrollWidth, 100);

        // Sync on window resize
        window.addEventListener('resize', syncTopScrollWidth);

        // Also sync whenever the table changes (using potential new inputs or loaded data)
        const observer = new ResizeObserver(syncTopScrollWidth);
        if (table) observer.observe(table);
    });
</script>
<div class="journal-container"
    style="padding: 1rem; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; flex: 1; overflow: hidden; height: 100%;">
    <!-- Filters -->
    <div class="filters-bar"
        style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <label for="journal-date" style="font-weight: 500; font-size: 1.1rem; color: #374151;">–î–∞—Ç–∞:</label>
            <input type="date" id="journal-date" value="{{ current_date }}"
                style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem;"
                onchange="window.location.href = `{{ url_for('main.journal') }}?center_id={{ current_center_id }}&date=${this.value}`">
        </div>
        <div style="display: flex; gap: 10px;">
            {% if current_user.role == 'admin' %}
            <button onclick="document.getElementById('importJournalModal').style.display='block'" class="btn"
                style="background-color: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                –ò–º–ø–æ—Ä—Ç (Excel)
            </button>
            {% endif %}
            <button onclick="openJournalModal()" class="btn btn-primary"
                style="background-color: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.25rem;">+</span> –î–æ–±–∞–≤–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- Custom Top Scrollbar -->
    <div id="top-scroll-wrapper" class="journal-table-wrapper"
        style="overflow-x: auto; overflow-y: hidden; height: 24px; min-height: 24px; margin-bottom: 0; border-bottom: none; border-bottom-left-radius: 0; border-bottom-right-radius: 0; flex: 0 0 auto;">
        <div id="top-scroll-content" style="height: 1px;"></div>
    </div>

    <div id="bottom-scroll-wrapper" class="journal-table-wrapper"
        style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; width: 100%; max-width: 100%; flex: 1; border-top-left-radius: 0; border-top-right-radius: 0;">
        <table class="journal-table" style="border-collapse: collapse;">
            <thead>
                <tr
                    style="background-color: #f3f4f6; text-align: left; position: sticky; top: 0; z-index: 10; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);">
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">‚Ññ</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–î–æ–≥–æ–≤–æ—Ä</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–†–µ–±</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–ö–ª–∏–Ω–∏–∫–∞</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–í—Ä–∞—á</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–ü–∞—Ü–∏–µ–Ω—Ç</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
                    </th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–ö–æ–ª-–≤–æ</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–î–æ–ø —É—Å–ª—É–≥–∏</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–û–ø–ª–∞—Ç–∞</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–°–∫–∏–¥–∫–∞</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–°—É–º–º–∞</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–õ–∞–±–æ—Ä–∞–Ω—Ç</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="journal-body">
                {% if appointments %}
                {% for appointment in appointments %}
                <tr class="data-row input-row saved-row" data-id="{{ appointment.id }}"
                    style="border-bottom: 1px solid #e5e7eb; background: #fff;">
                    <td class="row-number" style="padding: 0.75rem 0.5rem; text-align: center; color: #6b7280;">{{
                        loop.index
                        }}</td>
                    <td style="padding: 0.25rem 0.5rem; white-space: nowrap;">
                        <input type="text" name="contract_number" value="{{ appointment.contract_number or '' }}"
                            title="{{ appointment.contract_number or '' }}" class="journal-input"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')" disabled required>
                    </td>
                    <td style="padding: 0.25rem 0.5rem; text-align: center;">
                        <input type="checkbox" {% if appointment.is_child %}checked{% endif %} disabled
                            style="width: 1.1rem; height: 1.1rem;">
                    </td>
                    <td style="padding: 0.25rem 0.5rem; white-space: nowrap;">
                        <select name="clinic_id" class="journal-select" disabled required>
                            <option value="">--</option>
                            {% for clinic in clinics %}
                            <option value="{{ clinic.id }}" {% if appointment.clinic_id==clinic.id %}selected{% endif
                                %}>{{ clinic.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td style="padding: 0.25rem 0.5rem; white-space: nowrap;">
                        <select name="doctor_id" class="journal-select" onchange="updateManager(this)" disabled
                            required>
                            <option value="">--</option>
                            <option value="Unknown" {% if appointment.doctor=='Unknown' %}selected{% endif %}>Unknown
                            </option>
                            {% for doc in doctors %}
                            <option value="{{ doc.id }}" data-manager="{{ doc.manager or '' }}" {% if
                                appointment.doctor_id==doc.id %}selected{% endif %}>{{
                                doc.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td style="padding: 0.25rem 0.5rem; white-space: nowrap;">
                        <input type="text" name="patient_name" value="{{ appointment.patient_name }}"
                            title="{{ appointment.patient_name }}" class="journal-input" disabled required>
                    </td>
                    <td style="padding: 0.25rem 0.5rem; white-space: nowrap;">
                        <select name="service" class="journal-select" onchange="calculateTotal(this)" disabled required>
                            <option value="">--</option>
                            {% for s in services %}
                            <option value="{{ s.id }}" {% if appointment.service==s.name or
                                appointment.service==s.id|string %}selected{% endif %}>{{ s.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td style="padding: 0.25rem 0.5rem;">
                        <input type="number" name="quantity" value="{{ appointment.quantity or 1 }}"
                            class="journal-input" style="text-align: center;" disabled required>
                    </td>
                    <td style="padding: 0.25rem 0.5rem;">
                        <select name="additional_service" class="journal-select" onchange="calculateTotal(this)"
                            disabled>
                            <option value="">--</option>
                            {% set current_add_svc = appointment.additional_services[0] if
                            appointment.additional_services else None %}
                            {% for ads in additional_services %}
                            <option value="{{ ads.id }}" {% if current_add_svc and current_add_svc.id==ads.id
                                %}selected{% endif %}>{{ ads.name }} - {{ ads.price }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td style="padding: 0.25rem 0.5rem;">
                        <select name="payment_method_id" class="journal-select" onchange="calculateTotal(this)" disabled
                            required>
                            <option value="">--</option>
                            {% for method in payment_methods %}
                            <option value="{{ method.id }}" {% if appointment.payment_method_id==method.id %}selected{%
                                endif %}>{{ method.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td style="padding: 0.25rem 0.5rem;">
                        <input type="number" name="discount" value="{{ appointment.discount or 0 }}"
                            class="journal-input" disabled required oninput="calculateTotal(this)">
                    </td>
                    <td style="padding: 0.75rem 0.5rem;">
                        <input type="number" name="cost" value="{{ appointment.cost }}" class="journal-input-readonly"
                            readonly>
                    </td>
                    <td style="padding: 0.25rem 0.5rem;">
                        <input type="text" name="comment" value="{{ appointment.comment or '' }}" class="journal-input"
                            title="{{ appointment.comment or '' }}" disabled>
                    </td>
                    <td style="padding: 0.75rem 0.5rem;">{{ appointment.lab_tech or (appointment.author.username if
                        appointment.author else '-') }}</td>
                    <td style="padding: 0.25rem 0.5rem; white-space: nowrap;">
                        <input type="text" name="manager" class="journal-input-readonly"
                            value="{{ appointment.doctor_rel.manager if appointment.doctor_rel and appointment.doctor_rel.manager else '-' }}"
                            readonly>
                    </td>
                    <td class="actions-cell" style="padding: 0.5rem; text-align: center; white-space: nowrap;">
                        <button class="btn-icon" onclick="toggleEdit(this)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
                        <button class="btn-icon" onclick="deleteEntry(this)" title="–£–¥–∞–ª–∏—Ç—å"
                            style="color: #ef4444;">üóëÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
                {% endif %}

        </table>
    </div>

    <!-- Summary Table -->
    {% if summary_stats %}
    <div class="summary-section" style="margin-top: 2rem;">
        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: #374151;">–°–≤–æ–¥–∫–∞ –∑–∞ –¥–µ–Ω—å</h3>
        <div style="overflow-x: auto;">
            <table
                style="width: auto; min-width: 500px; border-collapse: collapse; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                <thead>
                    <tr style="background-color: #f3f4f6; text-align: left;">
                        <th style="padding: 0.75rem 1rem; border-bottom: 2px solid #e5e7eb; color: #374151;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è
                        </th>
                        <th style="padding: 0.75rem 1rem; border-bottom: 2px solid #e5e7eb; color: #374151;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
                        </th>
                        <th style="padding: 0.75rem 1rem; border-bottom: 2px solid #e5e7eb; color: #374151;">–°—É–º–º–∞ (‚ÇΩ)
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 0.75rem 1rem; font-weight: 600; color: #111827;">–í—Å–µ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</td>
                        <td style="padding: 0.75rem 1rem; color: #374151;">{{ summary_stats.total_count }}</td>
                        <td style="padding: 0.75rem 1rem; font-weight: 600; color: #10b981;">{{
                            "%.2f"|format(summary_stats.total_sum) }}</td>
                    </tr>
                    {% for method_name, stats in summary_stats.methods.items() %}
                    {% if stats.count > 0 or True %}
                    <!-- Show all methods even if 0? User asked specific list. Let's show all available methods for structure. -->
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 0.75rem 1rem; color: #374151;">{{ method_name }}</td>
                        <td style="padding: 0.75rem 1rem; color: #374151;">{{ stats.count }}</td>
                        <td style="padding: 0.75rem 1rem; color: #374151;">{{ "%.2f"|format(stats.sum) }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal -->
<div id="entryModal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content"
        style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 600px; border-radius: 8px;">
        <span class="close" onclick="closeJournalModal()"
            style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h2 style="margin-bottom: 20px; color: #1f2937;">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h2>
        <form id="entryForm" style="display: flex; flex-direction: column; gap: 15px;">

            <!-- Row 1: Contract, Child Checkbox -->
            <div style="display: flex; gap: 15px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label
                        style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–î–æ–≥–æ–≤–æ—Ä</label>
                    <input type="text" name="contract_number" class="journal-input"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="‚Ññ" required>
                </div>
                <div style="flex: 0 0 auto; display: flex; align-items: center; padding-bottom: 0.6rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; user-select: none;">
                        <input type="checkbox" name="is_child" style="width: 1.2rem; height: 1.2rem; cursor: pointer;">
                        <span style="font-size: 0.95rem; color: #374151;">–†–µ–±–µ–Ω–æ–∫</span>
                    </label>
                </div>
            </div>

            <!-- Row 2: Patient Name (Full Width) -->
            <div>
                <label style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–ü–∞—Ü–∏–µ–Ω—Ç</label>
                <input type="text" name="patient_name" class="journal-input" placeholder="–§–ò–û" required>
            </div>

            <!-- Row 2: Clinic, Doctor -->
            <div style="display: flex; gap: 15px;">
                <div style="flex: 1;">
                    <label
                        style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–ö–ª–∏–Ω–∏–∫–∞</label>
                    <select name="clinic_id" class="journal-select" required>
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                        {% for clinic in clinics %}
                        <option value="{{ clinic.id }}">{{ clinic.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="flex: 1;">
                    <label style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–í—Ä–∞—á</label>
                    <select name="doctor_id" class="journal-select" onchange="updateManager(this)" required>
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                        {% for doc in doctors %}
                        <option value="{{ doc.id }}" data-manager="{{ doc.manager or '' }}">{{ doc.name }}</option>
                        {% endfor %}
                    </select>
                    <!-- Hidden manager field for logic -->
                    <input type="hidden" name="manager">
                </div>
            </div>

            <!-- Row 3: Service, Quantity -->
            <div style="display: flex; gap: 15px;">
                <div style="flex: 2;">
                    <label
                        style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</label>
                    <select name="service" class="journal-select" onchange="calculateTotal()" required>
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                        {% for s in services %}
                        <option value="{{ s.id }}">{{ s.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="flex: 1;">
                    <label style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–ö–æ–ª-–≤–æ</label>
                    <input type="number" name="quantity" value="1" class="journal-input" style="text-align: center;"
                        oninput="calculateTotal()" required>
                </div>
            </div>

            <!-- Row 4: Additional Service, Add. Quantity -->
            <div style="display: flex; gap: 15px;">
                <div style="flex: 2;">
                    <label style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–î–æ–ø.
                        —É—Å–ª—É–≥–∞</label>
                    <select name="additional_service" class="journal-select" onchange="calculateTotal()">
                        <option value="">-- –ù–µ—Ç --</option>
                        {% for ads in additional_services %}
                        <option value="{{ ads.id }}">{{ ads.name }} - {{ ads.price }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="flex: 1;">
                    <label style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–ö–æ–ª-–≤–æ</label>
                    <input type="number" name="additional_service_quantity" value="1" class="journal-input"
                        style="text-align: center;" oninput="calculateTotal()">
                </div>
            </div>

            <!-- Row 5: Payment, Discount -->
            <div style="display: flex; gap: 15px;">
                <div style="flex: 1;">
                    <label style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–û–ø–ª–∞—Ç–∞</label>
                    <select name="payment_method_id" class="journal-select" onchange="calculateTotal()" required>
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                        {% for method in payment_methods %}
                        <option value="{{ method.id }}">{{ method.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="flex: 1;">
                    <label style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–°–∫–∏–¥–∫–∞</label>
                    <input type="number" name="discount" value="0" class="journal-input" oninput="calculateTotal()"
                        required>
                </div>
            </div>

            <!-- Comment -->
            <div>
                <label
                    style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <input type="text" name="comment" class="journal-input">
            </div>

            <!-- Row 6: SUM -->
            <div style="text-align: right; margin-top: 10px;">
                <div style="font-weight: bold; font-size: 1.25rem; color: #111827;">
                    –°–£–ú–ú–ê: <span id="modal-total-display">0.00</span> ‚ÇΩ
                    <input type="hidden" name="cost">
                </div>
            </div>

            <div style="margin-top: 20px; text-align: right;">
                <button type="button" onclick="handleSave()" class="btn btn-primary"
                    style="background-color: #10b981; color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* Journal Input Styles */
    .journal-input,
    .journal-select {
        width: 100%;
        padding: 0.4rem;
        border: 1px solid #e5e7eb;
        /* Subtle full border */
        border-radius: 4px;
        background: white;
        font-family: inherit;
        font-size: 0.95rem;
        outline: none;
        transition: border-color 0.2s;
    }

    .journal-input:focus,
    .journal-select:focus {
        border-color: #3b82f6;
    }

    /* Disabled state to look like text */
    .journal-input:disabled,
    .journal-select:disabled {
        border-color: transparent;
        background: transparent;
        color: #111827;
        padding: 0.4rem 0;
        /* Align with text */
        -webkit-appearance: none;
        appearance: none;
        opacity: 1;
        /* Override default opacity */
    }

    /* Remove arrow from disabled selects if possible, or just accept it. 
       Appearance none removes standard arrow in some browsers. */
    select:disabled {
        background-image: none;
    }

    .journal-input-readonly {
        width: 100%;
        border: none;
        background: transparent;
        font-family: inherit;
        font-size: 0.95rem;
        color: #374151;
        outline: none;
        pointer-events: none;
    }

    .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        color: #6b7280;
    }

    .btn-icon:hover {
        color: #3b82f6;
    }

    /* Hide number spinners */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        updateRowNumbers();
        // date change logic is inline
    });

    const CURRENT_CENTER_ID = "{{ current_center_id }}";

    function updateRowNumbers() {
        const rows = document.querySelectorAll('#journal-body tr');
        rows.forEach((row, index) => {
            const cell = row.querySelector('.row-number');
            if (cell) cell.textContent = index + 1;
        });
    }

    // Removed old createAddButton and updateAddButtons as we now have static + button in the input row

    function openJournalModal() {
        document.getElementById('entryModal').style.display = 'block';
        // Clear form
        document.getElementById('entryForm').reset();
        document.getElementById('modal-total-display').textContent = '0.00';
    }

    function closeJournalModal() {
        document.getElementById('entryModal').style.display = 'none';
    }

    // Close modal if outside click
    window.onclick = function (event) {
        const modal = document.getElementById('entryModal');
        if (event.target == modal) {
            closeJournalModal();
        }
    }

    async function handleSave() {
        // Read data from Modal Form
        const form = document.getElementById('entryForm');
        const inputs = form.querySelectorAll('input, select');
        const data = {};

        // Use a date picker value from the top of the page
        const dateInput = document.getElementById('journal-date');
        data['date'] = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];

        // Get Center ID from URL or Template
        const urlParams = new URLSearchParams(window.location.search);
        let centerId = urlParams.get('center_id');
        if (!centerId) {
            centerId = CURRENT_CENTER_ID;
        }

        if (centerId && centerId !== 'None') {
            data['center_id'] = centerId;
        }

        const now = new Date();
        const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        data['time'] = timeString;

        let valid = true;
        inputs.forEach(input => {
            if (input.name && !input.disabled && input.type !== 'hidden') {
                if (input.type === 'checkbox') {
                    data[input.name] = input.checked;
                } else {
                    data[input.name] = input.value;
                    if (input.hasAttribute('required') && !input.value) {
                        input.style.borderColor = 'red';
                        valid = false;
                    } else {
                        input.style.borderColor = '#e5e7eb';
                    }
                }
            } else if (input.type === 'hidden') {
                data[input.name] = input.value;
            }
        });

        if (!valid) return;

        try {
            const response = await fetch('/api/appointments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const result = await response.json();

                // Add new row to table
                try {
                    addNewRow(result);
                } catch (e) {
                    console.error("addNewRow failed", e);
                    alert("UI Error (Row): " + e.message);
                }

                // Update Summary Table
                try {
                    updateSummaryTable(data, inputs);
                } catch (e) {
                    console.error("updateSummary failed", e);
                    // alert("UI Error (Summary): " + e.message); // suppress summary error to be less annoying if row worked
                }

                // Close modal
                closeJournalModal();
            } else {
                try {
                    const err = await response.json();
                    alert('Error: ' + (err.error || 'Unknown error'));
                } catch (jsonErr) {
                    const text = await response.text();
                    console.error('Server error response:', text);
                    alert('Server Error (not JSON): ' + text.substring(0, 200));
                }
            }
        } catch (e) {
            console.error(e);
            alert('Network error: ' + e.message);
        }
    }

    function addNewRow(data) {
        // Since we removed the "Input Row Template", we need to create a read-only row 
        // essentially similar to the "saved-row" in the loop.
        // We can reload page or append HTML. Appending is smoother.

        const tbody = document.getElementById('journal-body');
        const tr = document.createElement('tr');
        tr.className = 'data-row input-row saved-row';
        tr.style.borderBottom = '1px solid #e5e7eb';
        tr.style.background = '#fff';
        tr.setAttribute('data-id', data.id);

        // We need to fetch names for IDs (Clinic, Doctor, Service, etc.) 
        // BUT `data` returned from API (to_dict) usually has names? 
        // Let's check `to_dict` in Appointment model.
        // It returns minimal info? 
        // `to_dict`: id, patient_name, patient_phone, doctor, service, date, time...
        // It might not have everything.
        // However, we can use the text from the Select elements in the form!

        const form = document.getElementById('entryForm');

        const getSelectText = (name) => {
            const sel = form.querySelector(`select[name="${name}"]`);
            return sel && sel.selectedIndex >= 0 ? sel.options[sel.selectedIndex].text : '';
        };

        // Check if is_child
        const isChild = form.querySelector('input[name="is_child"]').checked;

        const contract = form.querySelector('input[name="contract_number"]').value || '';
        const clinic = getSelectText('clinic_id');
        const doctor = getSelectText('doctor_id');
        const patient = form.querySelector('input[name="patient_name"]').value;
        const service = getSelectText('service');
        const quantity = form.querySelector('input[name="quantity"]').value;

        // Add Service text logic
        const addServiceSel = form.querySelector(`select[name="additional_service"]`);
        const addService = addServiceSel.value ? addServiceSel.options[addServiceSel.selectedIndex].text : '';

        const payment = getSelectText('payment_method_id');
        const discount = form.querySelector('input[name="discount"]').value;
        const cost = form.querySelector('input[name="cost"]').value;
        const comment = form.querySelector('input[name="comment"]').value;
        const manager = form.querySelector('input[name="manager"]').value;

        // Construct Row HTML
        // Note: Inline styles should match existing rows
        tr.innerHTML = `
            <td class="row-number" style="padding: 0.75rem 0.5rem; text-align: center; color: #6b7280;"></td>
            <td style="padding: 0.25rem 0.5rem; white-space: nowrap;"><input type="text" value="${contract}" class="journal-input" disabled></td>
            <td style="padding: 0.25rem 0.5rem; text-align: center;"><input type="checkbox" ${isChild ? 'checked' : ''} disabled style="width: 1.1rem; height: 1.1rem;"></td>
            <td style="padding: 0.25rem 0.5rem; white-space: nowrap;"><input type="text" value="${clinic}" class="journal-input" disabled></td>
            <td style="padding: 0.25rem 0.5rem; white-space: nowrap;"><input type="text" value="${doctor}" class="journal-input" disabled></td>
            <td style="padding: 0.25rem 0.5rem; white-space: nowrap;"><input type="text" value="${patient}" class="journal-input" disabled></td>
            <td style="padding: 0.25rem 0.5rem; white-space: nowrap;"><input type="text" value="${service}" class="journal-input" disabled></td>
            <td style="padding: 0.25rem 0.5rem;"><input type="text" value="${quantity}" class="journal-input" style="text-align: center;" disabled></td>
            <td style="padding: 0.25rem 0.5rem;"><input type="text" value="${addService}" class="journal-input" disabled></td>
            <td style="padding: 0.25rem 0.5rem;"><input type="text" value="${payment}" class="journal-input" disabled></td>
            <td style="padding: 0.25rem 0.5rem;"><input type="number" value="${discount}" class="journal-input" disabled></td>
            <td style="padding: 0.75rem 0.5rem;"><input type="number" value="${cost}" class="journal-input-readonly" readonly></td>
            <td style="padding: 0.25rem 0.5rem;"><input type="text" value="${comment}" class="journal-input" disabled></td>
            <td style="padding: 0.75rem 0.5rem;">{{ current_user.username }}</td>
            <td style="padding: 0.25rem 0.5rem; white-space: nowrap;"><input type="text" value="${manager}" class="journal-input-readonly" readonly></td>
            <td class="actions-cell" style="padding: 0.5rem; text-align: center; white-space: nowrap;">
                 <button class="btn-icon" onclick="toggleEdit(this)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
                 <button class="btn-icon" onclick="deleteEntry(this)" title="–£–¥–∞–ª–∏—Ç—å" style="color: #ef4444;">üóëÔ∏è</button>
            </td>
        `;

        // Insert at top? usually journals are chronological. 
        // Existing loop: order_by(Appointment.time.desc()). 
        // So newest first.
        if (tbody.firstChild) {
            tbody.appendChild(tr);
        } else {
            tbody.appendChild(tr);
        }

        updateRowNumbers();
    }

    // Reuse toggleEdit/updateManager/calculateTotal but adapt calculateTotal for Modal context
    // Actually, calculateTotal logic needs to know WHERE to look.
    // If called from Modal inputs (which don't have closest('tr')), we should target Modal fields.

    async function calculateTotal(element) {
        // Check if we are in Modal or Table
        // The modal inputs invoke calculateTotal(). The table inputs invoke calculateTotal(this).
        // If element is undefined, it's likely from Modal oninput="calculateTotal()" (if I set it that way)
        // or I can pass 'modal' or something.

        let context = null;
        if (element && element.closest && element.closest('tr')) {
            context = element.closest('tr');
        } else {
            context = document.getElementById('entryForm');
        }

        const serviceSelect = context.querySelector('select[name="service"]');
        const quantityInput = context.querySelector('input[name="quantity"]');

        const additionalServiceSelect = context.querySelector('select[name="additional_service"]');
        const additionalServiceQuantityInput = context.querySelector('input[name="additional_service_quantity"]');

        const discountInput = context.querySelector('input[name="discount"]');
        const costInput = context.querySelector('input[name="cost"]');
        const costDisplay = document.getElementById('modal-total-display'); // Only in modal

        const dateInput = document.getElementById('journal-date');
        const date = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];

        if (!costInput) return;

        let total = 0;

        // Fetch Service Price
        if (serviceSelect && serviceSelect.value) {
            try {
                const res = await fetch(`/api/service-price/${serviceSelect.value}?date=${date}`);
                if (res.ok) {
                    const data = await res.json();
                    let price = data.price;
                    // Quantity
                    let qty = 1;
                    if (quantityInput) qty = parseInt(quantityInput.value) || 1;
                    // Is service price per item? Usually yes.
                    total += price * qty;
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Fetch Additional Service Price
        if (additionalServiceSelect && additionalServiceSelect.value) {
            try {
                const res = await fetch(`/api/additional-service-price/${additionalServiceSelect.value}?date=${date}`);
                if (res.ok) {
                    const data = await res.json();
                    let price = data.price;
                    let qty = 1;
                    if (additionalServiceQuantityInput) qty = parseInt(additionalServiceQuantityInput.value) || 1;
                    total += price * qty;
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Subtract Discount
        let discount = 0;
        if (discountInput && discountInput.value) {
            discount = parseFloat(discountInput.value) || 0;
        }
        total = total - discount;

        // Ensure not negative
        if (total < 0) total = 0;

        // Financial accounting logic: Only Cash and Card should have a cost in the Journal
        const paymentSelect = context.querySelector('select[name="payment_method_id"]');
        if (paymentSelect && paymentSelect.selectedIndex >= 0) {
            const paymentName = paymentSelect.options[paymentSelect.selectedIndex].text.toLowerCase().trim();
            const financialMethods = ['–Ω–∞–ª–∏—á–Ω—ã–µ', '–∫–∞—Ä—Ç–∞'];

            // If the selected method is NOT in financialMethods, set total to 0
            if (!financialMethods.includes(paymentName)) {
                total = 0;
            }
        }

        costInput.value = total;
        if (costDisplay) costDisplay.textContent = total.toFixed(2);
    }

    function updateSummaryTable(data, inputs) {
        // Find Summary Table
        const summaryTable = document.querySelector('.summary-section table tbody');
        if (!summaryTable) return; // Might not exist if hidden or something

        const cost = parseFloat(data['cost']) || 0;

        // Find Payment Method Name
        let paymentMethodName = "Unknown";
        // We have payment_method_id. We need the text from the select.
        // inputs is a NodeList. Let's find the select.
        let pmSelect = null;
        inputs.forEach(input => {
            if (input.name === 'payment_method_id') pmSelect = input;
        });

        if (pmSelect) {
            paymentMethodName = pmSelect.options[pmSelect.selectedIndex].text;
        }

        // Update Total Row (First Row)
        const totalRow = summaryTable.rows[0];
        if (totalRow) {
            // Count
            let countCell = totalRow.cells[1];
            let currentCount = parseInt(countCell.textContent) || 0;
            countCell.textContent = currentCount + 1;

            // Sum
            let sumCell = totalRow.cells[2];
            let currentSum = parseFloat(sumCell.textContent) || 0;
            sumCell.textContent = (currentSum + cost).toFixed(2);
        }

        // Update Specific Method Row
        // Rows: Total is 0. Others follow.
        // Iterate rows to find method name match
        let methodRow = null;
        for (let i = 1; i < summaryTable.rows.length; i++) {
            const row = summaryTable.rows[i];
            const nameCell = row.cells[0];
            if (nameCell.textContent.trim() === paymentMethodName.trim()) {
                methodRow = row;
                break;
            }
        }

        if (methodRow) {
            let countCell = methodRow.cells[1];
            let currentCount = parseInt(countCell.textContent) || 0;
            countCell.textContent = currentCount + 1;

            let sumCell = methodRow.cells[2];
            let currentSum = parseFloat(sumCell.textContent) || 0;
            sumCell.textContent = (currentSum + cost).toFixed(2);
        } else {
            // Create new row if not exists (though user asked for specific list, we usually pre-render all if >0. 
            // If strictly >0, we might need to create it. 
            // The python template renders ALL methods if count>0 OR True. 
            // So it should exist. But if somehow not, let's append.
            const newRow = summaryTable.insertRow();
            newRow.style.borderBottom = '1px solid #e5e7eb';

            const cell1 = newRow.insertCell(0);
            cell1.style.padding = '0.75rem 1rem';
            cell1.style.color = '#374151';
            cell1.textContent = paymentMethodName;

            const cell2 = newRow.insertCell(1);
            cell2.style.padding = '0.75rem 1rem';
            cell2.style.color = '#374151';
            cell2.textContent = '1';

            const cell3 = newRow.insertCell(2);
            cell3.style.padding = '0.75rem 1rem';
            cell3.style.color = '#374151';
            cell3.textContent = cost.toFixed(2);
        }
    }

    async function toggleEdit(btn) {
        const row = btn.closest('tr');
        const inputs = row.querySelectorAll('input, select');
        const isEditing = btn.textContent === 'üíæ'; // Currently saving?

        if (!isEditing) {
            // Enter Edit Mode
            inputs.forEach(input => {
                if (!input.classList.contains('journal-input-readonly')) {
                    input.disabled = false;
                }
            });
            btn.textContent = 'üíæ';
            btn.title = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
            btn.style.color = '#10b981';
        } else {
            // Save Changes
            const data = {};
            const id = row.getAttribute('data-id');

            let valid = true;
            inputs.forEach(input => {
                if (input.name && !input.disabled && input.name !== 'manager') {
                    data[input.name] = input.value;
                    if (input.hasAttribute('required') && !input.value) {
                        input.style.borderColor = 'red';
                        valid = false;
                    } else {
                        input.style.borderColor = '#e5e7eb';
                    }
                }
            });

            if (!valid) return;

            try {
                const response = await fetch(`/api/appointments/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    inputs.forEach(input => input.disabled = true);
                    btn.textContent = '‚úé';
                    btn.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
                    btn.style.color = '#6b7280';
                } else {
                    alert('Error saving changes');
                }
            } catch (e) {
                console.error(e);
                alert('Network error');
            }
        }
    }

    function updateManager(selectElement) {
        // Handle both Table (tr) and Modal (form) context
        // If in table: closest('tr')
        // If in modal: closest('form') or just find by name in form

        // Check context
        const row = selectElement.closest('tr');
        let managerInput;

        if (row) {
            managerInput = row.querySelector('input[name="manager"]');
        } else {
            // Try Modal
            const form = document.getElementById('entryForm');
            if (form) mgrInput = form.querySelector('input[name="manager"]'); // variable name mismatch risk
            managerInput = form ? form.querySelector('input[name="manager"]') : null;
        }

        const selectedOption = selectElement.options[selectElement.selectedIndex];
        // Check if selectedOption exists (it should)
        if (!selectedOption) return;

        const managerName = selectedOption.getAttribute('data-manager');

        if (managerInput) {
            managerInput.value = managerName || '';
        }
    }

    async function deleteEntry(btn) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;

        const row = btn.closest('tr');
        const id = row.getAttribute('data-id');

        try {
            const response = await fetch(`/api/appointments/${id}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            });

            if (response.ok) {
                // Remove row
                row.remove();
                updateRowNumbers();

                // Reload to ensure summary correctness
                window.location.reload();

            } else {
                const err = await response.json();
                alert('Error: ' + (err.error || 'Unknown error'));
            }
        } catch (e) {
            console.error(e);
            alert('Network error: ' + e.message);
        }
    }
</script>

<!-- Import Journal Modal -->
<div id="importJournalModal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content"
        style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 400px; border-radius: 8px;">
        <span class="close" onclick="document.getElementById('importJournalModal').style.display='none'"
            style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h2 style="margin-bottom: 20px; color: #1f2937;">–ò–º–ø–æ—Ä—Ç –≤ –∂—É—Ä–Ω–∞–ª</h2>
        <form action="{{ url_for('admin.import_journal') }}" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="mb-4" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">–¶–µ–Ω—Ç—Ä</label>
                <select name="center_id" class="journal-select" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–Ω—Ç—Ä --</option>
                    {% for center in centers %}
                    <option value="{{ center.id }}" {% if current_center_id==center.id %}selected{% endif %}>{{
                        center.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-4" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">–§–∞–π–ª (Excel)</label>
                <input type="file" name="file" accept=".xlsx" class="journal-input" required>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" onclick="document.getElementById('importJournalModal').style.display='none'"
                    class="btn"
                    style="background: #e5e7eb; padding: 0.5rem 1rem; border-radius: 4px; border: none; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary"
                    style="background: #10b981; color: white; padding: 0.5rem 1rem; border-radius: 4px; border: none; cursor: pointer;">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}