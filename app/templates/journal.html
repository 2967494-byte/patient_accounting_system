{% extends "app_base.html" %}

{% block head %}

<style>
    :root {
        --bg-color: #f3f4f6;
        --card-bg: #ffffff;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --border-color: #e5e7eb;
        --primary-color: #3b82f6;
        --primary-hover: #2563eb;
        --danger-color: #ef4444;
        --success-color: #10b981;
        --accent-color: #8b5cf6;
        --header-bg: rgba(255, 255, 255, 0.95);
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    body {
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-primary);
    }

    /* Container adjustments */
    .journal-container {
        padding: 1.5rem !important;
        gap: 1rem;
    }

    /* Filters Bar */
    .filters-bar {
        background: var(--card-bg);
        padding: 0.75rem 1rem;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .filter-label {
        font-weight: 500;
        font-size: 0.95rem;
        color: var(--text-secondary);
    }

    .filter-input {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.95rem;
        color: var(--text-primary);
        background-color: #f9fafb;
        transition: all 0.2s;
        outline: none;
    }

    .filter-input:focus,
    .filter-input:hover {
        background-color: #fff;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn-date-shortcut {
        background: #f9fafb;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-date-shortcut:hover {
        background: #fff;
        border-color: var(--text-secondary);
        color: var(--text-primary);
        box-shadow: var(--shadow-sm);
    }

    /* Action Buttons */
    .btn-action {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
        box-shadow: var(--shadow-sm);
    }

    .btn-primary {
        background-color: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--primary-hover);
        transform: translateY(-1px);
    }

    .btn-secondary {
        background-color: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #4b5563;
        transform: translateY(-1px);
    }

    .btn-success {
        background-color: var(--success-color);
        color: white;
    }

    .btn-success:hover {
        background-color: #059669;
        transform: translateY(-1px);
    }

    /* Table Container */
    #bottom-scroll-wrapper {
        background: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        /* For border radius */
    }

    /* Table Styles */
    .journal-table {
        width: 100%;
        border-collapse: separate;
        /* Allow spacing/radius */
        border-spacing: 0;
        font-size: 0.9rem;
    }

    .journal-table th {
        background: var(--header-bg);
        backdrop-filter: blur(8px);
        position: sticky;
        top: 0;
        z-index: 20;
        padding: 1rem 0.75rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--border-color);
    }

    .journal-table td {
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
        vertical-align: middle;
        transition: background 0.15s;
    }

    .journal-table tr:last-child td {
        border-bottom: none;
    }

    .journal-table tbody tr:hover td {
        background-color: #f9fafb;
    }

    .data-row {
        background: #fff;
    }

    /* Compact Inputs in Cells */
    .journal-input,
    .journal-select {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 6px;
        padding: 0.3rem 0.5rem;
        width: 100%;
        font-family: inherit;
        font-size: inherit;
        color: inherit;
        transition: all 0.2s;
    }

    .journal-input:focus,
    .journal-table tr:hover .journal-input,
    .journal-select:focus,
    .journal-table tr:hover .journal-select {
        background: #fff;
        border-color: var(--border-color);
    }

    .journal-input:focus,
    .journal-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    /* Specific Column Widths from user preference preserved/tuned */
    .journal-table th:first-child,
    .journal-table td:first-child {
        width: 50px;
        text-align: center;
        color: #9ca3af;
    }

    .journal-table th:nth-child(3),
    .journal-table td:nth-child(3) {
        width: 50px;
        text-align: center;
    }

    /* Child */

    /* Badges & Pills */
    .badge-services {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .service-pill {
        background: #eff6ff;
        color: #1e40af;
        padding: 0.25rem 0.6rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        border: 1px solid #bfdbfe;
    }

    .service-pill-qty {
        background: #dbeafe;
        color: #1e3a8a;
        border-radius: 50%;
        width: 1.25em;
        height: 1.25em;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75em;
        margin-left: 0.4rem;
        font-weight: 700;
    }

    .child-indicator {
        font-size: 1.2rem;
        filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1));
    }

    .action-btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
        color: var(--text-secondary);
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .action-btn-icon:hover {
        background: #f3f4f6;
        color: var(--primary-color);
    }

    .action-btn-icon.delete:hover {
        background: #fee2e2;
        color: var(--danger-color);
    }

    /* Scrollbars */
    .journal-table-wrapper::-webkit-scrollbar {
        height: 12px;
        width: 12px;
    }

    .journal-table-wrapper::-webkit-scrollbar-track {
        background: transparent;
    }

    .journal-table-wrapper::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 6px;
        border: 3px solid transparent;
        background-clip: content-box;
    }

    .journal-table-wrapper::-webkit-scrollbar-thumb:hover {
        background-color: #94a3b8;
    }

    /* Summary Section */
    .summary-section {
        margin-top: 2rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        align-items: start;
    }

    .summary-card {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        padding: 1rem;
    }

    .summary-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .summary-table-wrapper {
        overflow-x: auto;
    }

    .summary-table td {
        padding: 0.6rem 0.8rem;
        font-size: 0.875rem;
    }

    .summary-table th {
        padding: 0.6rem 0.8rem;
        position: static;
        /* Remove sticky from summary tables */
        background: transparent;
        border-bottom: 2px solid var(--border-color);
    }

    .summary-row-total {
        background-color: #f9fafb;
        font-weight: 600;
        border-top: 2px solid var(--border-color);
    }

    .summary-subhead td {
        background-color: #f3f4f6;
        font-weight: 500;
        color: var(--text-primary);
    }

    .summary-indent td:first-child {
        padding-left: 1.5rem;
        color: var(--text-secondary);
    }

    .text-right {
        text-align: right;
    }

    .text-center {
        text-align: center;
    }

    .font-medium {
        font-weight: 500;
    }

    .text-success {
        color: var(--success-color);
    }

    .text-muted {
        color: var(--text-secondary);
    }

    /* Action Dropdown Styles */
    .action-dropdown-menu {
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-shadow: var(--shadow-md);
        z-index: 50;
        min-width: 150px;
        display: none;
        padding: 0.25rem 0;
    }

    .action-dropdown-menu.show {
        display: block;
    }

    .action-dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        width: 100%;
        text-align: left;
        border: none;
        background: none;
        cursor: pointer;
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: background 0.2s;
    }

    .action-dropdown-item:hover {
        background-color: #f3f4f6;
    }

    .action-dropdown-item.delete {
        color: var(--danger-color);
    }

    .action-dropdown-item.delete:hover {
        background-color: #fee2e2;
    }
</style>
{% endblock %}

{% block content %}

<script>
    // Helper to auto-resize inputs for browsers without field-sizing support
    function adjustInputWidth(el) {
        if (CSS.supports('field-sizing', 'content')) return; // performant native handling
        // Simple heuristic: chars * approx width + padding
        // Or accurate: set width auto, measure? 
        // Better: use 'size' attribute as proxy for 'ch' width
        el.size = (el.value.length || 1) + 2;
    }

    function setJournalDate(relativeDays) {
        const dateInput = document.getElementById('journal-date');
        let date;

        if (dateInput.value) {
            date = new Date(dateInput.value);
        } else {
            date = new Date();
        }

        date.setDate(date.getDate() + relativeDays);

        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');

        dateInput.value = `${yyyy}-${mm}-${dd}`;
        dateInput.onchange(); // Trigger the reload
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initial resize of inputs
        document.querySelectorAll('.journal-input').forEach(adjustInputWidth);

        // Input auto-resize listener
        const table = document.querySelector('.journal-table');
        if (table) {
            table.addEventListener('input', (e) => {
                if (e.target.classList.contains('journal-input')) {
                    adjustInputWidth(e.target);
                    syncTopScrollWidth(); // Update scroll width if table grows
                }
            });
        }

        // --- Top Scrollbar Logic ---
        const topWrapper = document.getElementById('top-scroll-wrapper');
        const bottomWrapper = document.getElementById('bottom-scroll-wrapper');
        const topContent = document.getElementById('top-scroll-content');

        function syncTopScrollWidth() {
            if (bottomWrapper && topContent && table) {
                topContent.style.width = table.offsetWidth + 'px';
            }
        }

        // Sync scroll positions
        if (topWrapper && bottomWrapper) {
            topWrapper.addEventListener('scroll', () => {
                bottomWrapper.scrollLeft = topWrapper.scrollLeft;
            });
            bottomWrapper.addEventListener('scroll', () => {
                topWrapper.scrollLeft = bottomWrapper.scrollLeft;
            });
        }

        // Initial sync
        // Wait a tick for layout
        setTimeout(syncTopScrollWidth, 100);

        // Sync on window resize
        window.addEventListener('resize', syncTopScrollWidth);

        // Also sync whenever the table changes (using potential new inputs or loaded data)
        const observer = new ResizeObserver(syncTopScrollWidth);
        if (table) observer.observe(table);

        // Initialize Select2 in Journal Modal (Scoped)
        $('#entryModal .select2-enable').select2({
            dropdownParent: $('#entryModal'),
            width: '100%'
        });
    });
</script>

<script>
    // Action Menu Toggle
    // Action Menu Toggle
    function toggleActionMenu(btn, event) {
        event.stopPropagation();

        const menu = btn.nextElementSibling;
        const isAlreadyOpen = menu.classList.contains('show');

        // Close all menus
        document.querySelectorAll('.action-dropdown-menu.show').forEach(m => {
            m.classList.remove('show');
            // Reset inline styles
            m.style.position = '';
            m.style.top = '';
            m.style.left = '';
            m.style.right = '';
        });

        if (!isAlreadyOpen) {
            menu.classList.add('show');
            const rect = btn.getBoundingClientRect();

            // Use Fixed Positioning to escape overflow
            menu.style.position = 'fixed';
            menu.style.top = (rect.bottom + 2) + 'px';
            menu.style.right = 'auto';

            const menuRect = menu.getBoundingClientRect();
            menu.style.left = (rect.right - menuRect.width) + 'px';
            menu.style.zIndex = '9999';
        }
    }

    // Close menus on scroll to avoid detached floating elements
    document.addEventListener('scroll', function (event) {
        document.querySelectorAll('.action-dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
    }, true);

    // Close menus when clicking outside
    document.addEventListener('click', function (event) {
        if (!event.target.closest('.action-dropdown-menu') && !event.target.closest('.btn-icon')) {
            document.querySelectorAll('.action-dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
        }
    });

    // Close menu when an item is clicked
    document.addEventListener('click', function (event) {
        if (event.target.closest('.action-dropdown-item')) {
            const menu = event.target.closest('.action-dropdown-menu');
            if (menu) menu.classList.remove('show');
        }
    });
</script>

<div class="journal-container"
    style="padding: 1rem; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; flex: 1; overflow: hidden; height: 100%;">
    <!-- Filters -->
    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-group">
            <div style="display: flex; gap: 0.25rem;">
                <button type="button" onclick="setJournalDate(-2)" class="btn-date-shortcut" title="–ü–æ–∑–∞–≤—á–µ—Ä–∞">¬´
                    -2</button>
                <button type="button" onclick="setJournalDate(-1)" class="btn-date-shortcut" title="–í—á–µ—Ä–∞">¬´ -1</button>
            </div>
            <div class="input-with-icon" style="position: relative; display: flex; align-items: center;">
                <!-- <span style="position: absolute; left: 10px; color: #6b7280; font-size: 1.1rem;">üìÖ</span> -->
                <input type="date" id="journal-date" class="filter-input" value="{{ current_date }}"
                    onchange="window.location.href = `{{ url_for('main.journal') }}?center_id={{ current_center_id }}&date=${this.value}`">
            </div>
            <div style="display: flex; gap: 0.25rem;">
                <button type="button" onclick="setJournalDate(1)" class="btn-date-shortcut" title="–ó–∞–≤—Ç—Ä–∞">+1
                    ¬ª</button>
                <button type="button" onclick="setJournalDate(2)" class="btn-date-shortcut" title="–ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞">+2
                    ¬ª</button>
            </div>
            {% if lab_tech_name %}
            <span style="font-size: 0.9rem; color: #9ca3af; margin-left: 1rem;">–õ–∞–±–æ—Ä–∞–Ω—Ç: {{ lab_tech_name }}</span>
            {% endif %}
        </div>

        <div class="filter-group">
            <button class="btn-action btn-secondary" onclick="openAppointmentSelectionModal()">
                <span>üìã</span> –ò–∑ –∑–∞–ø–∏—Å–∏
            </button>
            <button class="btn-action btn-primary" onclick="openModal()">
                <span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å
            </button>
            {% if current_user.role == 'admin' %}
            <button onclick="document.getElementById('importJournalModal').style.display='block'"
                class="btn-action btn-success">
                <span>üì•</span> –ò–º–ø–æ—Ä—Ç
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Select Appointment Modal -->
    <!-- Select Appointment Modal -->
    <div id="select-appointment-modal" class="modal hidden"
        style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div class="modal-content"
            style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 600px; border-radius: 8px;">
            <div class="modal-header" style="overflow: hidden; margin-bottom: 1rem;">
                <span class="close" onclick="closeAppointmentSelectionModal()"
                    style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1;">&times;</span>
                <h2 style="margin: 0; color: #1f2937;">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å</h2>
            </div>
            <div class="modal-body">
                <table class="journal-table" style="width: 100%; table-layout: fixed; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #e5e7eb;">
                            <th style="width: 70px; padding: 0.5rem; text-align: left; color: #374151;">–í—Ä–µ–º—è</th>
                            <th style="width: 30%; padding: 0.5rem; text-align: left; color: #374151;">–ü–∞—Ü–∏–µ–Ω—Ç</th>
                            <th style="width: 40%; padding: 0.5rem; text-align: left; color: #374151;">–£—Å–ª—É–≥–∞</th>
                            <th style="width: 100px; padding: 0.5rem; text-align: center; color: #374151;">–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if todays_appointments %}
                        {% for appt in todays_appointments %}
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 0.5rem; color: #111827;">{{ appt.time }}</td>
                            <td style="padding: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #111827;"
                                title="{{ appt.patient_name }}">{{ appt.patient_name }}</td>
                            <td style="padding: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #111827;"
                                title="{% for s in appt.services %}{{ s.name }}{% if not loop.last %}, {% endif %}{% endfor %}">
                                {% for s in appt.services %}
                                {{ s.name }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </td>
                            <td style="padding: 0.5rem; text-align: center;">
                                <button class="btn btn-sm btn-primary"
                                    style="padding: 0.25rem 0.75rem; font-size: 0.875rem; background-color: #3b82f6; color: white; border: none; border-radius: 0.25rem; cursor: pointer;"
                                    onclick='openJournalFromAppointment({{ appt.to_dict()|tojson }})'>–í—ã–±—Ä–∞—Ç—å</button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align:center; padding: 1rem; color: #6b7280;">–ù–µ—Ç
                                –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit/Add Modal -->
    <!-- Custom Top Scrollbar -->
    <div id="top-scroll-wrapper" class="journal-table-wrapper"
        style="overflow-x: auto; overflow-y: hidden; height: 24px; min-height: 24px; margin-bottom: 0; border-bottom: none; border-bottom-left-radius: 0; border-bottom-right-radius: 0; flex: 0 0 auto;">
        <div id="top-scroll-content" style="height: 1px;"></div>
    </div>

    <div id="bottom-scroll-wrapper" class="journal-table-wrapper"
        style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; width: 100%; max-width: 100%; flex: 1; border-top-left-radius: 0; border-top-right-radius: 0;">
        <table class="journal-table" style="border-collapse: collapse;">
            <thead>
                <tr
                    style="background-color: #f3f4f6; text-align: left; position: sticky; top: 0; z-index: 10; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);">
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">‚Ññ</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–î–æ–≥–æ–≤–æ—Ä</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–†–µ–±</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–ö–ª–∏–Ω–∏–∫–∞</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–í—Ä–∞—á</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–ü–∞—Ü–∏–µ–Ω—Ç</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb; vertical-align: middle;">
                        –£—Å–ª—É–≥–∏
                    </th>

                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–û–ø–ª–∞—Ç–∞</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–°–∫–∏–¥–∫–∞</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–°—É–º–º–∞</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                    <th style="padding: 0.75rem 0.5rem; border-bottom: 2px solid #e5e7eb; text-align: center;">‚öôÔ∏è</th>
                </tr>
            </thead>
            <tbody id="journal-body">
                {% if appointments %}
                {% for appointment in appointments %}
                <tr class="data-row" data-id="{{ appointment.id }}"
                    style="border-bottom: 1px solid #e5e7eb; background: #fff;">
                    <td class="row-number" style="padding: 0.75rem 0.5rem; text-align: center; color: #6b7280;">{{
                        loop.index }}</td>
                    <td style="padding: 0.25rem 0.5rem; white-space: nowrap;">{{ appointment.contract_number or ''
                        }}
                    </td>
                    <td style="padding: 0.25rem 0.5rem; text-align: center;">
                        {% if appointment.is_child %}
                        <span style="color: #ed8936;">üë∂</span>
                        {% endif %}
                    </td>
                    <td style="padding: 0.25rem 0.5rem; white-space: nowrap;">{{ appointment.clinic.name if
                        appointment.clinic else '-' }}</td>
                    <td style="padding: 0.25rem 0.5rem; white-space: nowrap;">{{ appointment.doctor_rel.name if
                        appointment.doctor_rel else (appointment.doctor or '-') }}</td>
                    <td style="padding: 0.25rem 0.5rem; white-space: nowrap;">{{ appointment.patient_name }}</td>
                    <td style="padding: 0.25rem 0.5rem; white-space: normal; vertical-align: middle;">
                        <!-- Main Services -->
                        <div class="badge-services">
                            {% if appointment.service_associations %}
                            {% for assoc in appointment.service_associations %}
                            <div class="service-pill" title="{{ assoc.service.name }}">
                                <span>{{ assoc.service.name }}</span>
                                {% if assoc.quantity > 1 %}
                                <span class="service-pill-qty">{{ assoc.quantity }}</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% else %}
                            <!-- Fallback for legacy text service or if empty -->
                            {% if appointment.service %}
                            <div class="service-pill">
                                <span>{{ appointment.service }}</span>
                                {% if appointment.quantity > 1 %}
                                <span class="service-pill-qty">{{ appointment.quantity }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>

                        <!-- Additional Services (Separated) -->
                        {% if appointment.additional_service_associations %}
                        <div
                            style="margin-top: 4px; padding-top: 4px; border-top: 1px dashed #e5e7eb; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            {% for assoc in appointment.additional_service_associations %}
                            <div class="service-pill"
                                style="background: #fdf2f8; color: #be185d; border-color: #fbcfe8;"
                                title="{{ assoc.additional_service.name }}">
                                <span>+ {{ assoc.additional_service.name }}</span>
                                {% if assoc.quantity > 1 %}
                                <span class="service-pill-qty" style="background: #fce7f3; color: #be185d;">{{
                                    assoc.quantity }}</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </td>
                    <!-- Quantity Column Removed -->
                    <td style="padding: 0.25rem 0.5rem;">{{ appointment.payment_method.name if
                        appointment.payment_method else '-' }}</td>
                    <td style="padding: 0.25rem 0.5rem;">{{ appointment.discount or 0 }}</td>
                    <td style="padding: 0.75rem 0.5rem; font-weight: 500;">{{ "%.2f"|format(appointment.cost) }}
                    </td>
                    <td style="padding: 0.25rem 0.5rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis;"
                        title="{{ appointment.comment or '' }}">{{ appointment.comment or '' }}</td>
                    <td class="actions-cell"
                        style="padding: 0.5rem; text-align: center; white-space: nowrap; overflow: visible;">
                        <div style="position: relative; display: inline-block;">
                            <button class="btn-icon" onclick="toggleActionMenu(this, event)" title="–î–µ–π—Å—Ç–≤–∏—è"
                                style="font-size: 1.2rem; padding: 0.25rem 0.5rem;">‚ãÆ</button>
                            <div class="action-dropdown-menu">
                                <button class="action-dropdown-item"
                                    onclick="openEditJournalModal({{ appointment.id }})">
                                    <span>‚úé</span> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                                <button class="action-dropdown-item delete"
                                    onclick="deleteEntry(this, {{ appointment.id }})">
                                    <span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% endif %}

        </table>
    </div>

    <!-- Summary Table -->
    {% if summary_stats %}
    <div class="summary-section">
        <!-- Financial Table -->
        <div class="summary-card">
            <h3 class="summary-title">–§–∏–Ω–∞–Ω—Å—ã</h3>
            <div class="summary-table-wrapper">
                <table class="journal-table summary-table">
                    <thead>
                        <tr>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th class="text-right">–ö–æ–ª-–≤–æ</th>
                            <th class="text-right">–°—É–º–º–∞ (‚ÇΩ)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="summary-row-total">
                            <td class="font-medium">–í—Å–µ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</td>
                            <td class="text-right">{{ summary_stats.total_count }}</td>
                            <td class="text-right text-success">{{ "%.2f"|format(summary_stats.total_sum) }}</td>
                        </tr>
                        {% for method_name, stats in summary_stats.methods.items() %}
                        {% if stats.count > 0 or True %}
                        <tr>
                            <td>{{ method_name }}</td>
                            <td class="text-right">{{ stats.count }}</td>
                            <td class="text-right">{{ "%.2f"|format(stats.sum) }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Statistics Table -->
        <div class="summary-card">
            <h3 class="summary-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div class="summary-table-wrapper">
                <table class="journal-table summary-table">
                    <thead>
                        <tr>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–∑–∞ –¥–µ–Ω—å)</th>
                            <th class="text-right">–ö–æ–ª-–≤–æ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∑—Ä–æ—Å–ª—ã—Ö</td>
                            <td class="text-right">{{ summary_stats.adults_count }}</td>
                        </tr>
                        <tr>
                            <td>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π</td>
                            <td class="text-right">{{ summary_stats.children_count }}</td>
                        </tr>
                        <tr class="summary-subhead">
                            <td colspan="2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ö–¢: <span class="font-medium">{{ summary_stats.kt_count }}</span>
                            </td>
                        </tr>
                        <tr class="summary-indent">
                            <td>–í–∑—Ä–æ—Å–ª—ã—Ö</td>
                            <td class="text-right">{{ summary_stats.kt_adults }}</td>
                        </tr>
                        <tr class="summary-indent">
                            <td>–î–µ—Ç–µ–π</td>
                            <td class="text-right">{{ summary_stats.kt_children }}</td>
                        </tr>

                        <tr class="summary-subhead">
                            <td colspan="2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –û–ü–¢–ì: <span class="font-medium">{{ summary_stats.optg_count
                                    }}</span></td>
                        </tr>
                        <tr class="summary-indent">
                            <td>–í–∑—Ä–æ—Å–ª—ã—Ö</td>
                            <td class="text-right">{{ summary_stats.optg_adults }}</td>
                        </tr>
                        <tr class="summary-indent">
                            <td>–î–µ—Ç–µ–π</td>
                            <td class="text-right">{{ summary_stats.optg_children }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cashless Table -->
        <div class="summary-card">
            <h3 class="summary-title">–ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–µ</h3>
            <div class="summary-table-wrapper">
                <table class="journal-table summary-table">
                    <thead>
                        <tr>
                            <th>–ø.–ø.</th>
                            <th>–ö–ª–∏–Ω–∏–∫–∞</th>
                            <th>–§–∏–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞</th>
                            <th class="text-right">–°—É–º–º–∞ (‚ÇΩ)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set ns = namespace(count=0, total=0) %}
                        {% for appt in appointments %}
                        {% if appt.payment_method and ('–±–µ–∑–Ω–∞–ª' in appt.payment_method.name.lower()) %}
                        {% set ns.count = ns.count + 1 %}
                        {% set ns.total = ns.total + (appt.cost or 0) %}
                        <tr>
                            <td>{{ ns.count }}</td>
                            <td>{{ appt.clinic.name }}</td>
                            <td>{{ appt.patient_name }}</td>
                            <td class="text-right">{{ "%.2f"|format(appt.cost or 0) }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        {% if ns.count == 0 %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                        </tr>
                        {% else %}
                        <tr class="summary-row-total">
                            <td colspan="3" class="text-right">–ò—Ç–æ–≥–æ:</td>
                            <td class="text-right text-success">{{ "%.2f"|format(ns.total) }}</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal -->
<div id="entryModal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content"
        style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 600px; border-radius: 8px;">
        <span class="close" onclick="closeJournalModal()"
            style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h2 style="margin-bottom: 20px; color: #1f2937;">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h2>
        <form id="entryForm" style="display: flex; flex-direction: column; gap: 15px;">

            <!-- Row 1: Contract, Child Checkbox -->
            <div style="display: flex; gap: 15px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label
                        style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–î–æ–≥–æ–≤–æ—Ä</label>
                    <input type="text" name="contract_number" class="journal-input"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="‚Ññ" required>
                </div>
                <div style="flex: 0 0 auto; display: flex; align-items: center; padding-bottom: 0.6rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; user-select: none;">
                        <input type="checkbox" name="is_child" style="width: 1.2rem; height: 1.2rem; cursor: pointer;">
                        <span style="font-size: 0.95rem; color: #374151;">–†–µ–±–µ–Ω–æ–∫</span>
                    </label>
                </div>
            </div>

            <!-- Row 2: Patient Name (Full Width) -->
            <div>
                <label style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–ü–∞—Ü–∏–µ–Ω—Ç</label>
                <input type="text" name="patient_name" class="journal-input" placeholder="–§–ò–û" required>
            </div>

            <!-- Row 2: Clinic, Doctor -->
            <div style="display: flex; gap: 15px;">
                <div style="flex: 1;">
                    <label
                        style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–ö–ª–∏–Ω–∏–∫–∞</label>
                    <select name="clinic_id" class="journal-select select2-enable" required style="width: 100%;">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                        {% for clinic in clinics %}
                        <option value="{{ clinic.id }}">{{ clinic.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="flex: 1;">
                    <label style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–í—Ä–∞—á</label>
                    <select name="doctor_id" class="journal-select select2-enable" onchange="updateManager(this)"
                        required style="width: 100%;">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                        {% for doc in doctors %}
                        <option value="{{ doc.id }}" data-manager="{{ doc.manager or '' }}">{{ doc.name }}</option>
                        {% endfor %}
                    </select>
                    <!-- Hidden manager field for logic -->
                    <input type="hidden" name="manager">
                </div>
            </div>

            <!-- Row 3: Services (Dynamic) -->
            <div id="services-container">
                <div class="service-row" style="display: flex; gap: 15px; margin-bottom: 10px;">
                    <div style="flex: 2;">
                        <label
                            style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</label>
                        <select name="service" class="journal-select service-select" onchange="calculateTotal()">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                            {% for s in services %}
                            <option value="{{ s.id }}" data-price="{{ s.price }}">{{ s.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex: 1; display: flex; align-items: flex-end; gap: 5px;">
                        <div>
                            <label
                                style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–ö–æ–ª-–≤–æ</label>
                            <input type="number" name="quantity" value="1" class="journal-input service-qty"
                                style="text-align: center;" oninput="calculateTotal()" required>
                        </div>
                        <button type="button" onclick="addServiceRow()" class="btn"
                            style="background: #10b981; color: white; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-bottom: 2px; margin-left: 10px;">+</button>
                    </div>
                </div>
            </div>

            <!-- Row 4: Additional Services (Dynamic) -->
            <div id="additional-services-container">
                <div class="additional-service-row" style="display: flex; gap: 15px; margin-bottom: 10px;">
                    <div style="flex: 2;">
                        <label style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–î–æ–ø.
                            —É—Å–ª—É–≥–∞</label>
                        <select name="additional_service" class="journal-select add-service-select"
                            onchange="calculateTotal()">
                            <option value="">-- –ù–µ—Ç --</option>
                            {% for ads in additional_services %}
                            <option value="{{ ads.id }}" data-price="{{ ads.price }}">{{ ads.name }} - {{ ads.price
                                }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex: 1; display: flex; align-items: flex-end; gap: 5px;">
                        <div>
                            <label
                                style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–ö–æ–ª-–≤–æ</label>
                            <input type="number" name="additional_service_quantity" value="1"
                                class="journal-input add-service-qty" style="text-align: center;"
                                oninput="calculateTotal()">
                        </div>
                        <button type="button" onclick="addAdditionalServiceRow()" class="btn"
                            style="background: #10b981; color: white; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-bottom: 2px; margin-left: 10px;">+</button>
                    </div>
                </div>
            </div>

            <!-- Row 5: Payment, Discount -->
            <div style="display: flex; gap: 15px;">
                <div style="flex: 1;">
                    <label style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–û–ø–ª–∞—Ç–∞</label>
                    <select name="payment_method_id" class="journal-select" onchange="calculateTotal()" required>
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                        {% for method in payment_methods %}
                        <option value="{{ method.id }}">{{ method.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="flex: 1;">
                    <label style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–°–∫–∏–¥–∫–∞</label>
                    <input type="number" name="discount" value="0" class="journal-input" oninput="calculateTotal()"
                        required>
                </div>
            </div>

            <!-- Comment -->
            <div>
                <label
                    style="display: block; font-size: 0.9rem; margin-bottom: 4px; color: #4b5563;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <input type="text" name="comment" class="journal-input">
            </div>

            <!-- Row 6: SUM -->
            <div style="text-align: right; margin-top: 10px;">
                <div style="font-weight: bold; font-size: 1.25rem; color: #111827;">
                    –°–£–ú–ú–ê: <span id="modal-total-display">0.00</span> ‚ÇΩ
                    <input type="hidden" name="cost">
                </div>
            </div>

            <div style="margin-top: 20px; text-align: right;">
                <button type="button" onclick="handleSave()" class="btn btn-primary"
                    style="background-color: #10b981; color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* Journal Input Styles */
    .journal-input,
    .journal-select {
        width: 100%;
        padding: 0.4rem;
        border: 1px solid #e5e7eb;
        /* Subtle full border */
        border-radius: 4px;
        background: white;
        font-family: inherit;
        font-size: 0.95rem;
        outline: none;
        transition: border-color 0.2s;
    }

    .journal-input:focus,
    .journal-select:focus {
        border-color: #3b82f6;
    }

    /* Disabled state to look like text */
    .journal-input:disabled,
    .journal-select:disabled {
        border-color: transparent;
        background: transparent;
        color: #111827;
        padding: 0.4rem 0;
        /* Align with text */
        -webkit-appearance: none;
        appearance: none;
        opacity: 1;
        /* Override default opacity */
    }

    /* Remove arrow from disabled selects if possible, or just accept it. 
       Appearance none removes standard arrow in some browsers. */
    select:disabled {
        background-image: none;
    }

    .journal-input-readonly {
        width: 100%;
        border: none;
        background: transparent;
        font-family: inherit;
        font-size: 0.95rem;
        color: #374151;
        outline: none;
        pointer-events: none;
    }

    .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        color: #6b7280;
    }

    .btn-icon:hover {
        color: #3b82f6;
    }

    /* Hide number spinners */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        updateRowNumbers();
        // date change logic is inline
    });

    const CURRENT_CENTER_ID = "{{ current_center_id }}";

    function updateRowNumbers() {
        const rows = document.querySelectorAll('#journal-body tr');
        rows.forEach((row, index) => {
            const cell = row.querySelector('.row-number');
            if (cell) cell.textContent = index + 1;
        });
    }

    // Removed old createAddButton and updateAddButtons as we now have static + button in the input row

    function openJournalModal() {
        document.getElementById('entryModal').style.display = 'block';
        // Clear form
        document.getElementById('entryForm').reset();
        // Reset Select2
        $('#entryForm select.select2-enable').val(null).trigger('change');
        document.getElementById('modal-total-display').textContent = '0.00';
    }

    function closeJournalModal() {
        document.getElementById('entryModal').style.display = 'none';
    }

    // Close modal if outside click
    window.onclick = function (event) {
        const modal = document.getElementById('entryModal');
        if (event.target == modal) {
            closeJournalModal();
        }
    }

    async function openEditJournalModal(id) {
        try {
            const response = await fetch(`/api/appointments/${id}`);
            if (!response.ok) throw new Error('Failed to fetch');
            const appt = await response.json();

            const form = document.getElementById('entryForm');
            form.reset();

            // Set ID
            let idInput = form.querySelector('input[name="id"]');
            if (!idInput) {
                // Create if missing (it's missing in current HTML)
                idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.name = 'id';
                form.appendChild(idInput);
            }
            idInput.value = appt.id;

            // Set Title
            const title = document.querySelector('#entryModal h2');
            if (title) title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏';

            // Common Fields
            if (document.getElementById('journal-date')) {
                // Assuming journal-date is filter, but we might want to edit the date of appointment?
                // The Modal currently doesn't have a Date input! It relies on `journal-date` (filter) for NEW entries.
                // For EDIT, we should probably add a Date input to the modal or use the filter date if it's the same?
                // User might want to MOVE the appointment.
                // `entryModal` in `journal.html` currently lacks a Date field (it reads `journal-date` in handleSave).
                // If we want to move it, we need a Date field in the modal.
                // Let's add a Date field to the modal dynamically or check if it exists.
                // Looking at read code (Step 249+): `entryForm` starts at line 547. 
                // Row 1: Contract, Child. Row 2: Patient. No Date!
                // I should add a Date field to the modal HTML.
            }

            // Populate Fields
            form.querySelector('input[name="contract_number"]').value = appt.contract_number || '';
            form.querySelector('input[name="is_child"]').checked = appt.is_child || false;
            form.querySelector('input[name="patient_name"]').value = appt.patient_name || '';

            const clinicSel = form.querySelector('select[name="clinic_id"]');
            if (clinicSel) {
                $(clinicSel).val(appt.clinic_id || '').trigger('change');
            }

            const doctorSel = form.querySelector('select[name="doctor_id"]');
            if (doctorSel) {
                $(doctorSel).val(appt.doctor_id || '').trigger('change');
                // Update manager hidden field
                updateManager(doctorSel);
            }

            const paymentSel = form.querySelector('select[name="payment_method_id"]');
            if (paymentSel) paymentSel.value = appt.payment_method_id || '';

            form.querySelector('input[name="discount"]').value = appt.discount || 0;
            form.querySelector('input[name="comment"]').value = appt.comment || '';

            // Services
            const servicesContainer = document.getElementById('services-container');
            // Clear all but first row? Or clear all and rebuild?
            // Existing logic `addServiceRow` clones first row.
            // If we clear all, we lose the template.
            // So keep one, reset it, then clone.

            // Remove extra rows
            while (servicesContainer.children.length > 1) {
                servicesContainer.lastElementChild.remove();
            }

            const firstRow = servicesContainer.firstElementChild;

            // Handle Services (Detailed list with quantities)
            if (appt.services && appt.services.length > 0) {
                appt.services.forEach((s, index) => {
                    let row = index === 0 ? firstRow : null;
                    if (!row) {
                        addServiceRow();
                        row = servicesContainer.lastElementChild;
                    }
                    const sel = row.querySelector('.service-select');
                    if (sel) sel.value = s.id;
                    const qty = row.querySelector('.service-qty');
                    if (qty) qty.value = s.quantity || 1;
                });
            } else if (appt.services_ids && appt.services_ids.length > 0) {
                // Fallback for simple ID list
                appt.services_ids.forEach((sid, index) => {
                    let row = index === 0 ? firstRow : null;
                    if (!row) {
                        addServiceRow();
                        row = servicesContainer.lastElementChild;
                    }
                    const sel = row.querySelector('.service-select');
                    if (sel) sel.value = sid;
                    const qty = row.querySelector('.service-qty');
                    if (qty) qty.value = 1; // Default
                });
            } else {
                // Reset first row
                firstRow.querySelector('select').selectedIndex = 0;
                firstRow.querySelector('input').value = 1;
            }

            // Additional Services
            const addContainer = document.getElementById('additional-services-container');
            while (addContainer.children.length > 1) {
                addContainer.lastElementChild.remove();
            }
            const firstAddRow = addContainer.firstElementChild;

            // Handle Additional Services
            if (appt.additional_services && appt.additional_services.length > 0) {
                appt.additional_services.forEach((s, index) => {
                    let row = index === 0 ? firstAddRow : null;
                    if (!row) {
                        addAdditionalServiceRow();
                        row = addContainer.lastElementChild;
                    }
                    const sel = row.querySelector('.add-service-select');
                    if (sel) sel.value = s.id;
                    const qty = row.querySelector('.add-service-qty');
                    if (qty) qty.value = s.quantity || 1;
                });
            } else if (appt.additional_services_ids && appt.additional_services_ids.length > 0) {
                appt.additional_services_ids.forEach((asid, index) => {
                    let row = index === 0 ? firstAddRow : null;
                    if (!row) {
                        addAdditionalServiceRow();
                        row = addContainer.lastElementChild;
                    }
                    const sel = row.querySelector('.add-service-select');
                    if (sel) sel.value = asid;
                    const qty = row.querySelector('.add-service-qty');
                    if (qty) qty.value = 1;
                });
            } else {
                firstAddRow.querySelector('select').selectedIndex = 0;
                firstAddRow.querySelector('input').value = 1;
            }

            // Recalculate Total
            calculateTotal(form); // Pass form as context? existing calculateTotal uses element.closest 
            // calculateTotal logic 2 handles Modal Context by selecting .service-row globally.
            // Wait, calculateTotal logic 2 (Line 1157 in Step 248) finds ALL .service-row. 
            // It sums them up.
            calculateTotal();

            // Show Modal
            document.getElementById('entryModal').style.display = 'block';

        } catch (e) {
            console.error(e);
            alert('Error fetching appointment');
        }
    }

    async function handleSave() {
        const form = document.getElementById('entryForm');
        // Check for ID
        const idInput = form.querySelector('input[name="id"]');
        const id = idInput ? idInput.value : null;

        // --- READ COMMON DATA ---
        const commonData = {};

        // Date Logic: If editing, we might want to keep existing date OR allow change.
        // Current modal has NO date input. It uses 'journal-date' filter value.
        // If we are editing, we should probably stick to the ID's date unless we add a field.
        // For now, let's assume date is NOT editable in this modal variant or we add it.
        // If I add it, I need to look for it.
        const modalDateInput = form.querySelector('input[name="date"]');
        if (modalDateInput) {
            commonData['date'] = modalDateInput.value;
        } else {
            // Fallback to journal filter date (dangerous for Edit if they look at different day?)
            // But usually you edit what you see.
            const dateInput = document.getElementById('journal-date');
            commonData['date'] = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
        }

        const urlParams = new URLSearchParams(window.location.search);
        let centerId = urlParams.get('center_id');
        if (!centerId) centerId = CURRENT_CENTER_ID;
        if (centerId && centerId !== 'None') commonData['center_id'] = centerId;

        // Time: If editing, keep original? Modal has no Time field.
        // If New, use current time.
        // We rely on backend or default?
        // If ID exists, we probably shouldn't overwrite time unless UI allows.
        // Let's check api.py `update_appointment`. If `time` not in data, it keeps existing.
        // So for EDIT, we just ommit `time` if we don't have input.
        if (!id) {
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            commonData['time'] = timeString;
        }

        // Collect fields that are single-entry
        ['contract_number', 'is_child', 'patient_name', 'clinic_id', 'doctor_id', 'payment_method_id', 'discount', 'comment', 'manager'].forEach(name => {
            const input = form.querySelector(`[name="${name}"]`);
            if (input) {
                if (input.type === 'checkbox') commonData[name] = input.checked;
                else if (input.value) commonData[name] = input.value;
            }
        });

        // --- VALIDATION (Basic) ---
        if (!commonData['patient_name'] || !commonData['clinic_id'] || !commonData['doctor_id']) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–ü–∞—Ü–∏–µ–Ω—Ç, –ö–ª–∏–Ω–∏–∫–∞, –í—Ä–∞—á)");
            return;
        }

        // --- GATHER SERVICES (Main) ---
        const serviceContainer = document.getElementById('services-container');
        const serviceRows = serviceContainer.querySelectorAll('.service-row');
        const serviceIds = [];

        serviceRows.forEach(row => {
            const sel = row.querySelector('.service-select');
            if (sel && sel.value) serviceIds.push(sel.value);
        });

        // --- GATHER ADDITIONAL SERVICES ---
        const addSvcContainer = document.getElementById('additional-services-container');
        const addSvcRows = addSvcContainer.querySelectorAll('.additional-service-row');
        const addSvcIds = [];

        addSvcRows.forEach(row => {
            const sel = row.querySelector('.add-service-select');
            if (sel && sel.value) addSvcIds.push(sel.value);
        });

        if (serviceIds.length === 0 && addSvcIds.length === 0) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –¥–æ–ø. —É—Å–ª—É–≥—É");
            return;
        }

        // --- CONSTRUCT PAYLOAD ---
        const payload = { ...commonData };
        payload['ignore_overlap'] = true; // Bypass calendar conflict checks for manual journal entries

        // Build services_data (New format with quantity)
        const servicesData = [];
        serviceRows.forEach(row => {
            const sel = row.querySelector('.service-select');
            const qtyInput = row.querySelector('.service-qty');
            if (sel && sel.value) {
                servicesData.push({
                    id: parseInt(sel.value),
                    quantity: parseInt(qtyInput ? qtyInput.value : 1)
                });
            }
        });
        payload['services_data'] = servicesData;
        payload['services_ids'] = servicesData.map(s => s.id); // Compat

        // Build additional_services_data
        const addServicesData = [];
        addSvcRows.forEach(row => {
            const sel = row.querySelector('.add-service-select');
            const qtyInput = row.querySelector('.add-service-qty');
            if (sel && sel.value) {
                addServicesData.push({
                    id: parseInt(sel.value),
                    quantity: parseInt(qtyInput ? qtyInput.value : 1)
                });
            }
        });
        payload['additional_services_data'] = addServicesData;
        payload['additional_services_ids'] = addServicesData.map(s => s.id); // Compat

        // Quantity fields
        // Capture quantity from the FIRST service row (limitation: DB supports only one quantity field per appointment)
        const firstServiceRow = document.querySelector('#services-container .service-row');
        if (firstServiceRow) {
            const qtyInput = firstServiceRow.querySelector('.service-qty');
            payload['quantity'] = parseInt(qtyInput ? qtyInput.value : 1);
        } else {
            payload['quantity'] = 1;
        }

        const firstAddRow = document.querySelector('#additional-services-container .additional-service-row');
        if (firstAddRow) {
            const asQtyInput = firstAddRow.querySelector('.add-service-qty');
            payload['additional_service_quantity'] = parseInt(asQtyInput ? asQtyInput.value : 1);
        } else {
            payload['additional_service_quantity'] = 1;
        }

        // Calculate Cost
        let totalCost = 0;
        serviceRows.forEach(row => {
            const sel = row.querySelector('.service-select');
            const qtyInput = row.querySelector('.service-qty');
            if (sel && sel.value) {
                const price = parseFloat(sel.options[sel.selectedIndex].getAttribute('data-price')) || 0;
                const qty = parseInt(qtyInput ? qtyInput.value : 1);
                totalCost += price * qty;
            }
        });
        addSvcRows.forEach(row => {
            const asSel = row.querySelector('.add-service-select');
            const asQtyInput = row.querySelector('.add-service-qty');
            if (asSel && asSel.value) {
                const asPrice = parseFloat(asSel.options[asSel.selectedIndex].getAttribute('data-price')) || 0;
                const asQty = parseInt(asQtyInput ? asQtyInput.value : 1);
                totalCost += asPrice * asQty;
            }
        });

        // Apply discount
        if (payload['discount']) {
            totalCost -= parseFloat(payload['discount']);
        }

        if (totalCost < 0) totalCost = 0;
        payload['cost'] = totalCost;

        try {
            const url = id ? `/api/appointments/${id}` : '/api/appointments';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                window.location.reload();
            } else {
                const err = await response.json();
                alert('Error: ' + (err.error || 'Unknown error'));
            }
        } catch (e) {
            console.error(e);
            alert('Network error: ' + e.message);
        }
    }

    function addServiceRow() {
        const container = document.getElementById('services-container');
        const firstRow = container.querySelector('.service-row');
        const newRow = firstRow.cloneNode(true);

        // Reset values
        newRow.querySelector('select').selectedIndex = 0;
        newRow.querySelector('input').value = 1;

        // Change + button to - button
        const btn = newRow.querySelector('button');
        btn.textContent = '-';
        btn.style.backgroundColor = '#ef4444'; // Red
        btn.onclick = function () { this.closest('.service-row').remove(); calculateTotal(); };

        container.appendChild(newRow);
    }

    function addAdditionalServiceRow() {
        const container = document.getElementById('additional-services-container');
        const firstRow = container.querySelector('.additional-service-row');
        const newRow = firstRow.cloneNode(true);

        // Reset values
        newRow.querySelector('select').selectedIndex = 0;
        newRow.querySelector('input').value = 1;

        // Change + to -
        const btn = newRow.querySelector('button');
        btn.textContent = '-';
        btn.style.backgroundColor = '#ef4444';
        btn.onclick = function () { this.closest('.additional-service-row').remove(); calculateTotal(); };

        container.appendChild(newRow);
    }

    function calculateTotal() {
        let total = 0;

        // Services
        document.querySelectorAll('.service-row').forEach(row => {
            const sel = row.querySelector('.service-select');
            const qty = row.querySelector('.service-qty').value || 0;
            if (sel && sel.value) {
                const price = parseFloat(sel.options[sel.selectedIndex].getAttribute('data-price')) || 0;
                total += price * qty;
            }
        });

        // Add Services
        document.querySelectorAll('.additional-service-row').forEach(row => {
            const sel = row.querySelector('.add-service-select');
            const qty = row.querySelector('.add-service-qty').value || 0;
            if (sel && sel.value) {
                const price = parseFloat(sel.options[sel.selectedIndex].getAttribute('data-price')) || 0;
                total += price * qty;
            }
        });

        // Discount
        const discountInput = document.querySelector('input[name="discount"]');
        if (discountInput) {
            total -= (parseFloat(discountInput.value) || 0);
        }

        if (total < 0) total = 0;
        document.getElementById('modal-total-display').textContent = total.toFixed(2);
    }

    function addNewRow(data) {
        // Since we removed the "Input Row Template", we need to create a read-only row 
        // essentially similar to the "saved-row" in the loop.
        // We can reload page or append HTML. Appending is smoother.

        const tbody = document.getElementById('journal-body');
        const tr = document.createElement('tr');
        tr.className = 'data-row input-row saved-row';
        tr.style.borderBottom = '1px solid #e5e7eb';
        tr.style.background = '#fff';
        tr.setAttribute('data-id', data.id);

        // We need to fetch names for IDs (Clinic, Doctor, Service, etc.) 
        // BUT `data` returned from API (to_dict) usually has names? 
        // Let's check `to_dict` in Appointment model.
        // It returns minimal info? 
        // `to_dict`: id, patient_name, patient_phone, doctor, service, date, time...
        // It might not have everything.
        // However, we can use the text from the Select elements in the form!

        const form = document.getElementById('entryForm');

        const getSelectText = (name) => {
            const sel = form.querySelector(`select[name="${name}"]`);
            return sel && sel.selectedIndex >= 0 ? sel.options[sel.selectedIndex].text : '';
        };

        // Check if is_child
        const isChild = form.querySelector('input[name="is_child"]').checked;

        const contract = form.querySelector('input[name="contract_number"]').value || '';
        const clinic = getSelectText('clinic_id');
        const doctor = getSelectText('doctor_id');
        const patient = form.querySelector('input[name="patient_name"]').value;
        const service = getSelectText('service');
        const quantity = form.querySelector('input[name="quantity"]').value;
        const addQuantity = form.querySelector('input[name="additional_service_quantity"]').value || 1;

        // Add Service text logic
        const addServiceSel = form.querySelector(`select[name="additional_service"]`);
        const addService = addServiceSel.value ? addServiceSel.options[addServiceSel.selectedIndex].text : '';

        const payment = getSelectText('payment_method_id');
        const discount = form.querySelector('input[name="discount"]').value;
        const cost = form.querySelector('input[name="cost"]').value;
        const comment = form.querySelector('input[name="comment"]').value;
        const manager = form.querySelector('input[name="manager"]').value;

        // Construct Row HTML
        // Note: Inline styles should match existing rows
        tr.innerHTML = `
            <td class="row-number" style="padding: 0.75rem 0.5rem; text-align: center; color: #6b7280;"></td>
            <td style="padding: 0.25rem 0.5rem; white-space: nowrap;"><input type="text" value="${contract}" class="journal-input" disabled></td>
            <td style="padding: 0.25rem 0.5rem; text-align: center;"><input type="checkbox" ${isChild ? 'checked' : ''} disabled style="width: 1.1rem; height: 1.1rem;"></td>
            <td style="padding: 0.25rem 0.5rem; white-space: nowrap;"><input type="text" value="${clinic}" class="journal-input" disabled></td>
            <td style="padding: 0.25rem 0.5rem; white-space: nowrap;"><input type="text" value="${doctor}" class="journal-input" disabled></td>
            <td style="padding: 0.25rem 0.5rem; white-space: nowrap;"><input type="text" value="${patient}" class="journal-input" disabled></td>
            <td style="padding: 0.25rem 0.5rem; white-space: normal;">
                <div style="font-weight: 500; color: #111827; display: flex; justify-content: space-between; align-items: center;">
                    <span>${service}</span>
                    <span style="font-size: 0.9em; color: #374151; margin-left: 8px; background: #f3f4f6; padding: 1px 6px; border-radius: 4px;">x${quantity}</span>
                </div>
                ${addService ? `<div style="margin-top: 4px; padding-top: 4px; border-top: 1px dashed #e5e7eb; font-size: 0.85em; color: #4b5563; display: flex; justify-content: space-between; align-items: center;">
                    <span>+ ${addService}</span>
                    <span style="font-size: 0.9em; color: #6b7280; margin-left: 8px;">x${addQuantity}</span>
                </div>` : ''}
            </td>
            <!-- Quantity Cell Removed -->
            <td style="padding: 0.25rem 0.5rem;"><input type="text" value="${payment}" class="journal-input" disabled></td>
            <td style="padding: 0.25rem 0.5rem;"><input type="number" value="${discount}" class="journal-input" disabled></td>
            <td style="padding: 0.75rem 0.5rem;"><input type="number" value="${cost}" class="journal-input-readonly" readonly></td>
            <td style="padding: 0.25rem 0.5rem;"><input type="text" value="${comment}" class="journal-input" disabled></td>
            <td style="padding: 0.75rem 0.5rem;">{{ current_user.username }}</td>
            <td class="actions-cell" style="padding: 0.5rem; text-align: center; white-space: nowrap; overflow: visible;">
                <div style="position: relative; display: inline-block;">
                    <button class="btn-icon" onclick="toggleActionMenu(this, event)" title="–î–µ–π—Å—Ç–≤–∏—è"
                        style="font-size: 1.2rem; padding: 0.25rem 0.5rem;">‚ãÆ</button>
                    <div class="action-dropdown-menu">
                        <button class="action-dropdown-item" onclick="openEditJournalModal(${data.id})">
                            <span>‚úé</span> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button class="action-dropdown-item delete" onclick="deleteEntry(this, ${data.id})">
                            <span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            </td>
        `;

        // Insert at top? usually journals are chronological. 
        // Existing loop: order_by(Appointment.time.desc()). 
        // So newest first.
        if (tbody.firstChild) {
            tbody.appendChild(tr);
        } else {
            tbody.appendChild(tr);
        }

        updateRowNumbers();
    }

    // Reuse toggleEdit/updateManager/calculateTotal but adapt calculateTotal for Modal context
    // Actually, calculateTotal logic needs to know WHERE to look.
    // If called from Modal inputs (which don't have closest('tr')), we should target Modal fields.

    async function calculateTotal(element) {
        // --- 1. Table Edit Context (Single Row, Async API) ---
        if (element && element.closest && element.closest('tr')) {
            const context = element.closest('tr');

            const serviceSelect = context.querySelector('select[name="service"]');
            const quantityInput = context.querySelector('input[name="quantity"]');
            const additionalServiceSelect = context.querySelector('select[name="additional_service"]');
            const additionalServiceQuantityInput = context.querySelector('input[name="additional_service_quantity"]');
            const discountInput = context.querySelector('input[name="discount"]');
            const costInput = context.querySelector('input[name="cost"]');
            const dateInput = document.getElementById('journal-date');
            const date = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];

            if (!costInput) return;

            let total = 0;

            // Fetch Service Price
            if (serviceSelect && serviceSelect.value) {
                try {
                    const res = await fetch(`/api/service-price/${serviceSelect.value}?date=${date}`);
                    if (res.ok) {
                        const data = await res.json();
                        let qty = 1;
                        if (quantityInput) qty = parseInt(quantityInput.value) || 1;
                        total += data.price * qty;
                    }
                } catch (e) { console.error(e); }
            }

            // Fetch Additional Service Price
            if (additionalServiceSelect && additionalServiceSelect.value) {
                try {
                    const res = await fetch(`/api/additional-service-price/${additionalServiceSelect.value}?date=${date}`);
                    if (res.ok) {
                        const data = await res.json();
                        let qty = 1;
                        if (additionalServiceQuantityInput) qty = parseInt(additionalServiceQuantityInput.value) || 1;
                        total += data.price * qty;
                    }
                } catch (e) { console.error(e); }
            }

            // Subtract Discount
            if (discountInput && discountInput.value) {
                total -= (parseFloat(discountInput.value) || 0);
            }

            // Payment method check
            const paymentSelect = context.querySelector('select[name="payment_method_id"]');
            if (paymentSelect && paymentSelect.selectedIndex >= 0) {
                const paymentName = paymentSelect.options[paymentSelect.selectedIndex].text.toLowerCase().trim();
                const financialMethods = ['–Ω–∞–ª–∏—á–Ω—ã–µ', '–∫–∞—Ä—Ç–∞'];
                if (!financialMethods.includes(paymentName)) total = 0;
            }

            if (total < 0) total = 0;
            costInput.value = total;
            return;
        }

        // --- 2. Modal Context (Multi-Row, Sync Data Attributes) ---
        // This handles the new "Batch" entry form
        let total = 0;

        // Sum Services
        const serviceRows = document.querySelectorAll('.service-row');
        serviceRows.forEach(row => {
            const sel = row.querySelector('.service-select');
            const qtyInput = row.querySelector('.service-qty');
            if (sel && sel.value) {
                const price = parseFloat(sel.options[sel.selectedIndex].getAttribute('data-price')) || 0;
                const qty = parseInt(qtyInput.value) || 0;
                total += price * qty;
            }
        });

        // Sum Additional Services
        const addSvcRows = document.querySelectorAll('.additional-service-row');
        addSvcRows.forEach(row => {
            const sel = row.querySelector('.add-service-select');
            const qtyInput = row.querySelector('.add-service-qty');
            if (sel && sel.value) {
                const price = parseFloat(sel.options[sel.selectedIndex].getAttribute('data-price')) || 0;
                const qty = parseInt(qtyInput.value) || 0;
                total += price * qty;
            }
        });

        // Discount
        const discountInput = document.querySelector('#entryForm input[name="discount"]');
        if (discountInput) {
            total -= (parseFloat(discountInput.value) || 0);
        }

        // Payment Method Check (Modal)
        const paymentSelect = document.querySelector('#entryForm select[name="payment_method_id"]');
        if (paymentSelect && paymentSelect.selectedIndex >= 0) {
            const paymentName = paymentSelect.options[paymentSelect.selectedIndex].text.toLowerCase().trim();
            const financialMethods = ['–Ω–∞–ª–∏—á–Ω—ã–µ', '–∫–∞—Ä—Ç–∞'];
            if (!financialMethods.includes(paymentName)) total = 0;
        }

        if (total < 0) total = 0;

        let display = document.getElementById('modal-total-display');
        if (display) display.textContent = total.toFixed(2);
    }

    function updateSummaryTable(data, inputs) {
        // Find Summary Table
        const summaryTable = document.querySelector('.summary-section table tbody');
        if (!summaryTable) return; // Might not exist if hidden or something

        const cost = parseFloat(data['cost']) || 0;

        // Find Payment Method Name
        let paymentMethodName = "Unknown";
        // We have payment_method_id. We need the text from the select.
        // inputs is a NodeList. Let's find the select.
        let pmSelect = null;
        inputs.forEach(input => {
            if (input.name === 'payment_method_id') pmSelect = input;
        });

        if (pmSelect) {
            paymentMethodName = pmSelect.options[pmSelect.selectedIndex].text;
        }

        // Update Total Row (First Row)
        const totalRow = summaryTable.rows[0];
        if (totalRow) {
            // Count
            let countCell = totalRow.cells[1];
            let currentCount = parseInt(countCell.textContent) || 0;
            countCell.textContent = currentCount + 1;

            // Sum
            let sumCell = totalRow.cells[2];
            let currentSum = parseFloat(sumCell.textContent) || 0;
            sumCell.textContent = (currentSum + cost).toFixed(2);
        }

        // Update Specific Method Row
        // Rows: Total is 0. Others follow.
        // Iterate rows to find method name match
        let methodRow = null;
        for (let i = 1; i < summaryTable.rows.length; i++) {
            const row = summaryTable.rows[i];
            const nameCell = row.cells[0];
            if (nameCell.textContent.trim() === paymentMethodName.trim()) {
                methodRow = row;
                break;
            }
        }

        if (methodRow) {
            let countCell = methodRow.cells[1];
            let currentCount = parseInt(countCell.textContent) || 0;
            countCell.textContent = currentCount + 1;

            let sumCell = methodRow.cells[2];
            let currentSum = parseFloat(sumCell.textContent) || 0;
            sumCell.textContent = (currentSum + cost).toFixed(2);
        } else {
            // Create new row if not exists (though user asked for specific list, we usually pre-render all if >0. 
            // If strictly >0, we might need to create it. 
            // The python template renders ALL methods if count>0 OR True. 
            // So it should exist. But if somehow not, let's append.
            const newRow = summaryTable.insertRow();
            newRow.style.borderBottom = '1px solid #e5e7eb';

            const cell1 = newRow.insertCell(0);
            cell1.style.padding = '0.75rem 1rem';
            cell1.style.color = '#374151';
            cell1.textContent = paymentMethodName;

            const cell2 = newRow.insertCell(1);
            cell2.style.padding = '0.75rem 1rem';
            cell2.style.color = '#374151';
            cell2.textContent = '1';

            const cell3 = newRow.insertCell(2);
            cell3.style.padding = '0.75rem 1rem';
            cell3.style.color = '#374151';
            cell3.textContent = cost.toFixed(2);
        }
    }

    async function toggleEdit(btn) {
        const row = btn.closest('tr');
        const inputs = row.querySelectorAll('input, select');
        const viewModes = row.querySelectorAll('.view-mode');
        const editModes = row.querySelectorAll('.edit-mode');
        const isEditing = btn.textContent === 'üíæ'; // Currently saving?

        if (!isEditing) {
            // Enter Edit Mode
            inputs.forEach(input => {
                if (!input.classList.contains('journal-input-readonly')) {
                    input.disabled = false;
                }
            });
            // Show edit widgets, hide view widgets
            viewModes.forEach(el => el.style.display = 'none');
            editModes.forEach(el => el.style.display = 'inline-block'); // or block

            btn.textContent = 'üíæ';
            btn.title = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
            btn.style.color = '#10b981';
        } else {
            // Save Changes
            const data = {};
            const id = row.getAttribute('data-id');

            let valid = true;
            inputs.forEach(input => {
                if (input.name && !input.disabled && input.name !== 'manager') {
                    // Start of simplistic generic collection. 
                    // Note: This won't capture multiple additional services if we don't have inputs for them.
                    // It only captures the 'select' value (the first one).
                    data[input.name] = input.value;
                    if (input.hasAttribute('required') && !input.value) {
                        input.style.borderColor = 'red';
                        valid = false;
                    } else {
                        input.style.borderColor = '#e5e7eb';
                    }
                }
            });

            if (!valid) return;

            data['ignore_overlap'] = true; // Bypass overlap check for journal edits

            try {
                const response = await fetch(`/api/appointments/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    inputs.forEach(input => input.disabled = true);
                    // Revert display
                    viewModes.forEach(el => el.style.display = 'block');
                    editModes.forEach(el => el.style.display = 'none');

                    // Ideally we should update the View Mode text with the new values?
                    // Reloading page is safest for complex M2M updates until we implement a better JS updater.
                    window.location.reload();

                    /* 
                    btn.textContent = '‚úé';
                    btn.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
                    btn.style.color = '#6b7280'; 
                    */
                } else {
                    alert('Error saving changes');
                }
            } catch (e) {
                console.error(e);
                alert('Network error');
            }
        }
    }

    function updateManager(selectElement) {
        // Handle both Table (tr) and Modal (form) context
        // If in table: closest('tr')
        // If in modal: closest('form') or just find by name in form

        // Check context
        const row = selectElement.closest('tr');
        let managerInput;

        if (row) {
            managerInput = row.querySelector('input[name="manager"]');
        } else {
            // Try Modal
            const form = document.getElementById('entryForm');
            if (form) mgrInput = form.querySelector('input[name="manager"]'); // variable name mismatch risk
            managerInput = form ? form.querySelector('input[name="manager"]') : null;
        }

        const selectedOption = selectElement.options[selectElement.selectedIndex];
        // Check if selectedOption exists (it should)
        if (!selectedOption) return;

        const managerName = selectedOption.getAttribute('data-manager');

        if (managerInput) {
            managerInput.value = managerName || '';
        }
    }

    async function deleteEntry(btn) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;

        const row = btn.closest('tr');
        const id = row.getAttribute('data-id');

        try {
            const response = await fetch(`/api/appointments/${id}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            });

            if (response.ok) {
                // Remove row
                row.remove();
                updateRowNumbers();

                // Reload to ensure summary correctness
                window.location.reload();

            } else {
                const err = await response.json();
                alert('Error: ' + (err.error || 'Unknown error'));
            }
        } catch (e) {
            console.error(e);
            alert('Network error: ' + e.message);
        }
    }
    // --- Appointment Selection & Import Logic ---

    function openAppointmentSelectionModal() {
        const el = document.getElementById('select-appointment-modal');
        if (el) {
            el.style.display = 'block';
            el.classList.remove('hidden');
        }
    }

    function closeAppointmentSelectionModal() {
        const el = document.getElementById('select-appointment-modal');
        if (el) el.style.display = 'none';
    }

    // Alias for button compatibility
    function openModal() {
        openJournalModal();
    }

    // Adapter for legacy duplicate name if needed (the duplicate was openEditJournalModal)
    // The existing openEditJournalModal at 817 is correct.

    function openJournalFromAppointment(appt) {
        closeAppointmentSelectionModal();
        openJournalModal(); // Use the existing function

        setTimeout(() => {
            const form = document.getElementById('entryForm');
            if (!form) return;

            if (appt.contract_number) {
                const contractInput = form.querySelector('input[name="contract_number"]');
                if (contractInput) contractInput.value = appt.contract_number;
            }

            if (appt.is_child) {
                const isChildInput = form.querySelector('input[name="is_child"]');
                if (isChildInput) isChildInput.checked = true;
            }

            if (appt.patient_name) {
                const nameInput = form.querySelector('input[name="patient_name"]');
                if (nameInput) nameInput.value = appt.patient_name;
            }

            if (appt.clinic_id) {
                const clinicSelect = form.querySelector('select[name="clinic_id"]');
                if (clinicSelect) {
                    $(clinicSelect).val(appt.clinic_id).trigger('change.select2');

                    // Fallback if not using select2 or plain set
                    if (clinicSelect.value !== appt.clinic_id.toString()) {
                        clinicSelect.value = appt.clinic_id;
                    }
                }
            }

            if (appt.doctor_id) {
                const docSelect = form.querySelector('select[name="doctor_id"]');
                if (docSelect) {
                    $(docSelect).val(appt.doctor_id).trigger('change.select2');
                    // Fallback
                    if (docSelect.value !== appt.doctor_id.toString()) {
                        docSelect.value = appt.doctor_id;
                    }
                    if (typeof updateManager === 'function') updateManager(docSelect);
                }
            }

            if (appt.services && appt.services.length > 0) {
                const serviceId = appt.services[0].id;
                const serviceSelect = form.querySelector('select[name="service"]');
                if (serviceSelect) {
                    serviceSelect.value = serviceId;
                    if (typeof calculateTotal === 'function') calculateTotal(serviceSelect);
                }
            }
        }, 100);
    }

    // Comprehensive outside click handler replacing duplicated ones
    window.onclick = function (event) {
        const modal1 = document.getElementById('entryModal');
        const modal2 = document.getElementById('select-appointment-modal');
        const modal3 = document.getElementById('importJournalModal');

        if (event.target == modal1) closeJournalModal();
        if (event.target == modal2) closeAppointmentSelectionModal();
        if (event.target == modal3) modal3.style.display = "none";
    }
</script>

<!-- Import Journal Modal -->
<div id="importJournalModal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content"
        style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 400px; border-radius: 8px;">
        <span class="close" onclick="document.getElementById('importJournalModal').style.display='none'"
            style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h2 style="margin-bottom: 20px; color: #1f2937;">–ò–º–ø–æ—Ä—Ç –≤ –∂—É—Ä–Ω–∞–ª</h2>
        <form action="{{ url_for('admin.import_journal') }}" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="mb-4" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">–¶–µ–Ω—Ç—Ä</label>
                <select name="center_id" class="journal-select" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–Ω—Ç—Ä --</option>
                    {% for center in centers %}
                    <option value="{{ center.id }}" {% if current_center_id==center.id %}selected{% endif %}>{{
                        center.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-4" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">–§–∞–π–ª (Excel)</label>
                <input type="file" name="file" accept=".xlsx" class="journal-input" required>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" onclick="document.getElementById('importJournalModal').style.display='none'"
                    class="btn"
                    style="background: #e5e7eb; padding: 0.5rem 1rem; border-radius: 4px; border: none; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary"
                    style="background: #10b981; color: white; padding: 0.5rem 1rem; border-radius: 4px; border: none; cursor: pointer;">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}