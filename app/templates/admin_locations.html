{% extends "admin_base.html" %}

{% block content %}
<div class="card">
    <div class="flex-between mb-4">
        <h2>Города и Центры</h2>
        <button class="btn btn-primary" onclick="openAddModal('city')">Добавить город</button>
    </div>

    <div class="locations-list">
        {% for city in cities %}
        <div class="location-item" data-id="{{ city.id }}">
            <div class="city-header flex-between"
                style="background: #f9fafb; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; margin-bottom: 0.5rem;">
                <div style="font-weight: 600;">{{ city.name }}</div>
                <div>
                    <button class="btn" style="font-size: 0.75rem;"
                        onclick="openAddModal('center', {{ city.id }})">Добавить центр</button>
                    <button class="btn" style="color: #6b7280;"
                        onclick="openEditModal({{ city.id }}, '{{ city.name }}', 'city')">✎</button>
                </div>
            </div>

            <div class="centers-list" style="padding-left: 2rem; margin-bottom: 1rem;">
                {% for center in city.children %}
                <div class="center-item flex-between" style="padding: 0.5rem; border-bottom: 1px solid #f3f4f6;">
                    <span>{{ center.name }}</span>
                    <button class="btn" style="color: #6b7280; font-size: 0.75rem;"
                        onclick="openEditModal({{ center.id }}, '{{ center.name }}', 'center')">✎</button>
                </div>
                {% else %}
                <div style="color: #9ca3af; font-size: 0.875rem; padding: 0.5rem; font-style: italic;">Нет добавленных
                    центров</div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal -->
<div id="loc-modal" class="modal hidden"
    style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <div class="modal-content"
        style="background: white; padding: 2rem; border-radius: 0.5rem; width: 400px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
        <h3 id="modal-title" style="margin-top: 0;">Добавить</h3>
        <form id="loc-form">
            <input type="hidden" id="loc-id">
            <input type="hidden" id="loc-parent-id">
            <input type="hidden" id="loc-type">

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem;">Название</label>
                <input type="text" id="loc-name" required
                    style="width: 100%; padding: 0.5rem; box-sizing: border-box; border: 1px solid #d1d5db; border-radius: 0.375rem;">
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                <button type="button" class="btn" style="border: 1px solid #d1d5db;"
                    onclick="closeModal()">Отмена</button>
                <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<style>
    .hidden {
        display: none !important;
    }
</style>

{% endblock %}

{% block scripts %}
<script>
    const modal = document.getElementById('loc-modal');
    const form = document.getElementById('loc-form');
    let isEdit = false;

    function openAddModal(type, parentId = null) {
        isEdit = false;
        document.getElementById('modal-title').textContent = type === 'city' ? 'Добавить город' : 'Добавить центр';
        document.getElementById('loc-type').value = type;
        document.getElementById('loc-parent-id').value = parentId || '';
        document.getElementById('loc-id').value = '';
        document.getElementById('loc-name').value = '';
        modal.classList.remove('hidden');
    }

    function openEditModal(id, name, type) {
        isEdit = true;
        document.getElementById('modal-title').textContent = 'Редактировать';
        document.getElementById('loc-id').value = id;
        document.getElementById('loc-name').value = name;
        document.getElementById('loc-type').value = type;
        modal.classList.remove('hidden');
    }

    function closeModal() {
        modal.classList.add('hidden');
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('loc-id').value;
        const name = document.getElementById('loc-name').value;
        const type = document.getElementById('loc-type').value;
        const parentId = document.getElementById('loc-parent-id').value;

        // URL and Method
        let url = isEdit ? `/admin/locations/${id}/edit` : '/admin/locations/add';
        let method = isEdit ? 'PUT' : 'POST';

        let body = isEdit ? JSON.stringify({ name }) : new FormData();
        if (!isEdit) {
            body.append('name', name);
            body.append('type', type);
            if (parentId) body.append('parent_id', parentId);
        }

        try {
            const res = await fetch(url, {
                method: method,
                headers: {
                    'X-CSRFToken': csrfToken,
                    ...(isEdit ? { 'Content-Type': 'application/json' } : {})
                },
                body: body
            });

            if (res.ok) {
                location.reload();
            } else {
                alert('Ошибка сохранения');
            }
        } catch (err) {
            console.error(err);
        }
    });
</script>
{% endblock %}