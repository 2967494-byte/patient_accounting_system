{% extends "admin_base.html" %}

{% block content %}
<!-- Tab Navigation -->
<div
    style="background: white; padding: 0.5rem; border-radius: 8px; border: 1px solid #e5e7eb; display: inline-flex; margin-bottom: 1.5rem; gap: 0.25rem;">
    <a href="{{ url_for('admin.services') }}"
        style="padding: 0.625rem 1.25rem; text-decoration: none; border-radius: 6px; font-weight: 500; transition: all 0.2s; color: #6b7280;">
        Услуги
    </a>
    <a href="{{ url_for('admin.additional_services') }}"
        style="padding: 0.625rem 1.25rem; text-decoration: none; border-radius: 6px; font-weight: 500; transition: all 0.2s; background: #9333ea; color: white;">
        Доп. услуги
    </a>
</div>

<style>
    .card table {
        font-size: 0.75rem;
    }

    .card table th,
    .card table td {
        padding: 0.4rem 0.5rem;
        white-space: nowrap;
    }

    .card table th {
        font-size: 0.7rem;
    }

    .card table select {
        font-size: 0.7rem;
        padding: 0.2rem 0.3rem;
        max-width: 120px;
    }

    .card table button {
        font-size: 0.9rem;
    }

    .count-badge {
        font-size: 0.8rem;
        color: #6b7280;
        font-weight: 400;
        margin-left: 0.5rem;
    }
</style>
<div class="card" style="overflow-x: auto;">
    <div class="flex-between mb-4">
        <h2>Доп. Услуги <span class="count-badge">всего {{ additional_services|length }}</span></h2>
        <div style="display: flex; gap: 10px;">
            <button onclick="document.getElementById('import-file').click()" class="btn"
                style="background-color: transparent; color: #9333ea; border: 1px solid #9333ea;">
                Импорт (Excel/CSV)
            </button>
            <button onclick="document.getElementById('add-add-service-modal').style.display='block'"
                style="background-color: #9333ea; color: white;" class="btn">
                Добавить доп. услугу
            </button>
        </div>

        <!-- Hidden Import Form -->
        <form id="import-form" action="{{ url_for('admin.import_additional_services') }}" method="POST"
            enctype="multipart/form-data" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="file" id="import-file" name="file" accept=".csv, .xlsx"
                onchange="document.getElementById('import-form').submit()">
        </form>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Родитель</th>
                <th>Цена</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for service in additional_services %}
            <tr>
                <td>{{ service.id }}</td>
                <td>{{ service.name }}</td>
                <td>{{ service.parent.name if service.parent else '—' }}</td>
                <td>{{ service.get_price() }} ₽</td>
                <td>
                    <button
                        onclick='editAddService({{ service.id | tojson }}, {{ service.name | tojson }}, {{ service.price | tojson }}, {{ service.parent_id | tojson }})'
                        class="btn"
                        style="background: transparent; color: #3b82f6; padding: 0.25rem; font-size: 1.2rem;"
                        title="Редактировать">
                        ✎
                    </button>
                    <a href="{{ url_for('admin.additional_service_prices', id=service.id) }}" class="btn"
                        style="background: transparent; color: #10b981; padding: 0.25rem; font-size: 1.2rem; text-decoration: none;"
                        title="Цены по периодам">
                        $
                    </a>
                    <button onclick="deleteAddService('{{ service.id }}')" class="btn"
                        style="background: transparent; color: #ef4444; padding: 0.25rem;">
                        ✕
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Add/Edit Modal -->
<div id="add-add-service-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
    <div style="background: white; margin: 100px auto; padding: 2rem; width: 400px; border-radius: 0.5rem;">
        <h3 id="modal-title">Добавить доп. услугу</h3>
        <form id="add-service-form" method="POST" action="{{ url_for('admin.add_additional_service') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-4">
                <label style="display: block; margin-bottom: 0.5rem;">Название</label>
                <input type="text" name="name" required style="width: 100%; padding: 0.5rem;">
            </div>
            <div class="mb-4">
                <label style="display: block; margin-bottom: 0.5rem;">Родительская услуга</label>
                <select name="parent_id" style="width: 100%; padding: 0.5rem;">
                    <option value="">-- Нет (Корневая) --</option>
                    {% for as in additional_services %}
                    <option value="{{ as.id }}">{{ as.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4" id="price-field">
                <label style="display: block; margin-bottom: 0.5rem;">Цена</label>
                <input type="number" step="0.01" name="price" style="width: 100%; padding: 0.5rem;">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="closeModal()" class="btn" style="background: #e5e7eb;">Отмена</button>
                <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<script>
    function closeModal() {
        document.getElementById('add-add-service-modal').style.display = 'none';
        document.getElementById('add-service-form').reset();
        document.getElementById('modal-title').innerText = 'Добавить доп. услугу';
        document.getElementById('add-service-form').action = "{{ url_for('admin.add_additional_service') }}";
    }

    function editAddService(id, name, price, parent_id) {
        document.getElementById('add-add-service-modal').style.display = 'block';
        document.getElementById('modal-title').innerText = 'Редактировать доп. услугу';
        const form = document.getElementById('add-service-form');
        form.action = `/admin/additional_services/${id}/update`;
        form.querySelector('[name="name"]').value = name;
        form.querySelector('[name="price"]').value = price;

        const parentSelect = form.querySelector('[name="parent_id"]');
        parentSelect.value = parent_id;

        // Disable self in parent selection
        Array.from(parentSelect.options).forEach(opt => {
            opt.disabled = (opt.value == id);
        });
    }

    function deleteAddService(id) {
        if (confirm('Вы уверены, что хотите удалить эту услугу?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/additional_services/${id}/delete`;

            const csrf = document.createElement('input');
            csrf.type = 'hidden';
            csrf.name = 'csrf_token';
            csrf.value = "{{ csrf_token() }}";
            form.appendChild(csrf);

            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}