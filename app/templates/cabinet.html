{% extends "app_base.html" %}

{% block content %}
<div class="cabinet-container" style="padding: 2rem;">
    <h1 style="font-size: 1.5rem; font-weight: 600; color: #1f2937; margin-bottom: 1.5rem;">Личный кабинет</h1>

    <div class="card"
        style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <h2 style="font-size: 1.1rem; margin-bottom: 1rem;">Просмотр исследования (Cornerstone Tools)</h2>

        {% if dicom_files %}
        <div id="dicomViewer"
            style="width: 800px; height: 600px; background: black; margin: 0 auto; position: relative;">
            <div id="loading-indicator"
                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white;">
                Загрузка...</div>
        </div>

        <div style="margin-top: 1rem; text-align: center; font-size: 0.9rem; color: #6b7280;">
            <p><strong>Управление:</strong> ЛКМ: Яркость/Контраст | ПКМ: Зум | Колесо: Прокрутка | СКМ: Перемещение</p>
            <p>Снимок: <span id="slice-index">1</span> / {{ dicom_files|length }}</p>
        </div>

        <!-- Dependencies -->
        <script src="https://unpkg.com/hammerjs@2.0.8/hammer.js"></script>
        <script src="https://unpkg.com/dicom-parser@1.8.3/dist/dicomParser.js"></script>
        <script src="https://unpkg.com/cornerstone-core@2.3.0/dist/cornerstone.js"></script>
        <script src="https://unpkg.com/cornerstone-math@0.1.8/dist/cornerstoneMath.js"></script>
        <script
            src="https://unpkg.com/cornerstone-wado-image-loader@3.1.0/dist/cornerstoneWADOImageLoader.min.js"></script>
        <script src="https://unpkg.com/cornerstone-tools@4.20.1/dist/cornerstoneTools.js"></script>

        <script>
            // Server-provided file list
            const imageIds = [
                {% for url in dicom_files %}
            "wadouri:{{ url }}"{ { "," if not loop.last } }
            {% endfor %}
                ];

            // Global Config
            cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
            cornerstoneWADOImageLoader.external.dicomParser = dicomParser;
            cornerstoneTools.external.cornerstone = cornerstone;
            cornerstoneTools.external.Hammer = Hammer;

            // WebWorker Config (using CDN versions)
            cornerstoneWADOImageLoader.webWorkerManager.initialize({
                maxWebWorkers: navigator.hardwareConcurrency || 1,
                startWebWorkersOnDemand: true,
                webWorkerPath: 'https://unpkg.com/cornerstone-wado-image-loader@3.1.0/dist/cornerstoneWADOImageLoaderWebWorker.min.js',
                taskConfiguration: {
                    'decodeTask': {
                        codecsPath: 'https://unpkg.com/cornerstone-wado-image-loader@3.1.0/dist/cornerstoneWADOImageLoaderCodecs.min.js'
                    }
                }
            });

            document.addEventListener('DOMContentLoaded', function () {
                const element = document.getElementById('dicomViewer');
                cornerstone.enable(element);
                cornerstoneTools.init();

                // Define Stack
                const stack = {
                    currentImageIdIndex: 0,
                    imageIds: imageIds
                };

                // Load First Image
                cornerstone.loadImage(imageIds[0]).then(function (image) {
                    cornerstone.displayImage(element, image);
                    document.getElementById('loading-indicator').style.display = 'none';

                    // --- Add Tools ---
                    const WwwcTool = cornerstoneTools.WwwcTool;
                    const PanTool = cornerstoneTools.PanTool;
                    const ZoomTool = cornerstoneTools.ZoomTool;
                    const StackScrollMouseWheelTool = cornerstoneTools.StackScrollMouseWheelTool;

                    cornerstoneTools.addTool(WwwcTool);
                    cornerstoneTools.addTool(PanTool);
                    cornerstoneTools.addTool(ZoomTool);
                    cornerstoneTools.addTool(StackScrollMouseWheelTool);

                    // --- Set Active Tools ---
                    // Left Click (1): Window/Level
                    cornerstoneTools.setToolActive('Wwwc', { mouseButtonMask: 1 });

                    // Middle Click (2) or (4) depending on browser, usually 2 is Middle, 4 is Right/Aux?
                    // Cornerstone often uses: 1=Left, 2=Right, 4=Middle. Let's check docs or standard.
                    // Actually: 1=Left, 2=Right, 4=Middle is common in some libs, but MouseEvent.buttons is 1=Left, 2=Right, 4=Middle.
                    // Cornerstone Tools docs: 1=Left, 2=Right, 4=Middle.
                    // User requested: "Pan при зажатой средней кнопке" -> Middle (4).
                    // "Zoom при колесе мыши" -> snippet said zoom.activate(4)? That's confusing.
                    // Let's use standard Medical Viewer layout:
                    // Left (1) = WW/WC
                    // Right (2) = Zoom
                    // Middle (4) = Pan
                    // Wheel = Stack Scroll

                    cornerstoneTools.setToolActive('Zoom', { mouseButtonMask: 2 });
                    cornerstoneTools.setToolActive('Pan', { mouseButtonMask: 4 });
                    cornerstoneTools.setToolActive('StackScrollMouseWheel', {});

                    // Add Stack State for scrolling
                    cornerstoneTools.addStackStateManager(element, ['stack']);
                    cornerstoneTools.addToolState(element, 'stack', stack);
                });

                // Update Slice Index Display
                element.addEventListener('cornerstoneimagerendered', function (e) {
                    const eventData = e.detail;
                    const toolState = cornerstoneTools.getToolState(element, 'stack');
                    if (toolState && toolState.data && toolState.data.length) {
                        const index = toolState.data[0].currentImageIdIndex;
                        document.getElementById('slice-index').textContent = index + 1;
                    }
                });
            });
        </script>
        {% else %}
        <p>Исследования не найдены.</p>
        {% endif %}
    </div>
</div>
{% endblock %}