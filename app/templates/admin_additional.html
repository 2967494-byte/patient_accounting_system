{% extends "admin_base.html" %}

{% block content %}
<div class="additional-page">

    <!-- Row 0: Locations (Cities & Centers) -->
    <div class="section-row">
        <div class="section-card locations-card" style="grid-column: span 2;">
            <div class="section-header">
                <span class="section-icon">üìç</span>
                <h3>–ì–æ—Ä–æ–¥–∞ –∏ –¶–µ–Ω—Ç—Ä—ã</h3>
                <button class="btn-add-city" onclick="openLocModal('city')">+ –ì–æ—Ä–æ–¥</button>
            </div>
            <div class="locations-list">
                {% for city in cities %}
                <div class="city-block">
                    <div class="city-row">
                        <span class="city-name">{{ city.name }}</span>
                        <div class="city-actions">
                            <button class="btn-mini" onclick="openLocModal('center', {{ city.id }})">+ –¶–µ–Ω—Ç—Ä</button>
                            <button class="btn-mini edit"
                                onclick="openLocEditModal({{ city.id }}, '{{ city.name }}', 'city')">‚úé</button>
                        </div>
                    </div>
                    <div class="centers-list">
                        {% for center in city.children %}
                        <div class="center-row">
                            <div class="center-color" style="background-color: {{ center.color }};"></div>
                            <span>{{ center.name }}</span>
                            <button class="btn-mini edit"
                                onclick="openLocEditModal({{ center.id }}, '{{ center.name }}', 'center', '{{ center.color }}')">‚úé</button>
                        </div>
                        {% else %}
                        <span class="empty-text" style="margin-left: 1rem;">–ù–µ—Ç —Ü–µ–Ω—Ç—Ä–æ–≤</span>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <p class="empty-text">–ù–µ—Ç –≥–æ—Ä–æ–¥–æ–≤</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Row 1: Quick Lists -->
    <div class="section-row">
        <div class="section-card">
            <div class="section-header">
                <span class="section-icon">üë•</span>
                <h3>–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</h3>
            </div>
            <form action="{{ url_for('admin.add_manager') }}" method="POST" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="text" name="name" placeholder="–ù–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä..." required>
                <button type="submit">+</button>
            </form>
            <div class="items-list">
                {% for manager in managers %}
                <div class="list-item">
                    <form action="{{ url_for('admin.update_manager', id=manager.id) }}" method="POST" class="item-edit">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="text" name="name" value="{{ manager.name }}" required>
                        <button type="submit" class="btn-save" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">üíæ</button>
                    </form>
                    <form action="{{ url_for('admin.delete_manager', id=manager.id) }}" method="POST"
                        onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <button type="submit" class="btn-delete" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                    </form>
                </div>
                {% else %}
                <p class="empty-text">–ù–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</p>
                {% endfor %}
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">
                <span class="section-icon">üí≥</span>
                <h3>–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</h3>
            </div>
            <form action="{{ url_for('admin.add_payment_method') }}" method="POST" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="text" name="name" placeholder="–ù–æ–≤—ã–π —Å–ø–æ—Å–æ–±..." required>
                <button type="submit">+</button>
            </form>
            <div class="items-list">
                {% for method in payment_methods %}
                <div class="list-item">
                    <form action="{{ url_for('admin.update_payment_method', id=method.id) }}" method="POST"
                        class="item-edit">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="text" name="name" value="{{ method.name }}" required>
                        <button type="submit" class="btn-save" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">üíæ</button>
                    </form>
                    <form action="{{ url_for('admin.delete_payment_method', id=method.id) }}" method="POST"
                        onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <button type="submit" class="btn-delete" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                    </form>
                </div>
                {% else %}
                <p class="empty-text">–ù–µ—Ç —Å–ø–æ—Å–æ–±–æ–≤</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Row 2: Media Uploads -->
    <div class="section-row">
        <div class="section-card media-card">
            <div class="section-header">
                <span class="section-icon">üí¨</span>
                <h3>–ò–∫–æ–Ω–∫–∞ —á–∞—Ç–∞</h3>
            </div>
            <div class="media-content">
                <form action="{{ url_for('admin.update_chat_settings') }}" method="POST" enctype="multipart/form-data"
                    class="upload-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="file" name="chat_image" accept="image/*" required>
                    <button type="submit" class="btn-upload">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                </form>
                {% if chat_image %}
                <img src="{{ url_for('static', filename=chat_image) }}" alt="Chat" class="preview-img round">
                {% endif %}
            </div>
        </div>

        <div class="section-card media-card">
            <div class="section-header">
                <span class="section-icon">üîè</span>
                <h3>–ü–µ—á–∞—Ç—å</h3>
            </div>
            <div class="media-content">
                <form action="{{ url_for('admin.upload_stamp_image') }}" method="POST" enctype="multipart/form-data"
                    class="upload-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="file" name="stamp_image" accept="image/png" required>
                    <button type="submit" class="btn-upload">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                </form>
                {% if stamp_image %}
                <img src="{{ url_for('static', filename=stamp_image) }}" alt="Stamp" class="preview-img square">
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Row 3: Data Operations -->
    <div class="section-row">
        <div class="section-card operations-card">
            <div class="section-header">
                <span class="section-icon">üì•</span>
                <h3>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
            </div>
            <form action="{{ url_for('admin.import_journal_data') }}" method="POST" enctype="multipart/form-data"
                class="operation-form" onsubmit="return confirm('–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <select name="center_id" required>
                    <option value="">–¶–µ–Ω—Ç—Ä...</option>
                    {% for center in centers %}
                    <option value="{{ center.id }}">{{ center.name }}</option>
                    {% endfor %}
                </select>
                <input type="file" name="file" accept=".csv, .xlsx" required>
                <label class="checkbox-label">
                    <input type="checkbox" name="delete_old">
                    –ó–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ
                </label>
                <button type="submit" class="btn-action blue">–ò–º–ø–æ—Ä—Ç</button>
            </form>
            <div class="divider"></div>
            <a href="{{ url_for('admin.import_ics') }}" class="btn-action green"
                style="text-decoration: none; text-align: center;">üìÖ –ò–º–ø–æ—Ä—Ç .ics</a>
        </div>

        <div class="section-card operations-card">
            <div class="section-header">
                <span class="section-icon">üîÑ</span>
                <h3>–ü–µ—Ä–µ—Å—á—ë—Ç —Å—É–º–º</h3>
            </div>
            <form action="{{ url_for('admin.recalculate_journal_data') }}" method="POST" class="operation-form"
                onsubmit="return confirm('–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å—É–º–º—ã?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <select name="center_id" required>
                    <option value="">–¶–µ–Ω—Ç—Ä...</option>
                    {% for center in centers %}
                    <option value="{{ center.id }}">{{ center.name }}</option>
                    {% endfor %}
                </select>
                <input type="month" name="month" required>
                <button type="submit" class="btn-action orange">–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>
            </form>
        </div>

        <div class="section-card operations-card danger">
            <div class="section-header">
                <span class="section-icon">‚ö†Ô∏è</span>
                <h3>–û—á–∏—Å—Ç–∫–∞</h3>
            </div>
            <form action="{{ url_for('admin.clear_journal_data') }}" method="POST" class="operation-form"
                onsubmit="return confirm('–í–ù–ò–ú–ê–ù–ò–ï! –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ!');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <select name="center_id" required>
                    <option value="">–¶–µ–Ω—Ç—Ä...</option>
                    {% for center in centers %}
                    <option value="{{ center.id }}">{{ center.name }}</option>
                    {% endfor %}
                </select>
                <input type="month" name="month" required>
                <input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
                <button type="submit" class="btn-action red">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </form>
        </div>
    </div>

</div>

<style>
    .additional-page {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }

    .section-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.25rem;
    }

    .section-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #f3f4f6;
    }

    .section-header h3 {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 600;
        color: #374151;
    }

    .section-icon {
        font-size: 1.1rem;
    }

    /* Inline forms for adding items */
    .inline-form {
        display: flex;
        gap: 0.25rem;
        margin-bottom: 0.75rem;
    }

    .inline-form input {
        flex: 1;
        padding: 0.4rem 0.6rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        font-size: 0.8rem;
    }

    .inline-form button {
        padding: 0.4rem 0.75rem;
        background: #4f46e5;
        color: white;
        border: none;
        border-radius: 0.375rem;
        font-weight: 600;
        cursor: pointer;
    }

    /* List items */
    .items-list {
        max-height: 180px;
        overflow-y: auto;
    }

    .list-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.3rem 0;
        border-bottom: 1px solid #f9fafb;
    }

    .item-edit {
        display: flex;
        flex: 1;
        gap: 0.25rem;
    }

    .item-edit input {
        flex: 1;
        padding: 0.25rem 0.5rem;
        border: 1px solid transparent;
        border-radius: 0.25rem;
        font-size: 0.8rem;
        background: transparent;
    }

    .item-edit input:focus {
        border-color: #e5e7eb;
        background: white;
    }

    .btn-save,
    .btn-delete {
        padding: 0.2rem 0.4rem;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 0.85rem;
        border-radius: 0.25rem;
    }

    .btn-save:hover {
        background: #e0e7ff;
    }

    .btn-delete {
        color: #ef4444;
    }

    .btn-delete:hover {
        background: #fee2e2;
    }

    .empty-text {
        color: #9ca3af;
        font-size: 0.8rem;
        text-align: center;
        padding: 1rem 0;
        margin: 0;
    }

    /* Media cards */
    .media-card .media-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .upload-form {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        flex: 1;
    }

    .upload-form input[type="file"] {
        font-size: 0.75rem;
    }

    .btn-upload {
        padding: 0.4rem 0.75rem;
        background: #4f46e5;
        color: white;
        border: none;
        border-radius: 0.375rem;
        font-size: 0.8rem;
        cursor: pointer;
        width: fit-content;
    }

    .preview-img {
        width: 56px;
        height: 56px;
        object-fit: cover;
        border: 2px solid #e5e7eb;
    }

    .preview-img.round {
        border-radius: 50%;
    }

    .preview-img.square {
        border-radius: 0.5rem;
        object-fit: contain;
        background: #f9fafb;
    }

    /* Operations */
    .operations-card {
        min-height: 160px;
    }

    .operation-form {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .operation-form select,
    .operation-form input {
        padding: 0.4rem 0.6rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        font-size: 0.8rem;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.75rem;
        color: #6b7280;
    }

    .checkbox-label input {
        width: 14px;
        height: 14px;
    }

    .btn-action {
        padding: 0.5rem 0.75rem;
        border: none;
        border-radius: 0.375rem;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        color: white;
        display: block;
    }

    .btn-action.blue {
        background: #3b82f6;
    }

    .btn-action.green {
        background: #10b981;
    }

    .btn-action.orange {
        background: #f59e0b;
    }

    .btn-action.red {
        background: #ef4444;
    }

    .divider {
        height: 1px;
        background: #f3f4f6;
        margin: 0.75rem 0;
    }

    /* Danger card styling */
    .operations-card.danger {
        border: 1px solid #fecaca;
        background: linear-gradient(135deg, #fff 0%, #fef2f2 100%);
    }

    /* Locations card styles */
    .locations-card {
        max-height: 300px;
        overflow-y: auto;
    }

    .locations-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .city-block {
        background: #f9fafb;
        border-radius: 0.5rem;
        padding: 0.5rem;
    }

    .city-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.25rem;
    }

    .city-name {
        font-weight: 600;
        font-size: 0.85rem;
    }

    .city-actions {
        display: flex;
        gap: 0.25rem;
    }

    .centers-list {
        padding-left: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .center-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        padding: 0.2rem 0;
    }

    .center-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid #ddd;
    }

    .btn-add-city {
        margin-left: auto;
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
        background: #4f46e5;
        color: white;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
    }

    .btn-mini {
        padding: 0.15rem 0.4rem;
        font-size: 0.65rem;
        background: #e5e7eb;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
    }

    .btn-mini.edit {
        background: transparent;
        color: #6b7280;
    }
</style>

<!-- Location Modal -->
<div id="loc-modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:1.5rem; border-radius:0.5rem; width:320px;">
        <h4 id="loc-modal-title" style="margin:0 0 1rem 0;">–î–æ–±–∞–≤–∏—Ç—å</h4>
        <form id="loc-form">
            <input type="hidden" id="loc-id">
            <input type="hidden" id="loc-parent-id">
            <input type="hidden" id="loc-type">
            <div style="margin-bottom:0.75rem;">
                <label style="font-size:0.8rem;">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" id="loc-name" required
                    style="width:100%; padding:0.4rem; border:1px solid #d1d5db; border-radius:0.375rem; box-sizing:border-box;">
            </div>
            <div id="loc-color-row" style="margin-bottom:0.75rem;">
                <label style="font-size:0.8rem;">–¶–≤–µ—Ç</label>
                <input type="color" id="loc-color" value="#3b82f6" style="width:100%; height:32px;">
            </div>
            <div style="display:flex; gap:0.5rem; justify-content:flex-end;">
                <button type="button" onclick="closeLocModal()"
                    style="padding:0.4rem 0.75rem; border:1px solid #d1d5db; background:white; border-radius:0.375rem; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit"
                    style="padding:0.4rem 0.75rem; background:#4f46e5; color:white; border:none; border-radius:0.375rem; cursor:pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<script>
    const locModal = document.getElementById('loc-modal');
    const locForm = document.getElementById('loc-form');
    let locIsEdit = false;

    function openLocModal(type, parentId = null) {
        locIsEdit = false;
        document.getElementById('loc-modal-title').textContent = type === 'city' ? '–î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥' : '–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—Ç—Ä';
        document.getElementById('loc-type').value = type;
        document.getElementById('loc-parent-id').value = parentId || '';
        document.getElementById('loc-id').value = '';
        document.getElementById('loc-name').value = '';
        document.getElementById('loc-color').value = '#3b82f6';
        document.getElementById('loc-color-row').style.display = type === 'center' ? 'block' : 'none';
        locModal.style.display = 'flex';
    }

    function openLocEditModal(id, name, type, color) {
        locIsEdit = true;
        document.getElementById('loc-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
        document.getElementById('loc-id').value = id;
        document.getElementById('loc-name').value = name;
        document.getElementById('loc-type').value = type;
        if (color) document.getElementById('loc-color').value = color;
        document.getElementById('loc-color-row').style.display = type === 'center' ? 'block' : 'none';
        locModal.style.display = 'flex';
    }

    function closeLocModal() { locModal.style.display = 'none'; }

    locForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('loc-id').value;
        const name = document.getElementById('loc-name').value;
        const type = document.getElementById('loc-type').value;
        const parentId = document.getElementById('loc-parent-id').value;
        const color = document.getElementById('loc-color').value;

        let url = locIsEdit ? `/admin/locations/${id}/edit` : '/admin/locations/add';
        let method = locIsEdit ? 'PUT' : 'POST';
        let body = locIsEdit ? JSON.stringify({ name, color }) : new FormData();
        if (!locIsEdit) {
            body.append('name', name);
            body.append('type', type);
            if (parentId) body.append('parent_id', parentId);
            if (type === 'center') body.append('color', color);
        }

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'X-CSRFToken': csrfToken, ...(locIsEdit ? { 'Content-Type': 'application/json' } : {}) },
                body: body
            });
            if (res.ok) location.reload();
            else alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        } catch (err) { console.error(err); }
    });
</script>
{% endblock %}