{% extends "app_base.html" %}

{% block head %}
<style>
    .chat-container {
        display: flex;
        height: calc(100vh - 120px);
        /* Adjust based on header height */
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-top: 20px;
    }

    .chat-sidebar {
        width: 300px;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
    }

    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #e5ddd5;
        /* Whatsapp BG */
    }

    .thread-item {
        padding: 15px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .thread-item:hover {
        background: #f9f9f9;
    }

    .thread-item.active {
        background: #f0f2f5;
    }

    .thread-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #ddd;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #555;
    }

    .thread-info {
        flex: 1;
        overflow: hidden;
    }

    .thread-name {
        font-weight: 600;
        font-size: 15px;
        color: #111;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .thread-preview {
        font-size: 13px;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .thread-meta {
        font-size: 11px;
        color: #999;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .unread-count {
        background: #25d366;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 11px;
        font-weight: bold;
        margin-top: 4px;
    }

    .chat-header {
        background: #f0f2f5;
        padding: 10px 20px;
        border-bottom: 1px solid #d1d5db;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .chat-input-area {
        padding: 20px;
        background: #f0f2f5;
        display: flex;
        gap: 10px;
    }

    .chat-input {
        flex: 1;
        padding: 12px;
        border: 1px solid white;
        border-radius: 20px;
        outline: none;
    }

    .btn-send {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #0088cc;
        /* Telegram/Whatsapp blueish */
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Blink animation */
    @keyframes blink {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }

        100% {
            opacity: 1;
        }
    }

    .blink-animation {
        animation: blink 1s infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Sidebar -->
    <div class="chat-sidebar">
        <div
            style="padding: 15px; background: #f0f2f5; border-bottom: 1px solid #d1d5db; display: flex; flex-direction: column; gap: 10px;">
            <h3 style="margin: 0; font-size: 18px;">Диалоги</h3>
            <input type="text" id="thread-search" placeholder="Поиск (Имя, Организация)..."
                style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
        </div>
        <div id="chat-threads" style="overflow-y: auto; flex: 1;">
            <!-- Threads Loaded via JS -->
            <div style="padding: 20px; text-align: center; color: #999;">Загрузка...</div>
        </div>
    </div>

    <!-- ... existing Main Chat ... -->
    <div class="chat-main">
        <div class="chat-header" id="chat-header" style="visibility: hidden;">
            <div class="thread-avatar" id="header-avatar"></div>
            <div>
                <div class="thread-name" id="header-name"></div>
                <!-- Remove fixed "Organization" label if dynamic name is used -->
            </div>
        </div>

        <div id="chat-messages" class="chat-messages">
            <div style="text-align: center; color: #777; margin-top: 50px;">
                Выберите чат слева, чтобы начать общение
            </div>
        </div>

        <div class="chat-input-area" id="input-area" style="visibility: hidden;">
            <input type="text" class="chat-input" id="chat-input" placeholder="Введите сообщение...">
            <button class="btn-send" onclick="sendMessage()">➤</button>
        </div>
    </div>
</div>

<script>
    // Dashboard specific logic to run alongside chat.js
    let searchTimeout = null;

    document.addEventListener('DOMContentLoaded', function () {
        loadThreads();
        // setInterval(loadThreads, 5000); // Poll disabled if searching? Or manage carefully.
        // Better: Poll only if search is empty.
        setInterval(() => {
            const query = document.getElementById('thread-search').value.trim();
            if (!query) loadThreads();
        }, 5000);

        // Search Listener
        document.getElementById('thread-search').addEventListener('input', function (e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadThreads(e.target.value);
            }, 300);
        });
    });

    async function loadThreads(query = '') {
        try {
            const url = query ? `/api/chat/threads?search=${encodeURIComponent(query)}` : '/api/chat/threads';
            const response = await fetch(url);
            if (!response.ok) return;

            const threads = await response.json();
            const container = document.getElementById('chat-threads');

            container.innerHTML = '';

            if (threads.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Нет диалогов</div>';
                return;
            }

            threads.forEach(t => {
                const div = document.createElement('div');
                div.className = `thread-item ${currentChatUserId == t.user_id ? 'active' : ''}`;
                div.onclick = () => selectThread(t.user_id, t.username, t.display_name); // Use display_name here

                div.innerHTML = `
                <div class="thread-avatar">${t.username.substring(0, 2).toUpperCase()}</div>
                <div class="thread-info">
                    <div style="display:flex; justify-content:space-between;">
                        <span class="thread-name">${t.display_name}</span>
                        <div class="thread-meta">
                            <span>${t.last_timestamp ? new Date(t.last_timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}</span>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span class="thread-preview">${t.last_message || 'Нет сообщений'}</span>
                        ${t.unread_count > 0 ? `<span class="unread-count">${t.unread_count}</span>` : ''}
                    </div>
                </div>
            `;
                container.appendChild(div);
            });
        } catch (e) { console.error(e); }
    }

    function selectThread(userId, username, displayName) {
        currentChatUserId = userId; // Set global var for chat.js

        // Update UI
        document.getElementById('chat-header').style.visibility = 'visible';
        document.getElementById('input-area').style.visibility = 'visible';
        document.getElementById('header-name').innerText = displayName;
        document.getElementById('header-avatar').innerText = username.substring(0, 2).toUpperCase();

        // Mark read
        fetch('/api/chat/messages/read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ user_id: userId })
        });

        // Load Messages
        loadMessagesForSupport();

        // Highlight
        loadThreads(); // Re-render to show active state
    }

    async function loadMessagesForSupport() {
        if (!currentChatUserId) return;
        try {
            const response = await fetch(`/api/chat/messages/history?user_id=${currentChatUserId}`);
            const messages = await response.json();
            renderMessages(messages, 'support'); // Use shared render function from chat.js
        } catch (e) { console.error(e); }
    }

    // Override chat.js polling for Support Dashboard
    // We need to poll the ACTIVE thread if one is selected
    setInterval(() => {
        if (currentChatUserId) loadMessagesForSupport();
    }, 3000);

</script>
{% endblock %}