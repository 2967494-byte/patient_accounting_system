{% extends "app_base.html" %}

{% block content %}
<div class="card" style="padding: 1rem; max-width: 1200px; margin: 0 auto;">
    <div class="page-header"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div>
            <h2 style="margin: 0;">‚úçÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä —Å–ø—Ä–∞–≤–∫–∏ –ö–ù–î 1151156</h2>
            <p style="color: #6b7280; margin: 0.25rem 0 0 0;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è –ø—Ä—è–º–æ –Ω–∞ –±–ª–∞–Ω–∫–µ –∏ –Ω–∞–∂–º–∏—Ç–µ
                "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"</p>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <button onclick="saveAndGenerate()" class="btn"
                style="background: #10b981; color: white; padding: 0.75rem 1.5rem;">
                üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å
            </button>
        </div>
    </div>

    <!-- The Editor Container -->
    <div id="editor-container"
        style="position: relative; width: 100%; height: 1600px; background: #f3f4f6; overflow: auto; border: 1px solid #d1d5db; border-radius: 0.5rem;">
        <div id="pdf-background"
            style="position: relative; width: 1121px; height: 1585px; margin: 0 auto; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.2);">
            <img src="{{ url_for('static', filename='uploads/certificate_bg.png') }}"
                style="width: 100%; height: 100%; pointer-events: none;">

            <!-- Overlay Inputs -->
            <div id="overlay-layer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                <!-- These will be added via JS -->
            </div>
        </div>
    </div>
</div>

<style>
    .stamp-input {
        position: absolute;
        border: 1px solid transparent;
        background: rgba(59, 130, 246, 0.05);
        font-family: "Courier New", Courier, monospace;
        font-weight: bold;
        font-size: 16px;
        padding: 0;
        text-transform: uppercase;
        outline: none;
        transition: background 0.2s, border-color 0.2s;
    }

    .stamp-input:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: #3b82f6;
    }

    .stamp-input:focus {
        background: white;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }

    /* Box-grid inputs (character by character) */
    .char-box {
        position: absolute;
        width: 26px;
        height: 26px;
        border: 1px solid transparent;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: 400;
        font-size: 22px;
        padding: 0;
        outline: none;
    }

    .char-box:focus {
        background: rgba(37, 99, 235, 0.05);
        border-color: #2563eb;
    }
</style>

<script>
    const appointmentId = JSON.parse('{{ appointment_id | tojson }}');
    const patientData = JSON.parse('{{ patient_data | tojson }}');

    const fields = [
        { id: 'top_inn', type: 'grid', count: 12, startX: 351, startY: 28.5, spacing: 26.7 },
        { id: 'top_kpp', type: 'grid', count: 9, startX: 351, startY: 68.5, spacing: 26.7 },
        { id: 'page_no', type: 'grid', count: 3, startX: 621, startY: 68.5, spacing: 26.7 },
        { id: 'cert_no', type: 'grid', count: 15, startX: 163.5, startY: 248.5, spacing: 26.7, val: '' },
        { id: 'correction', type: 'grid', count: 3, startX: 701, startY: 248.5, spacing: 26.7 },
        { id: 'year', type: 'grid', count: 4, startX: 991, startY: 248.5, spacing: 26.7, val: patientData.exam_year },
        { id: 'org_l1', type: 'grid', count: 40, startX: 35, startY: 348.5, spacing: 26.7 },
        { id: 'org_l2', type: 'grid', count: 40, startX: 35, startY: 385.5, spacing: 26.7 },
        { id: 'org_l3', type: 'grid', count: 40, startX: 35, startY: 422.5, spacing: 26.7 },
        { id: 'org_l4', type: 'grid', count: 40, startX: 35, startY: 459.5, spacing: 26.7 },
        { id: 'surname', type: 'grid', count: 40, startX: 139, startY: 575.5, spacing: 26.7, val: patientData.surname },
        { id: 'name', type: 'grid', count: 40, startX: 139, startY: 621.0, spacing: 26.7, val: patientData.name },
        { id: 'patronymic', type: 'grid', count: 40, startX: 139, startY: 666.5, spacing: 26.7, val: patientData.patronymic },
        { id: 'p_inn', type: 'grid', count: 12, startX: 139, startY: 712.0, spacing: 26.7, val: patientData.inn },
        { id: 'b_day', type: 'grid', count: 2, startX: 700, startY: 712.0, spacing: 26.7, val: patientData.b_day },
        { id: 'b_month', type: 'grid', count: 2, startX: 781, startY: 712.0, spacing: 26.7, val: patientData.b_month },
        { id: 'b_year', type: 'grid', count: 4, startX: 862, startY: 712.0, spacing: 26.7, val: patientData.b_year },
        { id: 'doc_code', type: 'grid', count: 2, startX: 219, startY: 800.5, spacing: 26.7, val: '21' },
        { id: 'doc_info', type: 'grid', count: 25, startX: 567.7, startY: 800.5, spacing: 26.7, val: patientData.doc_info },
        { id: 'i_day', type: 'grid', count: 2, startX: 219, startY: 846.0, spacing: 26.7, val: patientData.i_day },
        { id: 'i_month', type: 'grid', count: 2, startX: 300, startY: 846.0, spacing: 26.7, val: patientData.i_month },
        { id: 'i_year', type: 'grid', count: 4, startX: 381, startY: 846.0, spacing: 26.7, val: patientData.i_year },
        { id: 'amount', type: 'grid', count: 13, startX: 621.1, startY: 955.5, spacing: 26.7, val: patientData.amount },
        { id: 'amount_kop', type: 'grid', count: 2, startX: 994.9, startY: 955.5, spacing: 26.7, val: patientData.amount_kop },
        { id: 'c_day', type: 'grid', count: 2, startX: 307, startY: 1282.5, spacing: 26.7, val: patientData.c_day },
        { id: 'c_month', type: 'grid', count: 2, startX: 388, startY: 1282.5, spacing: 26.7, val: patientData.c_month },
        { id: 'c_year', type: 'grid', count: 4, startX: 469, startY: 1282.5, spacing: 26.7, val: patientData.c_year },
        { id: 'rep_surname', type: 'grid', count: 40, startX: 139, startY: 1150.5, spacing: 26.7, val: '' },
        { id: 'rep_name', type: 'grid', count: 40, startX: 139, startY: 1196.0, spacing: 26.7, val: '' },
        { id: 'rep_patronymic', type: 'grid', count: 40, startX: 139, startY: 1241.5, spacing: 26.7, val: '' },
        { id: 'stamp', type: 'image', url: patientData.stamp_url, startX: 34, startY: 1210, width: 264 },
    ];

    function initEditor() {
        const overlay = document.getElementById('overlay-layer');
        // Save current values to restore them after re-init (if any)
        const currentVals = {};
        document.querySelectorAll('.char-box').forEach(inp => {
            const field = inp.dataset.field;
            const index = inp.dataset.index;
            if (!currentVals[field]) currentVals[field] = {};
            currentVals[field][index] = inp.value;
        });

        overlay.innerHTML = '';

        const globalX = parseInt(localStorage.getItem('cert_x') || '0');
        const globalY = parseInt(localStorage.getItem('cert_y') || '0');

        fields.forEach(f => {
            if (f.type === 'grid') {
                for (let i = 0; i < f.count; i++) {
                    const input = document.createElement('input');
                    input.className = 'char-box';
                    input.style.left = (f.startX + (i * f.spacing) + globalX) + 'px';
                    input.style.top = (f.startY + globalY - 2) + 'px';
                    input.maxLength = 1;
                    input.dataset.field = f.id;
                    input.dataset.index = i;

                    if (currentVals[f.id] && currentVals[f.id][i] !== undefined) {
                        input.value = currentVals[f.id][i];
                    } else if (f.val && f.val[i]) {
                        input.value = f.val[i];
                    }

                    input.oninput = (e) => {
                        if (e.target.value && e.target.nextElementSibling && e.target.nextElementSibling.dataset.field === f.id) {
                            e.target.nextElementSibling.focus();
                        }
                    };
                    input.onkeydown = (e) => {
                        if (e.key === 'Backspace' && !e.target.value && e.target.previousElementSibling && e.target.previousElementSibling.dataset.field === f.id) {
                            e.target.previousElementSibling.focus();
                        }
                    };

                    overlay.appendChild(input);
                }
            } else if (f.type === 'image') {
                const img = document.createElement('img');
                img.src = f.url;
                img.style.position = 'absolute';
                img.style.left = (f.startX + globalX) + 'px';
                img.style.top = (f.startY + globalY) + 'px';
                img.style.width = f.width + 'px';
                img.style.pointerEvents = 'none';
                img.style.opacity = '0.7';
                overlay.appendChild(img);
            }
        });
    }


    async function saveAndGenerate() {
        // Collect all data
        const inputs = document.querySelectorAll('.char-box');
        const formData = {};
        inputs.forEach(inp => {
            const field = inp.dataset.field;
            if (!formData[field]) formData[field] = '';
            formData[field] += inp.value || ' ';
        });

        try {
            const response = await fetch('/stamp-tool/certificate/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    appointment_id: appointmentId,
                    form_data: formData,
                    calibration: {
                        x: parseInt(localStorage.getItem('cert_x') || '0'),
                        y: parseInt(localStorage.getItem('cert_y') || '0')
                    }
                })
            });
            const result = await response.json();
            if (result.success) {
                alert('‚úÖ –°–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞!');
                window.location.href = result.download_url;
            } else {
                alert('–û—à–∏–±–∫–∞: ' + result.error);
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
        }
    }

    window.onload = initEditor;
</script>
{% endblock %}