{% extends "app_base.html" %}

{% block content %}
<div class="card" style="padding: 1rem; max-width: 1200px; margin: 0 auto;">
    <div class="page-header"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div>
            <h2 style="margin: 0;">‚úçÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä —Å–ø—Ä–∞–≤–∫–∏ {% if form_type == 'knd1151156_op' %}–ö–ù–î 1151156 –û–ü{% else %}–ö–ù–î
                1151156{% endif %}</h2>
            <p style="color: #6b7280; margin: 0.25rem 0 0 0;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è –ø—Ä—è–º–æ –Ω–∞ –±–ª–∞–Ω–∫–µ –∏ –Ω–∞–∂–º–∏—Ç–µ
                "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"</p>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <button id="generate-btn" onclick="saveAndGenerate()" class="btn"
                style="background: #10b981; color: white; padding: 0.75rem 1.5rem; position: relative;">
                <span id="btn-text">üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å</span>
            </button>
        </div>
    </div>

    <!-- The Editor Container -->
    <div id="editor-container"
        style="position: relative; width: 100%; height: 1600px; background: #f3f4f6; overflow: auto; border: 1px solid #d1d5db; border-radius: 0.5rem; display: flex; flex-direction: column; gap: 20px; align-items: center; padding: 20px 0;">

        <!-- Page 1 -->
        <div id="page-1" class="cert-page"
            style="position: relative; width: 1121px; height: 1585px; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.2); flex-shrink: 0;">
            <img src="{{ bg_url }}" style="width: 100%; height: 100%; pointer-events: none;">
            <div id="overlay-layer-1" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
            <div style="position: absolute; top: 10px; left: -120px; font-weight: bold; color: #6b7280;">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1
            </div>
        </div>

        <!-- Page 2 (Hidden by default, shown for OP) -->
        <div id="page-2" class="cert-page"
            style="display: none; position: relative; width: 1121px; height: 1585px; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.2); flex-shrink: 0;">
            <img src="{{ bg_url_p2 or bg_url }}" style="width: 100%; height: 100%; pointer-events: none;">
            <div id="overlay-layer-2" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
            <div style="position: absolute; top: 10px; left: -120px; font-weight: bold; color: #6b7280;">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 2
            </div>
        </div>
    </div>
</div>

<style>
    .stamp-input {
        position: absolute;
        border: 1px solid transparent;
        background: rgba(59, 130, 246, 0.05);
        font-family: "Courier New", Courier, monospace;
        font-weight: bold;
        font-size: 16px;
        padding: 0;
        text-transform: uppercase;
        outline: none;
        transition: background 0.2s, border-color 0.2s;
    }

    .stamp-input:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: #3b82f6;
    }

    .stamp-input:focus {
        background: white;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }

    /* Box-grid inputs (character by character) */
    .char-box {
        position: absolute;
        width: 26px;
        height: 26px;
        border: 1px solid transparent;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: 400;
        font-size: 22px;
        padding: 0;
        outline: none;
    }

    .char-box:focus {
        background: rgba(37, 99, 235, 0.05);
        border-color: #2563eb;
    }
</style>

<script>
    const appointmentId = {{ appointment_id | tojson | safe }};
    const patientData = {{ patient_data | tojson | safe }};
    // Safe parse payerData if exists
    const payerData = {{ payer_data | tojson | safe }} || {};
    const formType = '{{ form_type }}';

    // Base field config (positions)
    const baseFields = [
        { id: 'top_inn', type: 'grid', count: 12, startX: 351, startY: 28.5, spacing: 26.7 },
        { id: 'top_kpp', type: 'grid', count: 9, startX: 351, startY: 68.5, spacing: 26.7 },
        { id: 'page_no', type: 'grid', count: 3, startX: 621, startY: 68.5, spacing: 26.7 },
        { id: 'cert_no', type: 'grid', count: 15, startX: 163.5, startY: 248.5, spacing: 26.7, val: '' },
        { id: 'correction', type: 'grid', count: 3, startX: 701, startY: 248.5, spacing: 26.7 },
        { id: 'year', type: 'grid', count: 4, startX: 991, startY: 248.5, spacing: 26.7, val: patientData.exam_year },
        { id: 'org_l1', type: 'grid', count: 40, startX: 35, startY: 348.5, spacing: 26.7 },
        { id: 'org_l2', type: 'grid', count: 40, startX: 35, startY: 385.5, spacing: 26.7 },
        { id: 'org_l3', type: 'grid', count: 40, startX: 35, startY: 422.5, spacing: 26.7 },
        { id: 'org_l4', type: 'grid', count: 40, startX: 35, startY: 459.5, spacing: 26.7 },
        { id: 'surname', type: 'grid', count: 40, startX: 139, startY: 575.5, spacing: 26.7 },
        { id: 'name', type: 'grid', count: 40, startX: 139, startY: 621.0, spacing: 26.7 },
        { id: 'patronymic', type: 'grid', count: 40, startX: 139, startY: 666.5, spacing: 26.7 },
        { id: 'p_inn', type: 'grid', count: 12, startX: 139, startY: 712.0, spacing: 26.7 },
        { id: 'b_day', type: 'grid', count: 2, startX: 700, startY: 712.0, spacing: 26.7 },
        { id: 'b_month', type: 'grid', count: 2, startX: 781, startY: 712.0, spacing: 26.7 },
        { id: 'b_year', type: 'grid', count: 4, startX: 862, startY: 712.0, spacing: 26.7 },
        { id: 'doc_code', type: 'grid', count: 2, startX: 219, startY: 800.5, spacing: 26.7, val: '21' },
        { id: 'doc_info', type: 'grid', count: 25, startX: 567.7, startY: 800.5, spacing: 26.7 },
        { id: 'i_day', type: 'grid', count: 2, startX: 219, startY: 846.0, spacing: 26.7 },
        { id: 'i_month', type: 'grid', count: 2, startX: 300, startY: 846.0, spacing: 26.7 },
        { id: 'i_year', type: 'grid', count: 4, startX: 381, startY: 846.0, spacing: 26.7 },
        { id: 'amount', type: 'grid', count: 13, startX: 621.1, startY: 955.5, spacing: 26.7, val: patientData.amount },
        { id: 'amount_kop', type: 'grid', count: 2, startX: 994.9, startY: 955.5, spacing: 26.7, val: patientData.amount_kop },
        { id: 'c_day', type: 'grid', count: 2, startX: 307, startY: 1282.5, spacing: 26.7, val: patientData.c_day },
        { id: 'c_month', type: 'grid', count: 2, startX: 388, startY: 1282.5, spacing: 26.7, val: patientData.c_month },
        { id: 'c_year', type: 'grid', count: 4, startX: 469, startY: 1282.5, spacing: 26.7, val: patientData.c_year },
        { id: 'rep_surname', type: 'grid', count: 40, startX: 139, startY: 1150.5, spacing: 26.7, val: '' },
        { id: 'rep_name', type: 'grid', count: 40, startX: 139, startY: 1196.0, spacing: 26.7, val: '' },
        { id: 'rep_patronymic', type: 'grid', count: 40, startX: 139, startY: 1241.5, spacing: 26.7, val: '' },
        { id: 'stamp', type: 'image', url: patientData.stamp_url, startX: 34, startY: 1210, width: 264 },
    ];

    let activeFields = [];

    function initEditor() {
        const overlay1 = document.getElementById('overlay-layer-1');
        const overlay2 = document.getElementById('overlay-layer-2');
        const page2 = document.getElementById('page-2');

        console.log('InitEditor:', { formType, payerData, patientData });

        if (formType === 'knd1151156_op' && !payerData.surname && !payerData.inn) {
            // alert('Warning: OP Form selected but no Payer Data received!');
        }

        // Save current values to restore them after re-init (if any)
        const currentVals = {};
        document.querySelectorAll('.char-box').forEach(inp => {
            const field = inp.dataset.field;
            const index = inp.dataset.index;
            if (!currentVals[field]) currentVals[field] = {};
            currentVals[field][index] = inp.value;
        });

        overlay1.innerHTML = '';
        overlay2.innerHTML = '';

        // Determine data source for Page 1
        let p1Data = patientData;
        if (formType === 'knd1151156_op') {
            p1Data = payerData;
            page2.style.display = 'block'; // Show page 2
        } else {
            page2.style.display = 'none';
        }

        // Map values to fields for Page 1
        // We clone baseFields and assign values
        const page1Fields = baseFields.map(f => {
            let newVal = f.val; // Default existing val
            // Map main fields to p1Data
            if (['surname', 'name', 'patronymic'].includes(f.id)) newVal = p1Data[f.id];
            if (f.id === 'p_inn') newVal = p1Data.inn;
            if (f.id === 'b_day') newVal = p1Data.b_day;
            if (f.id === 'b_month') newVal = p1Data.b_month;
            if (f.id === 'b_year') newVal = p1Data.b_year;
            if (f.id === 'doc_info') newVal = p1Data.doc_info;
            if (f.id === 'i_day') newVal = p1Data.i_day;
            if (f.id === 'i_month') newVal = p1Data.i_month;
            if (f.id === 'i_year') newVal = p1Data.i_year;

            return { ...f, val: newVal, page: 1 };
        });

        activeFields = [...page1Fields];

        // If OP, add Page 2 fields (Patient)
        if (formType === 'knd1151156_op') {
            // Logic for Page 2: what fields go there? 
            // User said: "Patient data on second (additional)".
            // Assuming same layout, we just reuse the fields but map to patientData
            // But usually Page 2 of KND 1151156 is mostly empty or specific. 
            // For now, I will REPEAT the same "Patient" block fields on Page 2

            // Subset of fields relevant for Patient
            const p2Ids = ['surname', 'name', 'patronymic', 'p_inn', 'b_day', 'b_month', 'b_year', 'doc_code', 'doc_info', 'i_day', 'i_month', 'i_year'];

            const page2Fields = baseFields.filter(f => p2Ids.includes(f.id)).map(f => {
                let newVal = f.val;
                if (['surname', 'name', 'patronymic'].includes(f.id)) newVal = patientData[f.id];
                if (f.id === 'p_inn') newVal = patientData.inn;
                if (f.id === 'b_day') newVal = patientData.b_day;
                if (f.id === 'b_month') newVal = patientData.b_month;
                if (f.id === 'b_year') newVal = patientData.b_year;
                if (f.id === 'doc_info') newVal = patientData.doc_info;
                if (f.id === 'i_day') newVal = patientData.i_day;
                if (f.id === 'i_month') newVal = patientData.i_month;
                if (f.id === 'i_year') newVal = patientData.i_year;

                // Adjust ID to be unique and lift by 358px (was 360, moved down 2)
                return { ...f, id: f.id + '_p2', val: newVal, page: 2, startY: f.startY - 358 };
            });

            // Add specific bottom date fields and stamp for OP form
            const p2ExtraFields = [
                { id: 'c_day_bottom', val: patientData.c_day, startX: 639, type: 'grid', count: 2, spacing: 19.7, startY: 1534.5 },
                { id: 'c_dot1', val: '.', startX: 674.4, type: 'grid', count: 1, spacing: 19.7, startY: 1534.5 },
                { id: 'c_month_bottom', val: patientData.c_month, startX: 692.1, type: 'grid', count: 2, spacing: 19.7, startY: 1534.5 },
                { id: 'c_dot2', val: '.', startX: 727.5, type: 'grid', count: 1, spacing: 19.7, startY: 1534.5 },
                { id: 'c_year_bottom', val: patientData.c_year, startX: 745.2, type: 'grid', count: 4, spacing: 19.7, startY: 1534.5 },
                // Stamp centered on Page 2
                { id: 'stamp_p2', url: patientData.stamp_url, startX: 323, startY: 1340, width: 264, type: 'image', page: 2 }
            ].map(f => ({ ...f, page: 2 }));

            activeFields = [...activeFields, ...page2Fields, ...p2ExtraFields];
        }

        const globalX = parseInt(localStorage.getItem('cert_x') || '0');
        const globalY = parseInt(localStorage.getItem('cert_y') || '0');

        activeFields.forEach(f => {
            const container = f.page === 2 ? overlay2 : overlay1;

            if (f.type === 'grid') {
                for (let i = 0; i < f.count; i++) {
                    const input = document.createElement('input');
                    input.className = 'char-box';
                    input.style.left = (f.startX + (i * f.spacing) + globalX) + 'px';
                    input.style.top = (f.startY + globalY - 2) + 'px';
                    input.maxLength = 1;
                    input.dataset.field = f.id;
                    input.dataset.index = i;

                    if (currentVals[f.id] && currentVals[f.id][i] !== undefined) {
                        input.value = currentVals[f.id][i];
                    } else if (f.val && f.val[i]) {
                        input.value = f.val[i];
                    }

                    input.oninput = (e) => {
                        if (e.target.value && e.target.nextElementSibling && e.target.nextElementSibling.dataset.field === f.id) {
                            e.target.nextElementSibling.focus();
                        }
                    };
                    input.onkeydown = (e) => {
                        if (e.key === 'Backspace' && !e.target.value && e.target.previousElementSibling && e.target.previousElementSibling.dataset.field === f.id) {
                            e.target.previousElementSibling.focus();
                        }
                    };


                    container.appendChild(input);
                }
            } else if (f.type === 'image') {
                if (f.page === 2 && formType !== 'knd1151156_op') return;

                const img = document.createElement('img');
                img.src = f.url;
                img.style.position = 'absolute';
                img.style.left = (f.startX + globalX) + 'px';
                img.style.top = (f.startY + globalY) + 'px';
                img.style.width = f.width + 'px';
                img.style.pointerEvents = 'none';
                img.style.opacity = '0.7';

                // Handle Page 1 and Page 2 images
                if (!f.page || f.page === 1) overlay1.appendChild(img);
                else if (f.page === 2) overlay2.appendChild(img);
            }
        });
    }


    async function saveAndGenerate() {
        const btn = document.getElementById('generate-btn');
        const btnText = document.getElementById('btn-text');

        // Disable button and show loading state
        btn.disabled = true;
        btn.style.cursor = 'not-allowed';
        btn.style.opacity = '0.7';
        btnText.innerHTML = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø—Ä–∞–≤–∫–∏...';

        // Collect all data
        const inputs = document.querySelectorAll('.char-box');
        const formData = {};
        inputs.forEach(inp => {
            const field = inp.dataset.field;
            // Clean field ID if it has '_p2' suffix for correct mapping later or keep as is?
            // Actually backend likely expects 'surname' etc.
            // But if we have 2 pages of surnames (Payer and Patient), we need to distinguish them?
            // Or backend logic should just receive the raw fields and map them to pages?
            // The current backend generation just takes 'form_data' and stamps it.
            // If we have 'surname' and 'surname_p2', we need to handle that in backend generation.

            if (!formData[field]) formData[field] = '';
            formData[field] += inp.value || ' ';
        });

        try {
            const response = await fetch('/stamp-tool/certificate/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    appointment_id: appointmentId,
                    form_data: formData,
                    form_type: formType, // Send type
                    calibration: {
                        x: parseInt(localStorage.getItem('cert_x') || '0'),
                        y: parseInt(localStorage.getItem('cert_y') || '0')
                    }
                })
            });
            const result = await response.json();
            if (result.success) {
                btnText.innerHTML = '‚úÖ –£—Å–ø–µ—à–Ω–æ!';
                setTimeout(() => {
                    window.location.href = '/stamp-tool';
                }, 500);
            } else {
                alert('–û—à–∏–±–∫–∞: ' + result.error);
                // Re-enable button on error
                btn.disabled = false;
                btn.style.cursor = 'pointer';
                btn.style.opacity = '1';
                btnText.innerHTML = 'üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å';
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
            // Re-enable button on error
            btn.disabled = false;
            btn.style.cursor = 'pointer';
            btn.style.opacity = '1';
            btnText.innerHTML = 'üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å';
        }
    }

    window.onload = initEditor;
</script>
{% endblock %}